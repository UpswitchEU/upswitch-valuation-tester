import React, { memo } from 'react';
import { useValuationStore } from '../../store/useValuationStore';

/**
 * Results Component - Displays Accountant View HTML Report (Preview Tab)
 * 
 * This component displays ONLY the Accountant View HTML report (result.html_report)
 * generated by the Python backend. This is the progressive report shown after the
 * calculate CTA button is clicked, formatted in word-style (Times New Roman, print-friendly).
 * 
 * All detailed React components (ResultsHeader, waterfalls, breakdowns, etc.) have been
 * moved to the Info tab (ValuationInfoPanel) to keep the Preview tab clean and focused
 * on the professional report view.
 * 
 * This component does NOT render any React components - it only displays the HTML report.
 * 
 * PERFORMANCE: Memoized to prevent unnecessary re-renders
 */
export const Results: React.FC = memo(() => {
  const { result } = useValuationStore();

  // Note: Result state logging removed - HTML report rendering is handled by dangerouslySetInnerHTML

  // Remove "Complete Valuation Report" header if present
  React.useEffect(() => {
    if (!result?.html_report) return;

    // Use requestAnimationFrame to ensure DOM is updated
    requestAnimationFrame(() => {
      const reportElement = document.querySelector('.accountant-view-report');
      if (!reportElement) return;

      // Find and remove the header div with CheckCircle icon
      // Look for divs containing both a circle-check SVG and "Complete Valuation Report" text
      const allDivs = reportElement.querySelectorAll('div');
      allDivs.forEach((div) => {
        const hasCheckIcon = div.querySelector('svg[class*="circle-check"], svg.lucide-circle-check-big');
        const hasCompleteReportText = div.textContent?.includes('Complete Valuation Report');
        
        if (hasCheckIcon && hasCompleteReportText) {
          div.remove();
        }
      });
    });
  }, [result?.html_report]);

  if (!result) {
    return null;
  }

  // If html_report is not available, show loading/error
  if (!result.html_report) {
    return (
      <div className="flex items-center justify-center h-full min-h-[400px]">
        <div className="text-center text-gray-500">
          <svg className="w-16 h-16 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
          <p className="font-medium">Report not available</p>
          <p className="text-sm text-gray-400 mt-1">HTML report was not generated by backend</p>
        </div>
      </div>
    );
  }

  return (
    <div className="h-full overflow-y-auto valuation-report-preview">
      <div
        className="accountant-view-report"
        dangerouslySetInnerHTML={{ __html: result.html_report }}
      />
    </div>
  );
});

// Frontend is minimal - only displays final HTML report from backend
// All complex analysis components removed - calculations happen in Python

