import React, { memo, useEffect } from 'react'
import { useSessionStore } from '../../store/useSessionStore'
import type { ValuationResponse } from '../../types/valuation'
import { HTMLProcessor } from '../../utils/htmlProcessor'
import { generalLogger } from '../../utils/logger'
import { ReportSkeleton } from '../skeletons/ReportSkeleton'

interface ResultsComponentProps {
  result?: ValuationResponse | null
}

/**
 * Results Component - Displays Accountant View HTML Report (Preview Tab)
 *
 * This component displays ONLY the Accountant View HTML report (result.html_report)
 * generated by the Python backend. This is the progressive report shown after the
 * calculate CTA button is clicked, formatted in word-style (Times New Roman, print-friendly).
 *
 * All detailed React components (ResultsHeader, waterfalls, breakdowns, etc.) have been
 * moved to the Info tab (ValuationInfoPanel) to keep the Preview tab clean and focused
 * on the professional report view.
 *
 * This component does NOT render any React components - it only displays the HTML report.
 *
 * PERFORMANCE: Memoized to prevent unnecessary re-renders
 *
 * NOTE: This component is now prop-driven (no direct store access) for flow isolation
 */
const ResultsComponent: React.FC<ResultsComponentProps> = ({ result }) => {
  // Read from unified session store
  const session = useSessionStore((state) => state.session)
  const isLoading = useSessionStore((state) => state.isLoading)
  const error = useSessionStore((state) => state.error)
  
  // Get HTML report from session
  const htmlReport = session?.htmlReport || result?.html_report

  // Verification logging: Track when result changes
  useEffect(() => {
    if (result) {
      generalLogger.info('Results component received result', {
        hasResult: true,
        valuationId: result.valuation_id,
        hasHtmlReport: !!htmlReport,
        htmlReportLength: htmlReport?.length || 0,
      })
    } else {
      generalLogger.warn('Results component has no result', {
        hasResult: false,
      })
    }
  }, [result, htmlReport])

  // Show loading skeleton while loading
  if (isLoading && !htmlReport) {
    return (
      <div className="flex flex-col items-center justify-center h-full min-h-[400px] space-y-4">
        <div className="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin" />
        <p className="text-gray-600 font-medium">Loading report...</p>
        <ReportSkeleton />
      </div>
    )
  }

  // Show error state
  if (error) {
    return (
      <div className="flex items-center justify-center h-full min-h-[400px]">
        <div className="text-center text-red-600 max-w-md">
          <svg
            className="w-16 h-16 mx-auto mb-4"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
            />
          </svg>
          <p className="font-medium text-lg">Failed to load report</p>
          <p className="text-sm text-gray-600 mt-2">{error}</p>
        </div>
      </div>
    )
  }

  // Remove "Complete Valuation Report" header if present
  React.useEffect(() => {
    if (!result?.html_report) return

    // Use requestAnimationFrame to ensure DOM is updated
    requestAnimationFrame(() => {
      const reportElement = document.querySelector('.accountant-view-report')
      if (!reportElement) return

      // Find and remove the header div with CheckCircle icon
      // Look for divs containing both a circle-check SVG and "Complete Valuation Report" text
      const allDivs = reportElement.querySelectorAll('div')
      allDivs.forEach((div) => {
        const hasCheckIcon = div.querySelector(
          'svg[class*="circle-check"], svg.lucide-circle-check-big'
        )
        const hasCompleteReportText = div.textContent?.includes('Complete Valuation Report')

        if (hasCheckIcon && hasCompleteReportText) {
          div.remove()
        }
      })
    })
  }, [result?.html_report])

  if (!result) {
    return null
  }

  // If html_report is not available, show placeholder
  if (!htmlReport) {
    return (
      <div className="flex items-center justify-center h-full min-h-[400px]">
        <div className="text-center text-gray-500">
          <svg
            className="w-16 h-16 mx-auto mb-4 text-gray-400"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
            />
          </svg>
          <p className="font-medium">Report not available</p>
          <p className="text-sm text-gray-400 mt-1">HTML report was not generated by backend</p>
        </div>
      </div>
    )
  }

  // BANK-GRADE: Sanitize HTML before rendering to prevent XSS attacks
  // HTML is server-generated from templates (not user input), but we sanitize for defense-in-depth
  const sanitizedHtml = HTMLProcessor.sanitize(htmlReport)

  return (
    <div className="h-full overflow-y-auto valuation-report-preview">
      <div
        className="accountant-view-report"
        dangerouslySetInnerHTML={{ __html: sanitizedHtml }}
      />
    </div>
  )
}

// BANK-GRADE: Memoized component to prevent unnecessary re-renders
// Zustand's selector optimization handles store-based re-renders efficiently
// This memo prevents re-renders from parent component updates
export const Results = memo(ResultsComponent)

Results.displayName = 'Results'

// Frontend is minimal - only displays final HTML report from backend
// All complex analysis components removed - calculations happen in Python
