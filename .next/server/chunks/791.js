"use strict";exports.id=791,exports.ids=[791,55],exports.modules={34791:(e,t,a)=>{a.r(t),a.d(t,{ValuationFlow:()=>p});var r=a(10326),n=a(17577),o=a(97810),s=a(45055),l=a(18243),i=a(33741);let d=(0,n.lazy)(()=>a.e(979).then(a.bind(a,64979)).then(e=>({default:e.Results}))),u=(0,n.lazy)(()=>a.e(105).then(a.bind(a,29105)).then(e=>({default:e.StreamingChat}))),_=(0,n.lazy)(()=>a.e(486).then(a.bind(a,78486)).then(e=>({default:e.ValuationToolbar}))),m=(0,n.lazy)(()=>a.e(118).then(a.bind(a,14118)).then(e=>({default:e.DataCollection}))),c=({message:e="Loading..."})=>r.jsx("div",{className:"flex items-center justify-center p-8",children:(0,r.jsxs)("div",{className:"flex items-center gap-3",children:[r.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-primary-600"}),r.jsx("span",{className:"text-zinc-600",children:e})]})}),p=({reportId:e,flowType:t,onComplete:a,initialQuery:n=null,autoSend:o=!1})=>"conversational"===t?r.jsx(y,{reportId:e,onComplete:a,initialQuery:n,autoSend:o}):r.jsx(h,{reportId:e,onComplete:a}),h=({reportId:e,onComplete:t})=>{let{result:u,isCalculating:p,calculateValuation:h,setCollectedData:y}=(0,s.useValuationStore)(),{user:f}=(0,o.a)(),b=(0,n.useCallback)(e=>{y(e)},[y]),v=(0,n.useCallback)(async t=>{l.P.getState().setCollectedData(t);try{await h()}catch(t){i.a.error("Valuation calculation failed",{error:t,reportId:e})}},[h,e]),g=(0,n.useCallback)(e=>{i.a.debug("Manual flow progress update",{progress:e.overallProgress,completedFields:e.completedFields,totalFields:e.totalFields})},[]);return(0,r.jsxs)("div",{className:"h-full flex flex-col",children:[r.jsx("div",{className:"flex-1 overflow-y-auto p-4",children:r.jsx(n.Suspense,{fallback:r.jsx(c,{message:"Loading data collection..."}),children:r.jsx(m,{method:"manual_form",onDataCollected:b,onProgressUpdate:g,onComplete:v})})}),r.jsx(n.Suspense,{fallback:r.jsx(c,{message:"Loading toolbar..."}),children:r.jsx(_,{onRefresh:()=>window.location.reload(),onDownload:async()=>{if(u)try{let{DownloadService:e}=await a.e(887).then(a.bind(a,12887));await e.downloadPDF(u,{format:"pdf",filename:`valuation-${Date.now()}.pdf`})}catch(t){i.a.error("PDF download failed",{error:t,reportId:e})}},onFullScreen:()=>{},isGenerating:p,user:f,valuationName:"Manual Valuation",valuationId:u?.valuation_id,activeTab:"preview",onTabChange:()=>{}})}),u&&r.jsx("div",{className:"border-t border-gray-200",children:r.jsx(n.Suspense,{fallback:r.jsx(c,{message:"Loading results..."}),children:r.jsx(d,{})})})]})};h.displayName="ManualFlow",p.displayName="ValuationFlow";let y=({reportId:e,onComplete:t,initialQuery:a=null,autoSend:s=!1})=>{let{user:l}=(0,o.a)(),d=(0,n.useCallback)(e=>{t(e)},[t]);return(0,r.jsxs)("div",{className:"h-full flex flex-col",children:[r.jsx(n.Suspense,{fallback:r.jsx(c,{message:"Loading toolbar..."}),children:r.jsx(_,{onRefresh:()=>window.location.reload(),onDownload:async()=>{console.log("PDF download not yet implemented for conversational flow")},onFullScreen:()=>{},isGenerating:!1,user:l,valuationName:"Conversational Valuation",valuationId:void 0,activeTab:"preview",onTabChange:()=>{}})}),r.jsx("div",{className:"flex-1 overflow-hidden",children:r.jsx(n.Suspense,{fallback:r.jsx(c,{message:"Loading chat..."}),children:r.jsx(u,{sessionId:e,userId:l?.id,onValuationComplete:d,onValuationStart:()=>{i.a.info("Conversational valuation started",{reportId:e})},initialMessage:a,autoSend:s})})})]})};y.displayName="ConversationalFlow"},45055:(e,t,a)=>{a.d(t,{useValuationStore:()=>l});var r=a(60114),n=a(33741);let o=()=>Math.min(new Date().getFullYear(),2100),s={company_name:"",country_code:"BE",industry:"services",business_model:"services",founding_year:o()-5,business_type:"company",shares_for_sale:100,number_of_owners:1,revenue:void 0,ebitda:void 0,current_year_data:{year:o(),revenue:0,ebitda:0}},l=(0,r.Ue)((e,t)=>({collectedData:[],setCollectedData:t=>e({collectedData:t}),formData:s,updateFormData:t=>e(e=>({formData:{...e.formData,...t}})),resetFormData:()=>e({formData:s}),prefillFromBusinessCard:t=>e(e=>({formData:{...e.formData,company_name:t.company_name,industry:t.industry,business_model:t.business_model,founding_year:t.founding_year,country_code:t.country_code,number_of_employees:t.employee_count}})),result:null,setResult:a=>{let r=t().result,o=r?.html_report&&r.html_report.length>0,s=a?.html_report&&a.html_report.length>0;a&&o&&!s?(n.sK.info("DIAGNOSTIC: Preserving html_report in setResult",{preservedFrom:"existing_result",htmlReportLength:r?.html_report?.length||0,valuationId:a.valuation_id,newResultHadHtmlReport:!!a.html_report,newResultHtmlReportLength:a.html_report?.length||0}),e({result:{...a,html_report:r?.html_report}})):e({result:a})},clearResult:()=>e({result:null}),inputData:null,setInputData:t=>e({inputData:t}),isCalculating:!1,setIsCalculating:t=>e({isCalculating:t}),isCalculatingLive:!1,setIsCalculatingLive:t=>e({isCalculatingLive:t}),error:null,setError:t=>e({error:t}),liveEstimate:null,setLiveEstimate:t=>e({liveEstimate:t}),savedValuationId:null,setSavedValuationId:t=>e({savedValuationId:t}),correlationId:null,setCorrelationId:t=>{e({correlationId:t}),correlationContext.setCorrelationId(t),t&&n.sK.info("Correlation ID set",{correlationId:t})},calculateValuation:async()=>{let{formData:e,setIsCalculating:a,setResult:r,setError:o,setInputData:s}=t(),l=useValuationSessionStore.getState(),i=l.getSessionData(),d=l.session;o(null),a(!0);try{let a=d?.dataSource||"manual",o={...e,...i||{},company_name:e.company_name||i?.company_name,revenue:e.revenue||i?.revenue,current_year_data:e.current_year_data||i?.current_year_data};if(!o.company_name||""===o.company_name.trim())throw Error("Company name is required");if(!o.industry)throw Error("Industry is required");let l=o.revenue||o.current_year_data?.revenue;if(!l||l<=0)throw Error("Revenue must be greater than 0");let u=void 0!==o.ebitda&&null!==o.ebitda?o.ebitda:o.current_year_data?.ebitda;if(null==u)throw Error("EBITDA is required");let _=Math.min(Math.max(o.current_year_data?.year||new Date().getFullYear(),2e3),2100),m=Math.min(Math.max(o.founding_year||_-5,1900),2100),c=Math.min(Math.max(o.recurring_revenue_percentage||0,0),1),p=o.company_name?.trim()||"Unknown Company",h=(o.country_code||"BE").toUpperCase().substring(0,2),y=o.industry||"services",f=o.business_model||"services",b=Math.max(Number(l)||1e5,1),v=null!=u?Number(u):2e4,g={revenue:b,ebitda:v,industry:y,country_code:h,founding_year:m,employees:o.number_of_employees,business_model:f,historical_years_data:o.historical_years_data,total_debt:o.current_year_data?.total_debt,cash:o.current_year_data?.cash};s(g),n.sK.debug("Data source before building request",{dataSource:a,usingSessionData:!!i,business_type_id:o.business_type_id,_internal_dcf_preference:o._internal_dcf_preference,_internal_multiples_preference:o._internal_multiples_preference,_internal_owner_dependency_impact:o._internal_owner_dependency_impact,number_of_employees:o.number_of_employees,number_of_owners:o.number_of_owners,business_type:o.business_type});let w={company_name:p,country_code:h,industry:y,business_model:f,founding_year:m,current_year_data:{year:_,revenue:b,ebitda:v,...o.current_year_data?.total_assets&&o.current_year_data.total_assets>=0&&{total_assets:Number(o.current_year_data.total_assets)},...o.current_year_data?.total_debt&&o.current_year_data.total_debt>=0&&{total_debt:Number(o.current_year_data.total_debt)},...o.current_year_data?.cash&&o.current_year_data.cash>=0&&{cash:Number(o.current_year_data.cash)}},historical_years_data:o.historical_years_data&&o.historical_years_data.length>0?o.historical_years_data.filter(e=>void 0!==e.ebitda&&null!==e.ebitda).map(e=>({...e,year:Math.min(Math.max(Number(e.year),2e3),2100),revenue:Math.max(Number(e.revenue)||0,1),ebitda:Number(e.ebitda)})):b>0&&0!==v?[{year:Math.min(_-1,2100),revenue:Math.max(.9*b,1),ebitda:.9*v}]:[],number_of_employees:"sole-trader"===o.business_type?void 0:void 0!==o.number_of_employees&&null!==o.number_of_employees&&o.number_of_employees>=0?o.number_of_employees:void 0,number_of_owners:"sole-trader"===o.business_type?void 0:void 0!==o.number_of_owners&&null!==o.number_of_owners&&o.number_of_owners>=1?o.number_of_owners:1,recurring_revenue_percentage:c,use_dcf:!0,use_multiples:!0,projection_years:10,comparables:o.comparables||[],business_type_id:o.business_type_id,business_type:o.business_type,shares_for_sale:void 0!==o.shares_for_sale&&null!==o.shares_for_sale?Math.max(0,Math.min(100,Number(o.shares_for_sale))):100,business_context:o.business_type_id?{dcfPreference:validatePreference(o._internal_dcf_preference),multiplesPreference:validatePreference(o._internal_multiples_preference),ownerDependencyImpact:validatePreference(o._internal_owner_dependency_impact),keyMetrics:o._internal_key_metrics,typicalEmployeeRange:o._internal_typical_employee_range,typicalRevenueRange:o._internal_typical_revenue_range}:void 0};n.sK.debug("Business context in request",{business_context:w.business_context}),n.sK.info("Sending unified valuation request",{dataSource:a,companyName:w.company_name,revenue:w.current_year_data.revenue,ebitda:w.current_year_data.ebitda,business_type_id:w.business_type_id,business_context:w.business_context,requestData:w});let I=await backendAPI.calculateValuationUnified(w,a);if(I?.valuation_id){let{setCorrelationId:e}=t();e(I.valuation_id),correlationContext.setValuationId(I.valuation_id),n.sK.info("Valuation response received",{valuationId:I.valuation_id,hasTransparency:!!I.transparency,hasModularSystem:!!I.modular_system,modularSystemStepsCount:I.modular_system?.step_details?.length||0,hasHtmlReport:!!I?.html_report,htmlReportLength:I?.html_report?.length||0,hasInfoTabHtml:!!I?.info_tab_html,infoTabHtmlLength:I?.info_tab_html?.length||0})}n.sK.debug("Backend response received",{responseType:typeof I,responseKeys:Object.keys(I||{}),equityValues:{low:I?.equity_value_low,mid:I?.equity_value_mid,high:I?.equity_value_high},recommendedAskingPrice:I?.recommended_asking_price,confidenceScore:I?.confidence_score,htmlReport:{present:!!I?.html_report,length:I?.html_report?.length||0,preview:I?.html_report?.substring(0,200)||"N/A",type:typeof I?.html_report},infoTabHtml:{present:!!I?.info_tab_html,length:I?.info_tab_html?.length||0,preview:I?.info_tab_html?.substring(0,200)||"N/A",type:typeof I?.info_tab_html},fullData:I}),n.sK.debug("Report data sections",{keyValueDrivers:I?.key_value_drivers,riskFactors:I?.risk_factors,financialMetrics:I?.financial_metrics,historicalData:I?.historical_years_data,transparency:I?.transparency,methodologyNotes:I?.methodology_notes}),n.sK.info("DIAGNOSTIC: About to store result in Zustand store",{hasHtmlReport:!!I?.html_report,htmlReportLength:I?.html_report?.length||0,hasInfoTabHtml:!!I?.info_tab_html,infoTabHtmlLength:I?.info_tab_html?.length||0,valuationId:I?.valuation_id});let x=t().result,N=I?.html_report&&I.html_report.length>0,D=x?.html_report&&x.html_report.length>0,S=I?.info_tab_html&&I.info_tab_html.length>0,C=x?.info_tab_html&&x.info_tab_html.length>0,k=N?I.html_report:D?x.html_report:I?.html_report,j=S?I.info_tab_html:C?x.info_tab_html:I?.info_tab_html;D&&!N&&n.sK.info("DIAGNOSTIC: Preserving html_report from streaming/previous result",{preservedFrom:"previous_result",htmlReportLength:k?.length||0,valuationId:I?.valuation_id,responseHadHtmlReport:!!I?.html_report,responseHtmlReportLength:I?.html_report?.length||0}),C&&!S&&n.sK.info("DIAGNOSTIC: Preserving info_tab_html from streaming/previous result",{preservedFrom:"previous_result",infoTabHtmlLength:j?.length||0,valuationId:I?.valuation_id,responseHadInfoTabHtml:!!I?.info_tab_html,responseInfoTabHtmlLength:I?.info_tab_html?.length||0});let V={...I,html_report:k,info_tab_html:j},T=[];["equity_value_low","equity_value_mid","equity_value_high","equity_value","enterprise_value","confidence_score"].forEach(e=>{let t=V[e];"number"==typeof t&&(isNaN(t)||!isFinite(t))&&T.push(e)}),T.length>0&&n.sK.warn("⚠️ Valuation result contains NaN/Infinity in critical fields",{valuationId:I?.valuation_id,nanFields:T,note:"Components will handle NaN at display time with fallback values"}),r(V);let R=t().result;if(n.sK.info("Result stored in Zustand store",{stored:!!R,storedHasHtmlReport:!!R?.html_report,storedHtmlReportLength:R?.html_report?.length||0,storedHasInfoTabHtml:!!R?.info_tab_html,storedInfoTabHtmlLength:R?.info_tab_html?.length||0}),I.financial_metrics&&g&&s({...g,metrics:I.financial_metrics}),d)try{await backendAPI.updateValuationSession(d.reportId,{completedAt:new Date().toISOString()}),n.sK.info("Session marked as completed",{reportId:d.reportId})}catch(e){n.sK.warn("Failed to mark session as completed",{error:e})}try{let e=await t().saveToBackend();e&&n.sK.info("Valuation auto-saved to database",{valuationId:e.id})}catch(e){n.sK.warn("Failed to auto-save to database",{error:e})}}catch(t){n.sK.error("Valuation error",{error:t instanceof Error?t.message:"Unknown error",response:t&&"object"==typeof t&&"response"in t?t.response?.data:void 0});let e="Failed to calculate valuation";if(t.response?.data?.error){let a=t.response.data.error;"string"==typeof a?e=a:a?.message?e=a.message:a?.error&&(e=a.error)}else if(t.response?.data?.detail){let a=t.response.data.detail;"string"==typeof a?e=a:Array.isArray(a)?e=a.map(e=>{let t=e.loc?.join(".")||"unknown field";return`${t}: ${e.msg||"Validation error"}`}).join("; "):"object"==typeof a&&null!==a&&(Array.isArray(a.errors)&&a.errors.length>0?e=a.errors.map(e=>e.field&&e.message?`${e.field}: ${e.message}`:e.message||e.field||"Validation error").join("; "):a.error?e="string"==typeof a.error?a.error:a.hint||"Validation failed":a.hint?e=a.hint:a.message&&(e=a.message))}else t.message&&(e=t.message);(e.includes("timeout")||e.includes("504")||t.response?.status===504)&&(e="The valuation calculation is taking longer than expected. This may be due to high server load. Please try again in a moment."),o(e),a(!1)}},calculateValuationStreaming:async e=>(e&&e(0),Promise.resolve()),quickValuation:async()=>{let{formData:e,setIsCalculatingLive:a,setLiveEstimate:r}=t();if(e.revenue&&e.ebitda&&e.industry&&e.country_code){a(!0);try{let t={revenue:e.revenue,ebitda:e.ebitda,industry:e.industry,country_code:e.country_code},a=await api.quickValuation(t);r(a)}catch(e){n.sK.error("Quick valuation failed",{error:e instanceof Error?e.message:"Unknown error"})}finally{a(!1)}}},saveToBackend:async e=>{let{result:a,formData:r,setSavedValuationId:o,setError:s}=t();if(!a)return n.sK.warn("No valuation result to save"),null;try{n.sK.info("Saving valuation to backend");let t=(void 0).VITE_BACKEND_URL||(void 0).VITE_API_BASE_URL||"https://web-production-8d00b.up.railway.app",s=await fetch(`${t}/api/valuations/save`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({businessId:e,valuation:{...a,company_name:r.company_name,country_code:r.country_code,industry:r.industry}})});if(!s.ok){let e=await s.json();throw Error(e.error||"Failed to save valuation")}let l=await s.json();if(l.success&&l.data?.id){if(o(l.data.id),n.sK.info("Valuation saved successfully",{valuationId:l.data.id}),window.opener||window.parent!==window){let e=(void 0).VITE_PARENT_DOMAIN||"https://upswitch.biz",t={type:"VALUATION_SAVED",valuationId:l.data.id,companyName:r.company_name,timestamp:new Date().toISOString()};window.opener&&!window.opener.closed&&(window.opener.postMessage(t,e),n.sK.debug("PostMessage sent to opener window")),window.parent!==window&&(window.parent.postMessage(t,e),n.sK.debug("PostMessage sent to parent window"))}return{id:l.data.id}}throw Error("Invalid response from server")}catch(e){return n.sK.error("Failed to save valuation",{error:e instanceof Error?e.message:"Unknown error"}),s(e.message||"Failed to save valuation to backend"),null}}}))}};