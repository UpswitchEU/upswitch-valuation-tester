"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[404],{96629:function(e,t,s){s.r(t),s.d(t,{StreamingChat:function(){return es},default:function(){return er}});var r=s(57437),a=s(2265),n=s(73589),i=s(69419);class o{reset(){this.hasStartedMessage=!1,this.messageCreationLock=!1,this.chunkBuffer=[],this.lastProcessedChunks=[],this.lastCompleteMessageSignature=null}handleTyping(e){var t,s,r,a;i.pL.debug("AI typing indicator received"),null===(t=(s=this.callbacks).setIsTyping)||void 0===t||t.call(s,!0),null===(r=(a=this.callbacks).setIsThinking)||void 0===r||r.call(a,!0),this.ensureMessageExists().catch(e=>{i.pL.error("Failed to ensure message exists",{error:e})})}handleMessageStart(e){var t,s,r,a,n,o;console.log("\uD83C\uDFAF MESSAGE_START received:",{type:e.type,field:e.field,content:e.content,session_id:e.session_id,_is_confirmation:e._is_confirmation}),this.hasStartedMessage&&(i.pL.debug("message_start received while previous message active - completing previous message",{bufferedChunks:this.chunkBuffer.length}),this.callbacks.updateStreamingMessage("",!0),this.callbacks.setIsStreaming(!1)),this.hasStartedMessage=!1,this.messageCreationLock=!1,this.chunkBuffer=[],this.lastProcessedChunks=[],this.lastCompleteMessageSignature=null,null===(t=(s=this.callbacks).setIsThinking)||void 0===t||t.call(s,!1),null===(r=(a=this.callbacks).setIsTyping)||void 0===r||r.call(a,!1),null===(n=(o=this.callbacks).setTypingContext)||void 0===n||n.call(o,void 0),this.callbacks.setIsStreaming(!0)}async handleMessageChunk(e){let t=null!=e.content?String(e.content):"";if(!t){i.pL.warn("⚠️ Empty message chunk received - skipping update");return}let s=this.chunkBuffer.includes(t);if(this.lastProcessedChunks.slice(-3).includes(t)&&!s)return;if(await this.ensureMessageExists(),this.hasStartedMessage){var r,a,n,o;null===(r=(a=this.callbacks).setIsThinking)||void 0===r||r.call(a,!1),null===(n=(o=this.callbacks).setIsTyping)||void 0===n||n.call(o,!1)}if(!this.hasStartedMessage){i.pL.warn("⚠️ Message not created yet after ensureMessageExists - buffering chunk",{chunkContent:t.substring(0,30)}),s||this.chunkBuffer.push(t);return}if(s)return;this.lastProcessedChunks.push(t);let l=t+JSON.stringify(e.metadata||{});if(this.lastCompleteMessageSignature===l){i.pL.warn("⚠️ Duplicate message signature detected - skipping chunk",{signature:l.substring(0,50)});return}this.callbacks.updateStreamingMessage(t,!1,e.metadata),i.pL.debug("Message chunk processed",{chunkLength:t.length,totalChunks:this.lastProcessedChunks.length,hasStarted:this.hasStartedMessage})}handleMessageComplete(e){var t,s,r,a,n,o,l,c,d;let u=e.metadata||e.data||{},m=u.field||u.collected_field||u.clarification_field,p=void 0!==u.value?u.value:u.collected_value,h=u.source||"backend";i.pL.info("Message completed",{field:m,hasValue:void 0!==p,source:h,contentLength:(null===(t=e.content)||void 0===t?void 0:t.length)||0,metadataKeys:Object.keys(u)}),this.callbacks.updateStreamingMessage(e.content||"",!0,u),this.callbacks.setIsStreaming(!1),null===(s=(r=this.callbacks).setIsTyping)||void 0===s||s.call(r,!1),null===(a=(n=this.callbacks).setIsThinking)||void 0===a||a.call(n,!1);let g=(e.content||"")+JSON.stringify(u);this.lastCompleteMessageSignature=g,e.metrics&&(null===(c=(d=this.callbacks).trackModelPerformance)||void 0===c||c.call(d,e.metrics)),null===(o=(l=this.callbacks).trackConversationCompletion)||void 0===o||o.call(l,!0,!1)}async ensureMessageExists(){if(this.messageCreationLock){i.pL.debug("Message creation already in progress, skipping");return}if(this.hasStartedMessage){if(this.chunkBuffer.length>0){i.pL.debug("Flushing buffered chunks",{count:this.chunkBuffer.length});let e=this.chunkBuffer.join("");this.chunkBuffer=[],this.callbacks.updateStreamingMessage(e,!1)}return}this.messageCreationLock=!0;try{if(i.pL.debug("Creating new streaming message"),this.callbacks.addMessage({type:"ai",content:"",isStreaming:!0,isComplete:!1}),this.hasStartedMessage=!0,this.chunkBuffer.length>0){i.pL.debug("Flushing buffered chunks on message creation",{count:this.chunkBuffer.length});let e=this.chunkBuffer.join("");this.chunkBuffer=[],this.callbacks.updateStreamingMessage(e,!1)}i.pL.debug("Streaming message created successfully")}catch(e){throw i.pL.error("Failed to create streaming message",{error:e}),this.messageCreationLock=!1,e}finally{this.messageCreationLock=!1}}constructor(e){this.hasStartedMessage=!1,this.messageCreationLock=!1,this.chunkBuffer=[],this.lastProcessedChunks=[],this.lastCompleteMessageSignature=null,this.callbacks=e}}class l{handleReportUpdate(e){var t,s;let r=e.html||e.content||"",a=e.progress||0;i.pL.info("Report update received",{progress:a,htmlLength:r.length,hasHtml:!!r}),null===(t=(s=this.callbacks).onReportUpdate)||void 0===t||t.call(s,r,a)}handleSectionLoading(e){var t,s;let r=e.section||e.section_name||"unknown",a=e.html||e.content||"",n=e.phase||0,o=e.data||e.metadata||{};i.pL.info("Report section loading",{section:r,phase:n,htmlLength:a.length,dataKeys:Object.keys(o)}),null===(t=(s=this.callbacks).onSectionLoading)||void 0===t||t.call(s,r,a,n,o)}handleSectionComplete(e){var t,s;let r=e.section_id||e.section||"unknown",a=e.section_name||e.name||r,n=e.html||e.content||"",o=e.progress||0,l=e.phase;i.pL.info("Report section completed",{sectionId:r,sectionName:a,progress:o,phase:l,htmlLength:n.length}),null===(t=(s=this.callbacks).onSectionComplete)||void 0===t||t.call(s,{sectionId:r,sectionName:a,html:n,progress:o,phase:l})}handleReportSection(e){var t,s;let r=e.section||e.section_name||"unknown",a=e.html||e.content||"",n=e.phase||0,o=e.progress||0,l=e.is_fallback||!1,c=e.is_error||!1,d=e.error_message||e.error||"";i.pL.info("Report section update",{section:r,phase:n,progress:o,isFallback:l,isError:c,htmlLength:a.length,hasErrorMessage:!!d}),null===(t=(s=this.callbacks).onReportSectionUpdate)||void 0===t||t.call(s,r,a,n,o,l,c,d)}handleReportComplete(e){var t,s;let r=e.html||e.content||"",a=e.valuation_id||e.id||"";i.pL.info("Report completed",{valuationId:a,htmlLength:r.length,hasValuationId:!!a}),null===(t=(s=this.callbacks).onReportComplete)||void 0===t||t.call(s,r,a)}constructor(e){this.callbacks=e}}class c{handleProgressUpdate(e){var t,s;i.pL.debug("Progress update received",{progress:e.progress,message:e.message,step:e.step}),null===(t=(s=this.callbacks).onProgressUpdate)||void 0===t||t.call(s,e)}handleProgressSummary(e){var t,s;i.pL.info("Progress summary received",{summary:e.summary,totalSteps:e.total_steps,completedSteps:e.completed_steps,dataKeys:Object.keys(e)}),null===(t=(s=this.callbacks).onProgressUpdate)||void 0===t||t.call(s,e)}handleDataCollected(e){var t,s;let r=e.data||e.collected_data||e,a=r.field||r.key,n=r.value,o=r.source||"backend";i.pL.info("Data collected",{field:a,hasValue:void 0!==n,source:o,dataKeys:Object.keys(r)}),this.callbacks.setCollectedData(e=>({...e,[a]:n})),null===(t=(s=this.callbacks).onDataCollected)||void 0===t||t.call(s,r)}handleSuggestionOffered(e){let t=e.suggestions||e.options||[],s=e.field||e.for_field;i.pL.info("Suggestions offered",{field:s,suggestionCount:t.length,suggestions:t.slice(0,3)}),this.callbacks.addMessage({type:"suggestion",content:e.message||e.content||"Here are some suggestions:",metadata:{suggestions:t,originalValue:e.original_value,field:s},isComplete:!0})}handleClarificationNeeded(e){let t=e.field||e.clarification_field,s=e.message||e.content||"Please provide more information.",r=e.options||e.suggestions||[],a=e.input_type||"text";i.pL.info("Clarification needed",{field:t,inputType:a,hasOptions:r.length>0,optionCount:r.length,messageLength:s.length}),this.callbacks.addMessage({type:"ai",content:s,metadata:{needs_confirmation:!0,clarification_field:t,collected_field:t,input_type:a,options:r,clarification_message:s},isComplete:!0})}handleHtmlPreview(e){var t,s;let r=e.html||e.content||"",a=e.preview_type||e.type||"progressive";i.pL.info("HTML preview received",{previewType:a,htmlLength:r.length,hasHtml:!!r}),null===(t=(s=this.callbacks).onHtmlPreviewUpdate)||void 0===t||t.call(s,r,a)}handleError(e){var t,s,r,a,n,o,l,c;let d=e.message||e.content||e.error||"An unexpected error occurred",u=e.error_type||e.type||"unknown",m=!1!==e.retryable;i.pL.error("Streaming error received",{errorType:u,errorMessage:d.substring(0,100),isRetryable:m,dataKeys:Object.keys(e)}),this.callbacks.addMessage({type:"system",content:"Error: ".concat(d).concat(m?" Please try again.":""),isComplete:!0}),this.callbacks.setIsStreaming(!1),null===(t=(s=this.callbacks).setIsTyping)||void 0===t||t.call(s,!1),null===(r=(a=this.callbacks).setIsThinking)||void 0===r||r.call(a,!1),e.metrics&&(null===(l=(c=this.callbacks).trackModelPerformance)||void 0===l||l.call(c,{...e.metrics,error_occurred:!0,error_type:u})),null===(n=(o=this.callbacks).trackConversationCompletion)||void 0===n||n.call(o,!1,!1)}constructor(e){this.callbacks=e}}class d{handleValuationPreview(e){var t,s;i.pL.info("Valuation preview received",{hasValue:!!e.value,value:e.value,metadataKeys:Object.keys(e)}),this.callbacks.setValuationPreview(e),null===(t=(s=this.callbacks).onValuationPreview)||void 0===t||t.call(s,e)}handleCalculateOption(e){var t,s;i.pL.info("Calculate option received",{hasParameters:!!e.parameters,parametersKeys:e.parameters?Object.keys(e.parameters):[],hasValue:!!e.estimatedValue,estimatedValue:e.estimatedValue}),this.callbacks.setCalculateOption(e),null===(t=(s=this.callbacks).onCalculateOptionAvailable)||void 0===t||t.call(s,e)}handleValuationReady(e){i.pL.info("Valuation ready event received",{dataKeys:Object.keys(e)})}handleValuationConfirmed(e){i.pL.info("Valuation confirmed event received",{dataKeys:Object.keys(e)})}handleValuationComplete(e){var t,s,r,a;i.pL.info("Valuation completed",{hasResult:!!e.result,resultKeys:e.result?Object.keys(e.result):[],hasValuationId:!!e.valuation_id,valuationId:e.valuation_id}),null===(t=(s=this.callbacks).trackConversationCompletion)||void 0===t||t.call(s,!0,!0),null===(r=(a=this.callbacks).onValuationComplete)||void 0===r||r.call(a,e.result||e)}constructor(e){this.callbacks=e}}class u{reset(){i.pL.debug("Resetting StreamEventHandler state for new stream",{sessionId:this.sessionId}),this.messageHandlers.reset()}handleEvent(e){let t=(null==e?void 0:e.type)||(null==e?void 0:e.event)||"unknown";try{switch(t){case"typing":return this.messageHandlers.handleTyping(e);case"message_start":return this.messageHandlers.handleMessageStart(e);case"message_chunk":this.messageHandlers.handleMessageChunk(e).catch(e=>{i.pL.error("Error handling message chunk",{error:e})});return;case"message_complete":return this.messageHandlers.handleMessageComplete(e);case"report_update":return this.reportHandlers.handleReportUpdate(e);case"section_loading":return this.reportHandlers.handleSectionLoading(e);case"section_complete":return this.reportHandlers.handleSectionComplete(e);case"report_section":return this.reportHandlers.handleReportSection(e);case"report_complete":return this.reportHandlers.handleReportComplete(e);case"valuation_preview":return this.valuationHandlers.handleValuationPreview(e);case"calculate_option":return this.valuationHandlers.handleCalculateOption(e);case"valuation_ready":return this.valuationHandlers.handleValuationReady(e);case"valuation_confirmed":return this.valuationHandlers.handleValuationConfirmed(e);case"valuation_complete":return this.valuationHandlers.handleValuationComplete(e);case"progress_summary":return this.uiHandlers.handleProgressSummary(e);case"progress_update":return this.uiHandlers.handleProgressUpdate(e);case"data_collected":return this.uiHandlers.handleDataCollected(e);case"suggestion_offered":return this.uiHandlers.handleSuggestionOffered(e);case"clarification_needed":return this.uiHandlers.handleClarificationNeeded(e);case"html_preview":return this.uiHandlers.handleHtmlPreview(e);case"error":return this.uiHandlers.handleError(e);case"unknown":return this.uiHandlers.handleError({...e,message:e.message||e.content||"An unexpected event occurred",content:e.content||"Unknown event type"});default:return i.pL.warn("Unrecognized event type, treating as error",{type:t}),this.uiHandlers.handleError({...e,message:"Unrecognized event: ".concat(t),content:e.content||"An unexpected error occurred"})}}catch(s){i.pL.error("Error in handleEvent",{eventType:t,error:s instanceof Error?s.message:String(s),stack:s instanceof Error?s.stack:void 0}),this.uiHandlers.handleError({...e,message:"Event processing failed: ".concat(s instanceof Error?s.message:"Unknown error"),error_type:"handler_error"})}}constructor(e,t){this.callbacks=t,this.sessionId=e,this.messageHandlers=new o(t),this.reportHandlers=new l(t),this.valuationHandlers=new d(t),this.uiHandlers=new c(t)}}var m=s(92084),p=s(813);class h{async *streamConversation(e,t,s,r){let a=(e=>{let t;if(!e)return e;let s=/\b(usd|gbp|pounds?|dollars?|cad|aud|chf|yen|jpy|cny|hkd|sek|nok|dkk|zar)\b|[$£¥]/i.test(e)&&!/\b(eur|euro|euros)\b|€/i.test(e),r=(t=e.replace(/[€]/g,"").replace(/\b(eur|euro|euros)\b/gi,"").replace(/[^\d.,\s-]/g,"").trim().replace(/\s+/g,""),t=/^\d{1,3}(\.\d{3})*(,\d+)?$/.test(t)?t.replace(/\./g,"").replace(",","."):t.replace(/,/g,""));return r.match(/^[+-]?\d+(?:\.\d+)?$/)?s?"".concat(r," euro"):r:e})(t);try{i.pL.info("Stream started",{sessionId:e,userInput:t.substring(0,50)+"...",userId:s});let n=null;if(!s)try{n=await p.L.getOrCreateSession()}catch(e){i.pL.warn("Failed to get guest session ID",{error:e})}let o={session_id:e,user_input:a,user_id:s,guest_session_id:n},l="".concat(this.baseURL,"/api/v1/intelligent-conversation/stream"),c=await fetch(l,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify(o),signal:r});if(!c.ok){let e=await c.text();throw i.pL.error("SSE request failed",{status:c.status,errorText:e}),Error("HTTP error! status: ".concat(c.status,", body: ").concat(e))}if(!c.body)throw i.pL.error("Response body is null"),Error("Response body is null");let d=c.body.getReader();if(!d)throw Error("No response body");let u=new TextDecoder,m="";for(;;){if(null==r?void 0:r.aborted){i.pL.info("SSE stream aborted",{sessionId:e}),d.cancel();break}let{done:t,value:s}=await d.read();if(t){i.pL.debug("SSE stream completed");break}let a=u.decode(s,{stream:!0}),n=(m+=a).split("\n");for(let e of(m=n.pop()||"",n))if(!e.startsWith(": ")&&e.startsWith("data: ")&&e.trim().length>6){let t=e.slice(6).trim();if(t)try{let e=JSON.parse(t);if("error"===e.type){i.pL.error("SSE Error received",{message:e.message,sessionId:e.session_id}),yield e;return}if("ping"===e.type)continue;yield e}catch(s){i.pL.error("Failed to parse SSE data",{line:e,jsonStr:t,parseError:s instanceof Error?s.message:String(s)});continue}}}}catch(t){if(t instanceof Error&&"AbortError"===t.name){i.pL.info("SSE stream aborted (expected)",{sessionId:e});return}yield{type:"error",content:t instanceof Error?t.message:"Connection failed"};return}}streamConversationEventSource(e,t,s,r,a,n){let o="".concat(this.baseURL,"/api/v1/intelligent-conversation/stream");i.pL.info("Starting EventSource streaming",{sessionId:e,userInput:t.substring(0,50)+"...",userId:s,url:o});let l=new EventSource("".concat(o,"?session_id=").concat(e,"&user_input=").concat(encodeURIComponent(t),"&user_id=").concat(s||""));return l.onopen=()=>{i.pL.info("EventSource connection opened",{sessionId:e})},l.onmessage=e=>{try{var t;let s=JSON.parse(e.data);i.pL.info("EventSource message received",{type:s.type,hasContent:!!s.content,contentLength:null===(t=s.content)||void 0===t?void 0:t.length}),r&&r(s)}catch(t){i.pL.error("Failed to parse EventSource data",{data:e.data,parseError:t instanceof Error?t.message:"Unknown error"}),a&&a(Error("Parse error: ".concat(t)))}},l.onerror=t=>{i.pL.error("EventSource error",{error:t,sessionId:e,readyState:l.readyState}),a&&a(Error("EventSource error: ".concat(t)))},setTimeout(()=>{l.readyState!==EventSource.CLOSED&&(i.pL.info("EventSource auto-closing after timeout",{sessionId:e}),l.close(),n&&n())},3e4),l}constructor(){this.baseURL=(void 0).VITE_BACKEND_URL||(void 0).VITE_API_URL||"https://web-production-8d00b.up.railway.app"}}let g=new h;class f{setLockRefs(e,t){this.isRequestInProgressRef=e,this.setIsStreamingCallback=t}releaseLocks(e,t){m.Z.warn("[StreamingManager]","Releasing locks: ".concat(e),{requestId:t}),this.requestIdRef.current=null,this.isRequestInProgressRef&&(this.isRequestInProgressRef.current=!1),this.setIsStreamingCallback&&this.setIsStreamingCallback(!1),this.currentAbortController&&(this.currentAbortController.abort(),this.currentAbortController=null)}cleanup(){m.Z.info("[StreamingManager]","Cleanup called - releasing all locks"),this.releaseLocks("Component unmount or cleanup")}async startStreaming(e,t,s,r,a,n){var o,l;let c=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;if(!t.trim()||this.requestIdRef.current){this.requestIdRef.current&&(m.Z.warn("[StreamingManager]","Request already in progress",{existingRequestId:this.requestIdRef.current,sessionId:e}),i.pL.warn("Request already in progress",{currentRequestId:this.requestIdRef.current,sessionId:e}));return}let d="".concat(e,"_").concat(Date.now());this.requestIdRef.current=d,i.pL.info("Stream request",{sessionId:e,userInput:t.substring(0,30)});let u=r.extractBusinessModelFromInput(t),p=r.extractFoundingYearFromInput(t);(u||p)&&(null===(l=r.onContextUpdate)||void 0===l||l.call(r,{extracted_business_model:u,extracted_founding_year:p,extraction_confidence:{business_model:u?.8:0,founding_year:p?.8:0}})),null===(o=r.onStreamStart)||void 0===o||o.call(r),r.setIsStreaming(!0),this.currentAbortController=new AbortController;let h=this.currentAbortController.signal,g=new Promise((e,t)=>{setTimeout(()=>{t(Error("Stream timeout after ".concat(3e4,"ms - no response from backend")))},3e4)});try{await Promise.race([this.streamWithAsyncGenerator(e,t,s,a,h),g])}catch(l){let o=c<3;if(o||this.releaseLocks("Error in stream processing (no retry)",d),l instanceof Error&&l.message.includes("Stream timeout"))throw m.Z.error("[StreamingManager]","Stream timeout",{error:l}),r.setIsStreaming(!1),r.addMessage({type:"ai",content:"⚠️ Connection timeout. The server took too long to respond. Please try again.",isComplete:!0,isStreaming:!1}),l;if(m.Z.error("[StreamingManager]","Error in streamWithAsyncGenerator",{error:l,message:l instanceof Error?l.message:String(l),stack:l instanceof Error?l.stack:void 0}),i.pL.error("Async generator error",{error:l instanceof Error?l.message:"Unknown error",stack:l instanceof Error?l.stack:void 0,sessionId:e,userInput:t.substring(0,50)+"...",attempt:c,maxRetries:3}),o){let o=Math.min(1e3*Math.pow(2,c),1e4);i.pL.info("Retrying streaming conversation",{attempt:c+1,delay:o,sessionId:e}),this.releaseLocks("Error in stream processing (will retry)",d),setTimeout(()=>{this.startStreaming(e,t,s,r,a,n,c+1)},o);return}r.setIsStreaming(!1),this.currentStreamingMessageRef.current&&r.updateStreamingMessage("I apologize, but I'm having trouble connecting. Please try again.",!0),n(l instanceof Error?l:Error("Unknown streaming error"))}finally{null!==this.requestIdRef.current?(m.Z.warn("[StreamingManager]","Finally block releasing locks (safety net)",{requestId:d}),this.releaseLocks("Finally block (safety net)",d)):m.Z.log("[StreamingManager]","Finally block - locks already released",{requestId:d})}}async streamWithAsyncGenerator(e,t,s,r,a){let n,o=0;n=setTimeout(()=>{throw i.pL.warn("Async generator timeout - no events received in 10 seconds",{sessionId:e}),Error("Streaming timeout")},1e4);try{for await(let l of g.streamConversation(e,t,s,a)){if(null==a?void 0:a.aborted)throw i.pL.info("Stream aborted via AbortSignal",{sessionId:e}),clearTimeout(n),Error("Stream aborted");clearTimeout(n),o++;try{r(l)}catch(e){throw i.pL.error("❌ Error in onEvent callback",{error:e instanceof Error?e.message:String(e),stack:e instanceof Error?e.stack:void 0,eventType:l.type,eventCount:o}),e}}if(clearTimeout(n),i.pL.debug("Async generator completed",{totalEvents:o,sessionId:e}),0===o)throw i.pL.warn("No events received from async generator",{sessionId:e}),Error("No events received from async generator")}catch(e){throw clearTimeout(n),e}}streamWithEventSource(e,t,s,r,a,n){return i.pL.info("Starting EventSource fallback",{sessionId:e}),g.streamConversationEventSource(e,t,s,e=>{i.pL.info("EventSource event received",{type:e.type,hasContent:!!e.content}),r(e)},e=>{i.pL.error("EventSource error",{error:e.message}),a(e)},()=>{i.pL.info("EventSource completed",{sessionId:e}),n()})}isRequestInProgress(){return null!==this.requestIdRef.current}getCurrentRequestId(){return this.requestIdRef.current}clearCurrentRequest(){this.releaseLocks("Manual clearCurrentRequest call")}getCurrentStreamingMessage(){return this.currentStreamingMessageRef.current}setCurrentStreamingMessage(e){this.currentStreamingMessageRef.current=e}constructor(e,t){this.currentAbortController=null,this.isRequestInProgressRef=null,this.setIsStreamingCallback=null,this.requestIdRef=e,this.currentStreamingMessageRef=t}}var x=s(81046),v=s(30761);let b=[{question:"Welcome! Let me help you value your business. What is the name of your company?",field:"company_name",inputType:"text",helpText:"Enter your registered company name"},{question:"What type of business do you run?",field:"business_type",inputType:"select",options:["Technology","Manufacturing","Services","Retail","Other"]},{question:"What was your annual revenue last year?",field:"revenue",inputType:"number",helpText:"Enter your total annual revenue"},{question:"How many employees do you have?",field:"employee_count",inputType:"number",helpText:"Enter the number of full-time employees"}],y=(e,t,s)=>{let[r,n]=(0,a.useState)(!0),o=(0,a.useRef)(!1),l=(0,a.useRef)(null),c=(0,a.useRef)(null),d=(0,a.useCallback)(()=>{if(!s)return;let t=b[0],r={id:"fallback-".concat(Date.now()),type:"ai",role:"assistant",content:t.question,timestamp:new Date,metadata:{intent:"question",topic:"company_name",collected_field:t.field,help_text:t.helpText,fallback_mode:!0}};s.setMessages([r]),n(!1),i.pL.info("Using fallback mode - backend unavailable",{session_id:e,question:t.question})},[e,s]),u=(0,a.useCallback)(async function(){var r,a,o,c,m,h,g,f,x,v,b,y,_,w,k,j,S,N,C,E,L,I,M,R,T,z,A,P,O,D,V,H,U,F,q,B,Z,K,W,G,$,Y,J;let X=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,Q=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3;if(!s)return;let ee=Date.now();try{n(!0);let J=(void 0).VITE_BACKEND_URL||(void 0).VITE_API_URL||"https://web-production-8d00b.up.railway.app",et=setTimeout(()=>{l.current&&l.current.abort()},1e4);try{let n=null;if(!t)try{n=await p.L.getOrCreateSession()}catch(e){i.pL.warn("Failed to get guest session ID",{error:e})}let d=await fetch("".concat(J,"/api/v1/intelligent-conversation/start"),{method:"POST",signal:null===(r=l.current)||void 0===r?void 0:r.signal,credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:t||null,guest_session_id:n,business_context:t?{company_name:null===(a=s.user)||void 0===a?void 0:a.company_name,industry:null===(o=s.user)||void 0===o?void 0:o.industry,business_type:null===(c=s.user)||void 0===c?void 0:c.business_type,country_code:null===(m=s.user)||void 0===m?void 0:m.country,founding_year:null===(h=s.user)||void 0===h?void 0:h.founded_year}:void 0,pre_filled_data:t?{user_id:t,company_name:null===(g=s.user)||void 0===g?void 0:g.company_name,business_type:null===(f=s.user)||void 0===f?void 0:f.business_type,industry:null===(x=s.user)||void 0===x?void 0:x.industry,founded_year:null===(v=s.user)||void 0===v?void 0:v.founded_year,years_in_operation:null===(b=s.user)||void 0===b?void 0:b.years_in_operation,employee_count_range:null===(y=s.user)||void 0===y?void 0:y.employee_count_range,city:null===(_=s.user)||void 0===_?void 0:_.city,country:null===(w=s.user)||void 0===w?void 0:w.country,company_description:null===(k=s.user)||void 0===k?void 0:k.company_description}:void 0,user_preferences:{time_commitment:"detailed",focus_area:"all"}})});if(clearTimeout(et),!d.ok){let e=await d.text();throw i.pL.error("Conversation start failed",{status:d.status,statusText:d.statusText,errorBody:e,requestBody:{user_id:t||null,business_context:t?{company_name:null===(N=s.user)||void 0===N?void 0:N.company_name,industry:null===(C=s.user)||void 0===C?void 0:C.industry,business_type:null===(E=s.user)||void 0===E?void 0:E.business_type,country_code:null===(L=s.user)||void 0===L?void 0:L.country,founding_year:null===(I=s.user)||void 0===I?void 0:I.founded_year}:void 0,pre_filled_data:t?{user_id:t,company_name:null===(M=s.user)||void 0===M?void 0:M.company_name,business_type:null===(R=s.user)||void 0===R?void 0:R.business_type,industry:null===(T=s.user)||void 0===T?void 0:T.industry,founded_year:null===(z=s.user)||void 0===z?void 0:z.founded_year,years_in_operation:null===(A=s.user)||void 0===A?void 0:A.years_in_operation,employee_count_range:null===(P=s.user)||void 0===P?void 0:P.employee_count_range,city:null===(O=s.user)||void 0===O?void 0:O.city,country:null===(D=s.user)||void 0===D?void 0:D.country,company_description:null===(V=s.user)||void 0===V?void 0:V.company_description}:void 0,user_preferences:{time_commitment:"detailed",focus_area:"all"}}}),Error("HTTP ".concat(d.status,": ").concat(e))}let u=await d.json(),B=u.session_id;if(!B)throw i.pL.error("Missing session_id in /start response",{clientSessionId:e,responseKeys:Object.keys(u)}),Error("Backend did not return session_id");if(i.pL.info("Received session ID from Python backend",{clientSessionId:e,backendSessionId:B,isAuthenticated:!!t}),null===(j=s.onSessionIdUpdate)||void 0===j||j.call(s,B),!u.ai_message||!u.field_name)throw Error("Invalid response structure from backend");if(!(null===(S=l.current)||void 0===S?void 0:S.signal.aborted)){let r=Date.now()-ee;i.pL.info("Conversation initialized successfully",{sessionId:e,userId:t,isAuthenticated:!!t,firstField:u.field_name,backendDriven:!0,attempt:X,timeToFirstQuestionMs:r}),i.pL.info("conversation_initialized",{session_id:e,user_id:t,is_authenticated:!!t,time_to_first_question_ms:r,backend_driven:!0,first_field:u.field_name,attempt:X,has_profile_data:!!((null===(H=s.user)||void 0===H?void 0:H.company_name)||(null===(U=s.user)||void 0===U?void 0:U.business_type)||(null===(F=s.user)||void 0===F?void 0:F.industry))});let a={type:"ai",content:u.ai_message,isComplete:!0,isStreaming:!1,metadata:{collected_field:u.field_name,help_text:u.help_text,session_phase:"data_collection",conversation_turn:1}};s.addMessage(a),i.pL.debug("Initial message created from /start",{field:u.field_name,questionPreview:null===(q=u.ai_message)||void 0===q?void 0:q.substring(0,50)})}}catch(a){if(clearTimeout(et),a instanceof Error&&"AbortError"===a.name){i.pL.info("Initialization cancelled",{sessionId:e,userId:t});return}if(a instanceof Error&&"AbortError"===a.name&&(null===(B=l.current)||void 0===B?void 0:B.signal.aborted)){i.pL.warn("Initialization timed out",{sessionId:e,userId:t,timeoutMs:1e4}),(null===($=l.current)||void 0===$?void 0:$.signal.aborted)||s.addMessage({type:"ai",content:"Sorry, the connection is taking too long. Let me start with a simple question: What is the name of your company?",isComplete:!0,metadata:{collected_field:"company_name"}});return}if(X<Q){let s=Math.min(1e3*Math.pow(2,X-1),5e3);return i.pL.warn("Initialization attempt ".concat(X," failed, retrying in ").concat(s,"ms"),{sessionId:e,userId:t,error:a instanceof Error?a.message:"Unknown error",nextAttempt:X+1,maxAttempts:Q}),await new Promise(e=>setTimeout(e,s)),u(X+1,Q)}let r=Date.now()-ee;i.pL.error("All initialization attempts failed",{error:a instanceof Error?a.message:"Unknown error",sessionId:e,userId:t,stack:a instanceof Error?a.stack:void 0,errorType:a instanceof Error?a.name:"Unknown",totalAttempts:X,timeElapsedMs:r}),i.pL.error("conversation_initialization_failed",{session_id:e,user_id:t,error_type:a instanceof Error?a.name:"Unknown",error_message:a instanceof Error?a.message:"Unknown error",time_elapsed_ms:r,fallback_used:!0,total_attempts:X,has_profile_data:!!((null===(Z=s.user)||void 0===Z?void 0:Z.company_name)||(null===(K=s.user)||void 0===K?void 0:K.business_type)||(null===(W=s.user)||void 0===W?void 0:W.industry))}),d(),(null===(G=l.current)||void 0===G?void 0:G.signal.aborted)||s.addMessage({type:"ai",content:"Welcome! Let me help you value your business. What is the name of your company?",isComplete:!0,metadata:{collected_field:"company_name"}})}finally{clearTimeout(et),(null===(Y=l.current)||void 0===Y?void 0:Y.signal.aborted)||n(!1)}}catch(r){i.pL.error("Unexpected error in initialization retry logic",{error:r instanceof Error?r.message:"Unknown error",sessionId:e,userId:t,stack:r instanceof Error?r.stack:void 0}),(null===(J=l.current)||void 0===J?void 0:J.signal.aborted)||!s||(s.addMessage({type:"ai",content:"Welcome! Let me help you value your business. What type of business do you run?",isComplete:!0,metadata:{collected_field:"business_type"}}),n(!1))}},[e,t,s,d]);return(0,a.useEffect)(()=>{var t;if(!s)return;let r=null!==(t=s.pythonSessionId)&&void 0!==t?t:null,a=c.current!==r;a&&(i.pL.info("\uD83D\uDD04 Python sessionId changed - resetting initialization state",{previousSessionId:c.current,newSessionId:r,sessionId:e}),o.current=!1,n(!0),c.current=r,l.current&&(l.current.abort(),l.current=new AbortController));let d=s.getCurrentMessages?s.getCurrentMessages():[],m=d.length>0;if(i.pL.debug("useConversationInitializer: state check",{sessionId:e,pythonSessionId:r,messageCount:d.length,hasMessages:m,isRestoring:s.isRestoring,isSessionInitialized:s.isSessionInitialized,isRestorationComplete:s.isRestorationComplete,hasInitialized:o.current,pythonSessionIdChanged:a}),m){i.pL.info("✅ Messages found - using existing conversation",{sessionId:e,messageCount:d.length,pythonSessionId:r}),o.current=!0,n(!1);return}if(!s.isSessionInitialized){i.pL.debug("Session not initialized - waiting",{sessionId:e,pythonSessionId:r});return}if(!s.isRestorationComplete){i.pL.debug("Restoration not complete - waiting",{sessionId:e,pythonSessionId:r});return}if(o.current){i.pL.debug("Already initialized - skipping",{sessionId:e,pythonSessionId:r});return}return i.pL.info("\uD83D\uDE80 Starting new conversation",{sessionId:e,pythonSessionId:r}),o.current=!0,u(),()=>{l.current&&l.current.abort()}},[e,u,s,null==s?void 0:s.isRestoring,null==s?void 0:s.isSessionInitialized,null==s?void 0:s.isRestorationComplete,null==s?void 0:s.pythonSessionId,null==s?void 0:s.getCurrentMessages]),{isInitializing:r,initializeWithRetry:u,resetInitialization:(0,a.useCallback)(()=>{o.current=!1,n(!0),l.current&&l.current.abort(),l.current=new AbortController},[]),useFallbackMode:d}},_=(e,t)=>{let[s,r]=(0,a.useState)({session_id:e,user_id:t,started_at:new Date,total_turns:0,successful:!1,ai_response_count:0,user_message_count:0,error_count:0,retry_count:0,avg_response_time_ms:0,valuation_generated:!1,data_completeness_percent:0,collected_fields:[],total_tokens_used:0,estimated_cost_usd:0,feedback_provided:!1}),n=(0,a.useCallback)(t=>{i.pL.info("Model performance tracked",{sessionId:e,model:t.model_name,responseTime:t.total_response_time_ms,tokens:t.output_tokens,cost:t.estimated_cost_usd}),r(e=>({...e,total_tokens_used:e.total_tokens_used+t.output_tokens,estimated_cost_usd:e.estimated_cost_usd+t.estimated_cost_usd,avg_response_time_ms:0===e.avg_response_time_ms?t.total_response_time_ms:(e.avg_response_time_ms+t.total_response_time_ms)/2})),t.total_response_time_ms>5e3&&i.pL.warn("Slow model response detected",{sessionId:e,responseTime:t.total_response_time_ms,threshold:5e3}),t.estimated_cost_usd>.1&&i.pL.warn("High cost response detected",{sessionId:e,cost:t.estimated_cost_usd,tokens:t.output_tokens})},[e]),o=(0,a.useCallback)((a,n)=>{i.pL.info("Conversation completion tracked",{sessionId:e,success:a,hasValuation:n,totalTurns:s.total_turns}),r(e=>({...e,successful:a,valuation_generated:n})),i.pL.info("conversation_completed",{session_id:e,user_id:t,success:a,has_valuation:n,total_turns:s.total_turns,ai_responses:s.ai_response_count,user_messages:s.user_message_count,errors:s.error_count,retries:s.retry_count,avg_response_time_ms:s.avg_response_time_ms,total_tokens:s.total_tokens_used,estimated_cost_usd:s.estimated_cost_usd,data_completeness_percent:s.data_completeness_percent,collected_fields:s.collected_fields})},[e,t,s]),l=(0,a.useCallback)(t=>{r(e=>({...e,...t})),i.pL.debug("Metrics updated",{sessionId:e,updates:Object.keys(t)})},[e]),c=(0,a.useCallback)(()=>{r(e=>({...e,total_turns:e.total_turns+1}))},[]),d=(0,a.useCallback)(()=>{r(e=>({...e,ai_response_count:e.ai_response_count+1}))},[]),u=(0,a.useCallback)(()=>{r(e=>({...e,user_message_count:e.user_message_count+1}))},[]),m=(0,a.useCallback)(()=>{r(e=>({...e,error_count:e.error_count+1}))},[]),p=(0,a.useCallback)(()=>{r(e=>({...e,retry_count:e.retry_count+1}))},[]),h=(0,a.useCallback)((e,t)=>{r(s=>({...s,data_completeness_percent:e,collected_fields:t}))},[]),g=(0,a.useCallback)(()=>{r(e=>({...e,feedback_provided:!0}))},[]),f=(0,a.useCallback)(()=>{r({session_id:e,user_id:t,started_at:new Date,total_turns:0,successful:!1,ai_response_count:0,user_message_count:0,error_count:0,retry_count:0,avg_response_time_ms:0,valuation_generated:!1,data_completeness_percent:0,collected_fields:[],total_tokens_used:0,estimated_cost_usd:0,feedback_provided:!1})},[e,t]),x=(0,a.useCallback)(()=>({sessionId:e,userId:t,duration:Date.now()-s.started_at.getTime(),totalTurns:s.total_turns,success:s.successful,aiResponses:s.ai_response_count,userMessages:s.user_message_count,errors:s.error_count,retries:s.retry_count,avgResponseTime:s.avg_response_time_ms,valuationGenerated:s.valuation_generated,dataCompleteness:s.data_completeness_percent,collectedFields:s.collected_fields.length,totalTokens:s.total_tokens_used,estimatedCost:s.estimated_cost_usd,feedbackProvided:s.feedback_provided}),[e,t,s]);return{metrics:s,trackModelPerformance:n,trackConversationCompletion:o,updateMetrics:l,incrementTurn:c,incrementAIResponse:d,incrementUserMessage:u,incrementError:m,incrementRetry:p,updateDataCompleteness:h,markFeedbackProvided:g,resetMetrics:f,getMetricsSummary:x}},w=(e,t)=>{let[s,r]=(0,a.useState)([]),n=(0,a.useCallback)(t=>{if(t.length<=100)return t;let s=t.slice(0,10),r=t.slice(-50),a=[...s,...r.filter(e=>!s.find(t=>t.id===e.id))];return console.warn("Message pruning: ".concat(t.length," -> ").concat(a.length," messages"),{sessionId:e,keptFirst:s.length,keptRecent:r.length,removed:t.length-a.length}),a},[e]),i=(0,a.useCallback)(e=>{r(t=>{let s="function"==typeof e?e(t):e;return s.length>=120?n(s):s})},[n]),[o,l]=(0,a.useState)(""),[c,d]=(0,a.useState)(!1),[u,m]=(0,a.useState)(!1),[p,h]=(0,a.useState)(!1),[g,f]=(0,a.useState)(void 0),[x,v]=(0,a.useState)({}),[b,y]=(0,a.useState)(null),[_,w]=(0,a.useState)(null),[k,j]=(0,a.useState)({session_id:e,user_id:t,started_at:new Date,total_turns:0,successful:!1,ai_response_count:0,user_message_count:0,error_count:0,retry_count:0,avg_response_time_ms:0,valuation_generated:!1,data_completeness_percent:0,collected_fields:[],total_tokens_used:0,estimated_cost_usd:0,feedback_provided:!1}),S=(0,a.useRef)(null),N=(0,a.useRef)(null),C=(0,a.useRef)(null);return{messages:s,input:o,isStreaming:c,isTyping:u,isThinking:p,typingContext:g,collectedData:x,valuationPreview:b,calculateOption:_,conversationMetrics:k,refs:{messagesEndRef:S,eventSourceRef:N,currentStreamingMessageRef:C,requestIdRef:(0,a.useRef)(null),hasInitializedRef:(0,a.useRef)(!1),abortControllerRef:(0,a.useRef)(null)},setMessages:i,setInput:l,setIsStreaming:d,setIsTyping:m,setIsThinking:h,setTypingContext:f,setCollectedData:v,setValuationPreview:y,setCalculateOption:w,setConversationMetrics:j}},k=e=>{let[t,s]=(0,a.useState)(""),[r,n]=(0,a.useState)(!1),i=(0,a.useRef)(""),o=(0,a.useRef)(0),l=(0,a.useRef)(),c=(0,a.useRef)(0),d=(0,a.useCallback)(e=>{i.current+=e,r||(n(!0),h())},[r,h]),u=(0,a.useCallback)((t,s)=>{if(!(null==e?void 0:e.adaptiveSpeed))return(null==e?void 0:e.baseSpeed)||50;let r=t.length-s,a=t[s];return r<50?30:t.includes("valuation")||t.includes("€")||t.includes("million")?70:a&&/[0-9€$%]/.test(a)?60:50},[null==e?void 0:e.adaptiveSpeed,null==e?void 0:e.baseSpeed]),m=(0,a.useCallback)(t=>(null==e?void 0:e.punctuationPauses)&&/[.,:\n]/.test(t),[null==e?void 0:e.punctuationPauses]),p=(0,a.useCallback)(e=>({".":200,",":100,"\n":150,":":120})[e]||0,[]),h=(0,a.useCallback)(()=>{let e=t=>{if(t-c.current>=u(i.current,o.current)){if(o.current<i.current.length){let r=i.current[o.current];if(s(i.current.substring(0,o.current+1)),o.current++,c.current=t,m(r)){setTimeout(()=>{l.current=requestAnimationFrame(e)},p(r));return}}else{n(!1);return}}l.current=requestAnimationFrame(e)};l.current=requestAnimationFrame(e)},[u,m,p]),g=(0,a.useCallback)(()=>{l.current&&cancelAnimationFrame(l.current),s(i.current),o.current=i.current.length,n(!1)},[]),f=(0,a.useCallback)(()=>{l.current&&cancelAnimationFrame(l.current),i.current="",o.current=0,s(""),n(!1)},[]);return(0,a.useEffect)(()=>()=>{l.current&&cancelAnimationFrame(l.current)},[]),{displayedText:t,isTyping:r,addToBuffer:d,complete:g,reset:f}},j=e=>{let{input:t,onInputChange:s,onSubmit:a,isStreaming:n,disabled:i=!1,placeholder:o="Ask about your business valuation...",suggestions:l=[]}=e;return(0,r.jsx)("div",{className:"p-4 border-t border-zinc-800",children:(0,r.jsxs)("form",{onSubmit:a,className:"focus-within:bg-zinc-900/60 group flex flex-col gap-3 p-4 duration-300 w-full rounded-3xl border border-white/10 bg-zinc-900/40 text-base shadow-xl transition-all ease-in-out focus-within:border-zinc-500/40 hover:border-zinc-600/30 backdrop-blur-md",children:[(0,r.jsx)("div",{className:"relative flex items-center",children:(0,r.jsx)("textarea",{value:t,onChange:e=>s(e.target.value),onKeyPress:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),a(e))},placeholder:o,disabled:i||n,className:"textarea-seamless flex w-full rounded-md px-3 py-3 ring-offset-background placeholder:text-zinc-400 focus-visible:outline-none focus-visible:ring-0 focus-visible:ring-offset-0 disabled:cursor-not-allowed disabled:opacity-50 resize-none text-base leading-snug placeholder-shown:text-ellipsis placeholder-shown:whitespace-nowrap md:text-base max-h-[200px] bg-transparent focus:bg-transparent flex-1 text-white border-0 border-none",style:{minHeight:"80px",height:"80px"},spellCheck:"false"})}),(0,r.jsxs)("div",{className:"flex gap-2 flex-wrap items-center",children:[l.filter(Boolean).map((e,t)=>(0,r.jsx)("button",{type:"button",onClick:()=>s(e),disabled:n,className:"px-3 py-1.5 bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 hover:border-zinc-600 rounded-full text-xs text-zinc-300 hover:text-white transition-all duration-200 hover:shadow-md disabled:opacity-50 disabled:cursor-not-allowed",children:e},t)),(0,r.jsx)("div",{className:"flex flex-grow items-center justify-end gap-2",children:(0,r.jsx)("button",{type:"submit",disabled:!t.trim()||n||i,className:"submit-button-white flex h-8 w-8 items-center justify-center rounded-full transition-all duration-200 ease-out shadow-lg disabled:cursor-not-allowed disabled:opacity-50 disabled:shadow-none ".concat(n?"bg-zinc-800 scale-95 ring-2 ring-primary-500/20":"bg-white hover:bg-zinc-200 hover:shadow-white/20 active:scale-90"),children:n?(0,r.jsxs)("div",{className:"relative w-4 h-4",children:[(0,r.jsx)("div",{className:"absolute inset-0 border-2 border-zinc-600 rounded-full"}),(0,r.jsx)("div",{className:"absolute inset-0 border-2 border-t-primary-500 rounded-full animate-spin"})]}):(0,r.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",strokeLinecap:"round",strokeLinejoin:"round",className:"text-zinc-900 ml-0.5",children:[(0,r.jsx)("line",{x1:"22",y1:"2",x2:"11",y2:"13"}),(0,r.jsx)("polygon",{points:"22 2 15 22 11 13 2 9 22 2"})]})})})]})]})})};var S=s(12931),N=s(3274),C=s(68954),E=s(92940);(void 0).VITE_VALUATION_ENGINE_URL||(void 0).VITE_VALUATION_API_URL,(void 0).VITE_ENABLE_STREAMING,parseInt((void 0).VITE_STREAMING_TIMEOUT||"30000"),parseInt((void 0).VITE_MAX_RETRY_ATTEMPTS||"3"),(void 0).MODE;let L={enabled:"true"===(void 0).VITE_AI_ENHANCED_MODE||!0,model:(void 0).VITE_OPENAI_MODEL||"gpt-4o-mini",showReasoning:"true"===(void 0).VITE_SHOW_AI_REASONING||!0,showHelpText:"true"===(void 0).VITE_SHOW_AI_HELP_TEXT||!0,showNarratives:"true"===(void 0).VITE_SHOW_VALUATION_NARRATIVES||!0,branding:{expertTitle:"AI Valuation Expert",levelIndicator:"Big 4 Level",showLevelBadge:"true"===(void 0).VITE_SHOW_LEVEL_BADGE||!0}};var I=s(37151),M=s(53225),R=s(71976);let T=e=>{let{answer:t,reasoning:s,example:a,nudge:n,timestamp:i}=e;return(0,r.jsx)(S.E.div,{initial:{opacity:0,y:10,scale:.98},animate:{opacity:1,y:0,scale:1},transition:{duration:.3,ease:"easeOut"},className:"flex justify-start",children:(0,r.jsx)("div",{className:"max-w-[85%] mr-auto",children:(0,r.jsxs)("div",{className:"flex items-start gap-3",children:[(0,r.jsx)("div",{className:"flex-shrink-0 w-8 h-8 bg-gradient-to-br from-accent-500/20 to-accent-600/20 rounded-full flex items-center justify-center border border-accent-400/30 shadow-lg shadow-accent-500/20 mt-1",children:(0,r.jsx)(C.Z,{className:"w-4 h-4 text-accent-300"})}),(0,r.jsxs)("div",{className:"flex flex-col gap-1",children:[(0,r.jsxs)("div",{className:"rounded-2xl rounded-tl-sm px-5 py-4 bg-gradient-to-br from-accent-900/20 via-accent-800/10 to-accent-900/20 border border-accent-400/20 shadow-lg backdrop-blur-sm",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2 mb-3 pb-2 border-b border-accent-400/20",children:[(0,r.jsx)(I.Z,{className:"w-4 h-4 text-accent-300"}),(0,r.jsx)("span",{className:"text-xs font-semibold text-accent-300 uppercase tracking-wider",children:"AI Assistant"})]}),(0,r.jsxs)("div",{className:"space-y-3",children:[(0,r.jsx)("div",{className:"text-[15px] leading-relaxed text-zinc-100",children:t}),s&&(0,r.jsxs)("div",{className:"flex items-start gap-2 p-3 bg-accent-500/10 rounded-lg border border-accent-400/20",children:[(0,r.jsx)(M.Z,{className:"w-4 h-4 text-accent-300 flex-shrink-0 mt-0.5"}),(0,r.jsxs)("div",{className:"text-sm text-accent-200 leading-relaxed",children:[(0,r.jsx)("span",{className:"font-medium text-accent-300",children:"Why it matters: "}),s]})]}),a&&(0,r.jsxs)("div",{className:"p-3 bg-accent-500/10 rounded-lg border border-accent-400/20",children:[(0,r.jsx)("div",{className:"text-xs font-medium text-accent-300 mb-1.5 uppercase tracking-wider",children:"Example:"}),(0,r.jsx)("div",{className:"text-sm text-accent-100 leading-relaxed",children:a})]}),(0,r.jsxs)("div",{className:"flex items-start gap-2 pt-3 mt-3 border-t border-accent-400/20",children:[(0,r.jsx)(R.Z,{className:"w-4 h-4 text-accent-300 flex-shrink-0 mt-0.5"}),(0,r.jsx)("div",{className:"text-sm text-accent-200 leading-relaxed",children:n})]})]})]}),i&&(0,r.jsxs)("div",{className:"text-xs text-zinc-500 ml-1 flex items-center gap-1",children:[(0,r.jsx)("span",{className:"text-accent-400",children:"●"}),i.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})]})]})]})})})};var z=s(13231),A=s(74232),P=s(16717);let O=e=>{let{businessType:t,industry:s,category:a,icon:n="\uD83C\uDFE2",confidence:i,timestamp:o}=e;return(0,r.jsx)(S.E.div,{initial:{opacity:0,y:10,scale:.98},animate:{opacity:1,y:0,scale:1},transition:{duration:.3,ease:"easeOut"},className:"flex justify-start w-full my-2",children:(0,r.jsx)("div",{className:"max-w-[85%] mr-auto w-full",children:(0,r.jsxs)("div",{className:"flex items-start gap-3",children:[(0,r.jsx)("div",{className:"flex-shrink-0 w-8 h-8 bg-primary-500/20 rounded-full flex items-center justify-center border border-primary-500/30 shadow-lg shadow-primary-500/10 mt-1",children:(0,r.jsx)(z.Z,{className:"w-4 h-4 text-primary-400"})}),(0,r.jsxs)("div",{className:"flex flex-col gap-1 w-full",children:[(0,r.jsxs)("div",{className:"rounded-2xl rounded-tl-sm overflow-hidden border border-primary-500/20 shadow-lg backdrop-blur-sm bg-zinc-900/40",children:[(0,r.jsx)("div",{className:"px-5 py-3 bg-gradient-to-r from-primary-900/20 to-transparent border-b border-primary-500/10 flex items-center justify-between",children:(0,r.jsxs)("span",{className:"text-xs font-semibold text-primary-400 uppercase tracking-wider flex items-center gap-1.5",children:[(0,r.jsx)("span",{className:"w-1.5 h-1.5 rounded-full bg-primary-400 animate-pulse"}),"Verified Business Type"]})}),(0,r.jsxs)("div",{className:"p-5",children:[(0,r.jsxs)("div",{className:"flex items-start gap-4",children:[(0,r.jsx)("div",{className:"flex-shrink-0 w-12 h-12 rounded-xl bg-gradient-to-br from-zinc-800 to-zinc-900 border border-zinc-700/50 flex items-center justify-center text-2xl shadow-inner",children:n}),(0,r.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,r.jsx)("h3",{className:"text-lg font-semibold text-white leading-tight mb-1",children:t}),(0,r.jsxs)("div",{className:"flex flex-wrap gap-2 mt-2",children:[s&&(0,r.jsxs)("div",{className:"inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md bg-zinc-800/50 border border-zinc-700/50 text-xs font-medium text-zinc-300",children:[(0,r.jsx)(A.Z,{className:"w-3 h-3 text-zinc-400"}),s]}),a&&(0,r.jsxs)("div",{className:"inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md bg-zinc-800/50 border border-zinc-700/50 text-xs font-medium text-zinc-300",children:[(0,r.jsx)(P.Z,{className:"w-3 h-3 text-zinc-400"}),a]})]})]})]}),(0,r.jsx)("div",{className:"mt-4 pt-3 border-t border-white/5 text-sm text-zinc-400 leading-relaxed",children:"We've successfully matched your business to our valuation database."})]})]}),o&&(0,r.jsxs)("div",{className:"text-xs text-zinc-500 ml-1 flex items-center gap-1",children:[(0,r.jsx)("span",{className:"text-primary-500/50",children:"●"}),o.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})]})]})]})})})};var D=s(74697);let V=e=>{let{suggestions:t,onSelect:s}=e,[n,i]=(0,a.useState)(!1),o=e=>{"none"===e&&i(!0),s(e)};return n?null:(0,r.jsxs)("div",{className:"mt-4 space-y-2",children:[(0,r.jsx)("div",{className:"text-xs text-zinc-400 mb-3",children:"Select the business type that best describes your business:"}),(0,r.jsx)("div",{className:"space-y-2",children:t.map(e=>(0,r.jsx)("button",{onClick:()=>o(e.number.toString()),className:"w-full text-left group relative","aria-label":"Select ".concat(e.title),children:(0,r.jsxs)("div",{className:"flex items-start gap-3 p-3 bg-zinc-800/50 border border-zinc-700/50 rounded-lg hover:border-primary-500/50 hover:bg-zinc-800/70 transition-all duration-200 cursor-pointer",children:[(0,r.jsx)("div",{className:"flex-shrink-0 w-8 h-8 bg-primary-600/20 text-primary-400 rounded-full flex items-center justify-center text-sm font-semibold",children:e.number}),(0,r.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("span",{className:"text-lg flex-shrink-0",children:e.icon||"\uD83C\uDFE2"}),(0,r.jsx)("span",{className:"font-semibold text-white group-hover:text-primary-300 transition-colors",children:e.title})]}),e.description&&(0,r.jsx)("div",{className:"text-xs text-zinc-400 mt-1 ml-8",children:e.description}),e.category&&(0,r.jsx)("div",{className:"text-xs text-zinc-500 mt-1 ml-8 font-medium",children:e.category})]}),(0,r.jsx)("div",{className:"flex-shrink-0 opacity-0 group-hover:opacity-100 transition-opacity",children:(0,r.jsx)("div",{className:"w-2 h-2 bg-primary-500 rounded-full"})})]})},e.number))}),(0,r.jsx)("button",{onClick:()=>o("none"),className:"w-full mt-3 p-3 bg-zinc-800/30 border border-zinc-700/30 rounded-lg hover:border-zinc-600 hover:bg-zinc-800/50 transition-all duration-200 text-center","aria-label":"None of these business types match",children:(0,r.jsxs)("div",{className:"flex items-center justify-center gap-2 text-sm text-zinc-300 hover:text-white",children:[(0,r.jsx)(D.Z,{className:"w-4 h-4"}),(0,r.jsx)("span",{children:"None of these match - let me type it"})]})})]})};var H=s(22023),U=s(24241);let F=e=>{let{companyName:t,registrationNumber:s,legalForm:a,foundingYear:n,industryDescription:i,confidence:o,timestamp:l}=e;return(0,r.jsx)(S.E.div,{initial:{opacity:0,y:10,scale:.98},animate:{opacity:1,y:0,scale:1},transition:{duration:.3,ease:"easeOut"},className:"flex justify-start w-full my-2",children:(0,r.jsx)("div",{className:"max-w-[85%] mr-auto w-full",children:(0,r.jsxs)("div",{className:"flex items-start gap-3",children:[(0,r.jsx)("div",{className:"flex-shrink-0 w-8 h-8 bg-primary-500/20 rounded-full flex items-center justify-center border border-primary-500/30 shadow-lg shadow-primary-500/10 mt-1",children:(0,r.jsx)(z.Z,{className:"w-4 h-4 text-primary-400"})}),(0,r.jsxs)("div",{className:"flex flex-col gap-1 w-full",children:[(0,r.jsxs)("div",{className:"rounded-2xl rounded-tl-sm overflow-hidden border border-primary-500/20 shadow-lg backdrop-blur-sm bg-zinc-900/40",children:[(0,r.jsx)("div",{className:"px-5 py-3 bg-gradient-to-r from-primary-900/20 to-transparent border-b border-primary-500/10 flex items-center justify-between",children:(0,r.jsxs)("span",{className:"text-xs font-semibold text-primary-400 uppercase tracking-wider flex items-center gap-1.5",children:[(0,r.jsx)("span",{className:"w-1.5 h-1.5 rounded-full bg-primary-400 animate-pulse"}),"Verified Company"]})}),(0,r.jsxs)("div",{className:"p-5",children:[(0,r.jsxs)("div",{className:"flex items-start gap-4",children:[(0,r.jsx)("div",{className:"flex-shrink-0 w-12 h-12 rounded-xl bg-gradient-to-br from-zinc-800 to-zinc-900 border border-zinc-700/50 flex items-center justify-center text-2xl shadow-inner",children:"\uD83C\uDFE2"}),(0,r.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,r.jsx)("h3",{className:"text-lg font-semibold text-white leading-tight mb-1",children:t}),(0,r.jsxs)("div",{className:"flex flex-wrap gap-2 mt-2",children:[s&&(0,r.jsxs)("div",{className:"inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md bg-zinc-800/50 border border-zinc-700/50 text-xs font-medium text-zinc-300",children:[(0,r.jsx)(H.Z,{className:"w-3 h-3 text-zinc-400"}),"Registration: ",s]}),a&&(0,r.jsxs)("div",{className:"inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md bg-zinc-800/50 border border-zinc-700/50 text-xs font-medium text-zinc-300",children:[(0,r.jsx)(A.Z,{className:"w-3 h-3 text-zinc-400"}),"Type: ",a]}),n&&(0,r.jsxs)("div",{className:"inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md bg-zinc-800/50 border border-zinc-700/50 text-xs font-medium text-zinc-300",children:[(0,r.jsx)(U.Z,{className:"w-3 h-3 text-zinc-400"}),"Founded: ",n]}),i&&(0,r.jsxs)("div",{className:"inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md bg-zinc-800/50 border border-zinc-700/50 text-xs font-medium text-zinc-300",children:[(0,r.jsx)(A.Z,{className:"w-3 h-3 text-zinc-400"}),i]})]})]})]}),(0,r.jsx)("div",{className:"mt-4 pt-3 border-t border-white/5 text-sm text-zinc-400 leading-relaxed",children:"We've successfully verified your company in the KBO registry."})]})]}),l&&(0,r.jsxs)("div",{className:"text-xs text-zinc-500 ml-1 flex items-center gap-1",children:[(0,r.jsx)("span",{className:"text-primary-500/50",children:"●"}),l.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})]})]})]})})})},q=e=>{let{suggestions:t,onSelect:s}=e,[n,i]=(0,a.useState)(!1),o=e=>{"none"===e&&i(!0),s(e)};return n?null:(0,r.jsxs)("div",{className:"mt-4 space-y-2",children:[(0,r.jsx)("div",{className:"text-xs text-zinc-400 mb-3",children:"Select a company from the list below:"}),(0,r.jsx)("div",{className:"space-y-2",children:t.map(e=>(0,r.jsx)("button",{onClick:()=>o(e.number.toString()),className:"w-full text-left group relative","aria-label":"Select ".concat(e.companyName),children:(0,r.jsxs)("div",{className:"flex items-start gap-3 p-3 bg-zinc-800/50 border border-zinc-700/50 rounded-lg hover:border-primary-500/50 hover:bg-zinc-800/70 transition-all duration-200 cursor-pointer",children:[(0,r.jsx)("div",{className:"flex-shrink-0 w-8 h-8 bg-primary-600/20 text-primary-400 rounded-full flex items-center justify-center text-sm font-semibold",children:e.number}),(0,r.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)(A.Z,{className:"w-4 h-4 text-zinc-400 flex-shrink-0"}),(0,r.jsx)("span",{className:"font-semibold text-white group-hover:text-primary-300 transition-colors",children:e.companyName})]}),e.registrationNumber&&(0,r.jsx)("div",{className:"text-xs text-zinc-400 mt-1 ml-6",children:e.registrationNumber})]}),(0,r.jsx)("div",{className:"flex-shrink-0 opacity-0 group-hover:opacity-100 transition-opacity",children:(0,r.jsx)("div",{className:"w-2 h-2 bg-primary-500 rounded-full"})})]})},e.number))}),(0,r.jsx)("button",{onClick:()=>o("none"),className:"w-full mt-3 p-3 bg-zinc-800/30 border border-zinc-700/30 rounded-lg hover:border-zinc-600 hover:bg-zinc-800/50 transition-all duration-200 text-center","aria-label":"None of these companies match",children:(0,r.jsxs)("div",{className:"flex items-center justify-center gap-2 text-sm text-zinc-300 hover:text-white",children:[(0,r.jsx)(D.Z,{className:"w-4 h-4"}),(0,r.jsx)("span",{children:"None of these match"})]})})]})};var B=s(45348),Z=s(33907),K=s(71935);let W=e=>{let{suggestions:t,originalValue:s,onSelect:a,onDismiss:n}=e;return(0,r.jsxs)("div",{className:"suggestion-chips-container my-4",children:[(0,r.jsxs)(S.E.div,{initial:{opacity:0,y:5},animate:{opacity:1,y:0},className:"flex items-center gap-2.5 mb-3",children:[(0,r.jsx)("div",{className:"w-6 h-6 rounded-full bg-primary-500/10 border border-primary-500/20 flex items-center justify-center shadow-[0_0_10px_rgba(59,130,246,0.1)]",children:(0,r.jsx)(Z.Z,{className:"w-3.5 h-3.5 text-primary-400"})}),(0,r.jsx)("p",{className:"text-[13px] font-medium text-zinc-400 tracking-wide",children:"Did you mean one of these?"})]}),(0,r.jsx)("div",{className:"flex flex-wrap gap-2.5 ml-1",children:(0,r.jsxs)(B.M,{mode:"popLayout",children:[t.map((e,t)=>(0,r.jsxs)(S.E.button,{initial:{opacity:0,scale:.9,y:10},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.9},transition:{delay:.05*t,duration:.2},onClick:()=>a(e.text),className:"group relative flex items-center gap-2.5 px-4 py-2.5 bg-zinc-800/40 border border-white/5 rounded-xl hover:bg-zinc-800/80 hover:border-primary-500/30 active:scale-[0.98] transition-all duration-200 shadow-sm hover:shadow-[0_4px_12px_rgba(0,0,0,0.2)] backdrop-blur-sm",children:[(0,r.jsx)("span",{className:"text-[14px] font-medium text-zinc-200 group-hover:text-white transition-colors",children:e.text}),e.confidence>.9&&(0,r.jsx)("span",{className:"flex items-center justify-center w-4 h-4 rounded-full bg-moss-500/10",children:(0,r.jsx)(E.Z,{className:"w-3 h-3 text-moss-400"})}),(0,r.jsx)(R.Z,{className:"w-3.5 h-3.5 text-primary-400 opacity-0 -ml-2 group-hover:opacity-100 group-hover:ml-0 transition-all duration-200"}),(0,r.jsxs)("div",{className:"absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-1.5 bg-zinc-900 text-zinc-300 text-xs font-medium rounded-lg opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none border border-white/10 shadow-xl z-10",children:[e.reason,(0,r.jsx)("div",{className:"absolute top-full left-1/2 transform -translate-x-1/2 -mt-1 border-4 border-transparent border-t-zinc-900"})]})]},"suggestion-".concat(t))),s&&s.trim().length>0&&(0,r.jsxs)(S.E.button,{initial:{opacity:0,scale:.9,y:10},animate:{opacity:1,scale:1,y:0},transition:{delay:.05*t.length,duration:.2},onClick:n,className:"flex items-center gap-2 px-4 py-2.5 bg-transparent border border-white/5 rounded-xl hover:bg-white/5 hover:border-white/10 active:scale-[0.98] transition-all duration-200 group",children:[(0,r.jsxs)("span",{className:"text-[13px] font-medium text-zinc-500 group-hover:text-zinc-300 transition-colors",children:['Keep "',s,'"']}),(0,r.jsx)(K.Z,{className:"w-3.5 h-3.5 text-zinc-600 group-hover:text-zinc-400 transition-colors"})]},"keep-original")]})})]})};function G(e){let t;let s=[],r=/(\d+)\.\s+(.+?)(?:\n|$)/g;for(;null!==(t=r.exec(e));){let e=t[2].trim();if(e.length>1&&!e.toLowerCase().includes("best describes")){let r=e.charAt(0),a=/[\u{1F300}-\u{1F9FF}]/u.test(r),n=a?e.slice(1).trim():e,i=a?r:void 0;s.push({number:parseInt(t[1],10),id:t[1],title:n,icon:i})}}return s}function $(e){let t=/business type|Which one best describes/i.test(e),s=/\d+\.\s+.+?(?:\n|$)/i.test(e);return t&&s}function Y(e){let t;let s=[],r=/(\d+)\.\s+\*\*(.+?)\*\*(?:\s+\(([^)]+)\))?/g;for(;null!==(t=r.exec(e));){let e=t[2].trim();if(e.length>1&&!e.toLowerCase().includes("did you mean")){var a;s.push({number:parseInt(t[1],10),companyName:e,registrationNumber:null===(a=t[3])||void 0===a?void 0:a.trim()})}}return s}function J(e){let t=/KBO registry|Did you mean/i.test(e),s=/\d+\.\s+\*\*.*\*\*/i.test(e);return t&&s}let X=e=>{let{question:t,buttonText:s="Create Valuation Report",onConfirm:a,timestamp:n}=e;return(0,r.jsx)(S.E.div,{initial:{opacity:0,y:10,scale:.98},animate:{opacity:1,y:0,scale:1},transition:{duration:.3,ease:"easeOut"},className:"flex justify-start",children:(0,r.jsx)("div",{className:"max-w-[85%] mr-auto",children:(0,r.jsxs)("div",{className:"flex items-start gap-3",children:[(0,r.jsx)("div",{className:"flex-shrink-0 w-8 h-8 bg-white/10 rounded-full flex items-center justify-center border border-white/10 shadow-sm mt-1",children:(0,r.jsx)(C.Z,{className:"w-4 h-4 text-primary-400"})}),(0,r.jsxs)("div",{className:"flex flex-col gap-1 flex-1",children:[(0,r.jsxs)("div",{className:"rounded-2xl rounded-tl-sm px-6 py-5 bg-white/5 text-white border border-white/10 shadow-sm backdrop-blur-sm",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2 mb-4 pb-3 border-b border-white/10",children:[(0,r.jsx)(E.Z,{className:"w-5 h-5 text-primary-400"}),(0,r.jsx)("span",{className:"text-sm font-semibold text-primary-400 uppercase tracking-wider",children:"Ready for Valuation"})]}),(0,r.jsx)("div",{className:"whitespace-pre-wrap text-[15px] leading-relaxed text-zinc-100 mb-5",children:t}),(0,r.jsxs)("button",{onClick:a,className:"w-full py-4 px-6 bg-gradient-to-r from-primary-600 to-primary-500 hover:from-primary-500 hover:to-primary-400 text-white rounded-xl font-semibold text-base shadow-lg hover:shadow-xl hover:shadow-primary-500/30 transition-all duration-200 flex items-center justify-center gap-3 active:scale-[0.98] focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 group",children:[(0,r.jsx)(M.Z,{className:"w-5 h-5 group-hover:scale-110 transition-transform"}),(0,r.jsx)("span",{children:s}),(0,r.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",strokeLinecap:"round",strokeLinejoin:"round",className:"group-hover:translate-x-1 transition-transform",children:[(0,r.jsx)("line",{x1:"5",y1:"12",x2:"19",y2:"12"}),(0,r.jsx)("polyline",{points:"12 5 19 12 12 19"})]})]}),(0,r.jsx)("div",{className:"mt-4 pt-4 border-t border-primary-400/10",children:(0,r.jsxs)("div",{className:"flex items-center justify-between text-xs text-zinc-400",children:[(0,r.jsx)("span",{children:"Estimated completion time: 2-3 minutes"}),(0,r.jsx)("span",{className:"text-primary-400",children:"● All data collected"})]})})]}),n&&(0,r.jsxs)("div",{className:"text-xs text-zinc-500 ml-1 flex items-center gap-1",children:[(0,r.jsx)("span",{className:"text-primary-400",children:"●"}),n.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})]})]})]})})})},Q=a.memo(e=>{var t,s,n;let{message:i,onSuggestionSelect:o,onSuggestionDismiss:l,onClarificationConfirm:c,onClarificationReject:d,onKBOSuggestionSelect:u,onValuationStart:p,isTyping:h=!1,isThinking:g=!1}=e,f=(0,a.useCallback)((e,t)=>{var s;let r=i.metadata;return null!==(s=null==r?void 0:r[e])&&void 0!==s?s:t},[i.metadata]),x=(0,a.useCallback)(function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";return f(e,t)||t},[f]),v=(e,t)=>f(e,t),b=!0===f("is_ai_help"),y=f("ai_response"),_="cta_button"===x("input_type"),w=x("button_text","Create Valuation Report"),k=a.useMemo(()=>i.content?i.content.replace(/<span class="[^"]*animate-pulse[^"]*"><\/span>/g,"").trimEnd():i.content,[i.content]),j=a.useMemo(()=>{let e=x("clarification_message");return e&&$(e)?G(e):$(i.content)?G(i.content):null},[i.content,x]),I=null!==j&&j.length>0,M=(0,a.useCallback)(()=>I&&j?(0,r.jsx)("div",{className:"mt-3",children:(0,r.jsx)(V,{suggestions:j,onSelect:u})}):null,[I,j,u]),R=a.useMemo(()=>{let e=x("clarification_message");return e&&J(e)?Y(e):J(i.content)?Y(i.content):null},[i.content,x]),z=null!==R&&R.length>0;if(b&&y)return(0,r.jsx)(T,{answer:x("answer",y.answer)||i.content,reasoning:x("reasoning",y.reasoning),example:x("example",y.example),nudge:x("nudge",y.nudge)||"",timestamp:i.timestamp});if(_)return(0,r.jsx)(X,{question:k,buttonText:w,onConfirm:()=>{"valuation_confirmed"===x("clarification_field")&&p&&p(),c(i.id)},timestamp:i.timestamp});if(!0===f("is_business_type_confirmation")){let e=x("industry_mapping")||x("industry")||void 0;return(0,r.jsx)(O,{businessType:x("business_type",""),industry:e,category:x("category"),icon:x("icon"),confidence:v("confidence"),timestamp:i.timestamp})}return!0===f("is_company_name_confirmation")?(m.Z.log("[MessageItem]","Rendering CompanyNameConfirmationCard",{companyName:x("company_name")||i.content||"",registrationNumber:x("registration_number"),legalForm:x("legal_form"),hasMetadata:!!i.metadata,metadataKeys:i.metadata?Object.keys(i.metadata):[]}),(0,r.jsx)(F,{companyName:x("company_name")||i.content||"",registrationNumber:x("registration_number"),legalForm:x("legal_form"),foundingYear:v("founding_year"),industryDescription:x("industry_description"),confidence:v("confidence"),timestamp:i.timestamp})):(0,r.jsx)(S.E.div,{initial:{opacity:0,y:10,scale:.98},animate:{opacity:1,y:0,scale:1},transition:{duration:.3,ease:"easeOut"},className:"flex ".concat("user"===i.type?"justify-end":"justify-start"),children:(0,r.jsx)("div",{className:"max-w-[85%] ".concat("user"===i.type?"ml-auto":"mr-auto"),children:"user"===i.type?(0,r.jsxs)("div",{className:"flex flex-col gap-1 items-end",children:[(0,r.jsx)("div",{className:"rounded-2xl rounded-tr-sm px-5 py-3.5 bg-primary-600 text-white shadow-md",children:(0,r.jsx)("div",{className:"whitespace-pre-wrap text-[15px] leading-relaxed font-medium",children:i.content})}),(0,r.jsx)("div",{className:"text-xs text-zinc-500 text-right pr-1",children:i.timestamp.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]}):(0,r.jsxs)("div",{className:"flex items-start gap-3",children:[(0,r.jsx)("div",{className:"flex-shrink-0 w-8 h-8 bg-white/10 rounded-full flex items-center justify-center border border-white/10 shadow-sm mt-1",children:i.isStreaming||h||g?(0,r.jsx)(N.Z,{className:"w-4 h-4 text-primary-400 animate-spin"}):(0,r.jsx)(C.Z,{className:"w-4 h-4 text-primary-400"})}),(0,r.jsxs)("div",{className:"flex flex-col gap-1",children:[(0,r.jsxs)("div",{className:"rounded-2xl rounded-tl-sm px-5 py-3.5 bg-white/5 text-white border border-white/10 shadow-sm backdrop-blur-sm",children:[(0,r.jsx)("div",{className:"whitespace-pre-wrap text-[15px] leading-relaxed text-zinc-100",children:k}),"suggestion"===i.type&&f("suggestions")&&(0,r.jsx)("div",{className:"mt-4",children:(0,r.jsx)(W,{suggestions:(f("suggestions")||[]).map(e=>({text:(null==e?void 0:e.text)||"",confidence:(null==e?void 0:e.confidence)||0,reason:(null==e?void 0:e.reason)||""})),originalValue:x("originalValue",""),onSelect:o,onDismiss:l})}),M(),(()=>{var e,t;let s=(null===(e=i.content)||void 0===e?void 0:e.includes("No problem!"))&&(null===(t=i.content)||void 0===t?void 0:t.includes("What's your company name?"));return z&&R&&!s&&(0,r.jsx)("div",{className:"mt-3",children:(0,r.jsx)(q,{suggestions:R,onSelect:u})})})(),(null===(t=i.metadata)||void 0===t?void 0:t.needs_confirmation)&&!z&&!I&&(null===(s=i.metadata)||void 0===s?void 0:s.collected_field)!=="business_type"&&(null===(n=i.metadata)||void 0===n?void 0:n.collected_field)!=="company_name"&&(0,r.jsxs)(S.E.div,{initial:{opacity:0,y:5},animate:{opacity:1,y:0},transition:{delay:.2},className:"flex flex-col gap-2 mt-4 p-3 bg-white/5 rounded-xl border border-white/10",children:[(0,r.jsx)("p",{className:"text-xs text-zinc-400 font-medium uppercase tracking-wider mb-1",children:"Confirm Details"}),(0,r.jsxs)("div",{className:"flex gap-3",children:[(0,r.jsxs)("button",{onClick:()=>c(i.id),className:"flex-1 py-2.5 px-4 bg-primary-600/20 hover:bg-primary-600/30 border border-primary-500/30 hover:border-primary-500/50 text-primary-300 rounded-lg text-sm font-medium transition-all flex items-center justify-center gap-2 active:scale-[0.98]",children:[(0,r.jsx)(E.Z,{className:"h-4 w-4"}),"Yes, that's correct"]}),(0,r.jsx)("button",{onClick:()=>d(i.id),className:"px-4 py-2.5 bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 hover:border-zinc-600 text-zinc-400 hover:text-zinc-300 rounded-lg text-sm font-medium transition-all active:scale-[0.98]",children:"No, edit"})]})]}),L.showHelpText&&x("help_text")&&(0,r.jsx)("div",{className:"mt-3 pt-3 border-t border-white/10",children:(0,r.jsxs)("p",{className:"text-xs text-zinc-400 flex items-start gap-1.5",children:[(0,r.jsx)("span",{className:"mt-0.5",children:"ℹ️"}),(0,r.jsx)("span",{className:"leading-relaxed",children:x("help_text")})]})}),L.showNarratives&&x("valuation_narrative")&&(0,r.jsxs)("div",{className:"mt-3 p-3 bg-primary-600/10 rounded-xl border border-primary-600/20",children:[(0,r.jsx)("h4",{className:"text-xs font-semibold text-primary-300 mb-1 uppercase tracking-wider",children:"Valuation Insight"}),(0,r.jsx)("div",{className:"text-sm text-zinc-300 whitespace-pre-wrap leading-relaxed",children:x("valuation_narrative")})]})]}),(0,r.jsx)("div",{className:"text-xs text-zinc-500 ml-1",children:i.timestamp.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]})]})})})});Q.displayName="MessageItem";let ee=()=>(0,r.jsxs)(S.E.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,scale:.95},className:"max-w-[80%] mr-auto",children:[(0,r.jsxs)("div",{className:"flex items-start gap-3",children:[(0,r.jsx)("div",{className:"flex-shrink-0 w-8 h-8 bg-white/10 rounded-full flex items-center justify-center border border-white/10 shadow-sm",children:(0,r.jsx)(C.Z,{className:"w-4 h-4 text-primary-400"})}),(0,r.jsx)("div",{className:"rounded-2xl rounded-tl-sm px-5 py-3.5 bg-white/5 text-white border border-white/10 shadow-sm backdrop-blur-sm",children:(0,r.jsxs)("div",{className:"flex items-center gap-3",children:[(0,r.jsx)("div",{className:"flex gap-1.5 h-2 items-center",children:[0,1,2].map(e=>(0,r.jsx)(S.E.span,{className:"w-1.5 h-1.5 bg-primary-400/80 rounded-full",animate:{y:["0%","-40%","0%"],opacity:[.4,1,.4],scale:[.9,1.1,.9]},transition:{duration:.8,repeat:1/0,ease:"easeInOut",delay:.12*e}},e))}),(0,r.jsx)("span",{className:"text-[13px] font-medium text-zinc-400 tracking-wide",children:"AI is thinking..."})]})})]}),(0,r.jsx)("div",{className:"text-xs text-zinc-500 mt-1 text-left ml-11",children:new Date().toLocaleTimeString()})]}),et=e=>{var t;let{messages:s,isTyping:a,isThinking:n,isInitializing:i,onSuggestionSelect:o,onSuggestionDismiss:l,onClarificationConfirm:c,onClarificationReject:d,onKBOSuggestionSelect:u,onValuationStart:m,calculateOption:p,valuationPreview:h,messagesEndRef:g}=e;return(0,r.jsxs)("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:[(0,r.jsx)(B.M,{initial:!1,mode:"popLayout",children:s.filter(e=>{var t,s;return(null===(t=e.metadata)||void 0===t?void 0:t.is_business_type_confirmation)===!0||(null===(s=e.metadata)||void 0===s?void 0:s.is_company_name_confirmation)===!0||e.content&&e.content.trim().length>0}).map(e=>(0,r.jsx)(Q,{message:e,onSuggestionSelect:o,onSuggestionDismiss:l,onClarificationConfirm:c,onClarificationReject:d,onKBOSuggestionSelect:u,onValuationStart:m,isTyping:a,isThinking:n},e.id))}),(0,r.jsx)(B.M,{children:(a||i&&0===s.length)&&(0,r.jsx)("div",{className:"flex justify-start",children:(0,r.jsx)(ee,{})},"typing-indicator")}),p&&(0,r.jsx)("div",{className:"flex justify-center",children:(0,r.jsx)("button",{onClick:()=>{},className:"px-6 py-2 bg-accent-600 text-white rounded-lg hover:bg-accent-500 transition-colors",children:"Calculate Now"})}),h&&(0,r.jsxs)("div",{className:"bg-primary-600/10 p-4 rounded-lg border border-primary-600/30",children:[(0,r.jsx)("h3",{className:"font-semibold text-primary-300 mb-2",children:"Valuation Preview"}),(0,r.jsxs)("div",{className:"text-2xl font-bold text-primary-200",children:["$",null===(t=h.value)||void 0===t?void 0:t.toLocaleString()]})]}),(0,r.jsx)("div",{ref:g})]})},es=e=>{let{sessionId:t,userId:s,onMessageComplete:o,onValuationComplete:l,onValuationStart:c,onReportUpdate:d,onDataCollected:m,onValuationPreview:p,onCalculateOptionAvailable:h,onProgressUpdate:g,onReportSectionUpdate:b,onSectionLoading:S,onSectionComplete:N,onReportComplete:C,onContextUpdate:E,onHtmlPreviewUpdate:L,onPythonSessionIdReceived:I,className:M="",disabled:R=!1,initialMessage:T=null,autoSend:z=!1,initialData:A,initialMessages:P=[],isRestoring:O=!1,isSessionInitialized:D=!1,pythonSessionId:V,isRestorationComplete:H=!1}=e,{user:U}=(0,v.a)(),[F,q]=a.useState(null),B=null!=V?V:F,Z=(0,a.useCallback)(e=>{q(e),e&&I&&I(e)},[I]);(0,a.useEffect)(()=>{void 0!==V&&V!==F&&q(V)},[V,F]);let K=w(t,s),W=function(e){let{sessionId:t,messages:s,setMessages:r,onMessageComplete:i}=e,o=(0,a.useMemo)(()=>new n.U,[]),l=(0,a.useCallback)(e=>{let t=null==e?void 0:e.metadata;if(!t)return!1;let s=t.collected_field||t.clarification_field||t.field;return"cta_button"===t.input_type&&"valuation_confirmed"===s},[]),c=(0,a.useCallback)((e,t)=>l(t)?e.filter(e=>!l(e)):e,[l]);return{addMessage:(0,a.useCallback)(e=>{let t=c(s,e),a=o.addMessage(t,e);return r(a.updatedMessages),a},[s,r,c,o]),updateStreamingMessage:(0,a.useCallback)((e,t,a)=>{let n=s.find(e=>e.isStreaming&&!e.isComplete),l=(null==n?void 0:n.id)||"",c=o.updateStreamingMessage(s,l,e,null!=t&&t,a);if(r(c),t){let e=c.find(e=>"ai"===e.type&&e.isComplete&&!e.isStreaming);e&&i&&i(e)}},[s,r,o,i]),dedupeValuationCTA:c,isValuationReadyCTA:l}}({sessionId:t,messages:K.messages,setMessages:K.setMessages,onMessageComplete:o}),{suggestions:G}=function(e){let{messages:t}=e,s=e=>{switch(e){case"business_type":return["SaaS Platform","E-commerce Store","Consulting Firm","Digital Agency"];case"revenue":return["$1M - $5M ARR","$5M - $10M ARR","$10M - $50M ARR","$50M+ ARR"];case"employee_count":return["1-10 team","11-50 team","51-200 team","200+ team"];case"industry":return["Technology","Healthcare","Finance","Retail","Manufacturing"];case"country_code":return["United States","United Kingdom","Germany","France","Canada"];default:return[]}};return{suggestions:(0,a.useMemo)(()=>{if(0===t.length)return[];let e=t[t.length-1];if((null==e?void 0:e.type)==="ai"&&e.metadata){let t=e.metadata,r=t.collected_field||t.clarification_field||t.field;if(r)return s(r)}return[]},[t,s]),getSuggestionsForField:s}}({messages:K.messages}),$=function(e){let{sessionId:t,userId:s,messages:r,setMessages:n,setIsStreaming:o,setIsTyping:l,setIsThinking:c,setTypingContext:d,setCollectedData:m,setValuationPreview:p,setCalculateOption:h,updateStreamingMessage:g,onValuationComplete:v,onReportUpdate:b,onDataCollected:y,onValuationPreview:_,onCalculateOptionAvailable:w,onProgressUpdate:k,onReportSectionUpdate:j,onSectionLoading:S,onSectionComplete:N,onReportComplete:C,onHtmlPreviewUpdate:E}=e,L=(0,a.useRef)(null),I=(0,a.useRef)(null);return(0,a.useRef)(null),(0,a.useEffect)(()=>{let e={current:null},s={current:null};return L.current=new f({current:null},{current:null}),I.current=new u(t,{updateStreamingMessage:g,setIsStreaming:o,setIsTyping:l,setIsThinking:c,setTypingContext:d,setCollectedData:m,setValuationPreview:p,setCalculateOption:h,addMessage:e=>(n(t=>[...t,{...e,id:"msg-".concat(Date.now()),timestamp:new Date}]),{updatedMessages:[],newMessage:{}}),onValuationComplete:v,onReportUpdate:b,onDataCollected:y,onValuationPreview:_,onCalculateOptionAvailable:w,onProgressUpdate:k,onReportSectionUpdate:j,onSectionLoading:S,onSectionComplete:N,onReportComplete:C,onHtmlPreviewUpdate:E,trackModelPerformance:trackModelPerformance||(()=>{}),trackConversationCompletion:trackConversationCompletion||(()=>{})}),()=>{e.current&&e.current.close(),s.current&&s.current.abort()}},[t,n,o,l,c,d,m,p,h,g,v,b,y,_,w,k,j,S,N,C,E]),{startStreaming:(0,a.useCallback)(async e=>{if(!L.current||!I.current)throw Error("Streaming coordinator not initialized");if(!e||!e.trim()){i.pL.warn("Attempted to start streaming with empty input",{sessionId:t});return}let r={setIsStreaming:o,addMessage:e=>(n(t=>[...t,{...e,id:"msg-".concat(Date.now()),timestamp:new Date}]),{updatedMessages:[],newMessage:{}}),updateStreamingMessage:g,extractBusinessModelFromInput:x.Cz,extractFoundingYearFromInput:x.tM,onStreamStart:()=>{var e;null===(e=I.current)||void 0===e||e.reset()}},a=e=>{i.pL.error("Streaming error",{error:e.message,sessionId:t,stack:e.stack}),o(!1),n(t=>[...t,{id:"error-".concat(Date.now()),type:"system",content:"Error: ".concat(e.message),timestamp:new Date}])};try{o(!0),I.current.reset(),await L.current.startStreaming(t,e,s,r,e=>{try{var s;null===(s=I.current)||void 0===s||s.handleEvent(e)}catch(e){i.pL.error("Error handling streaming event",{error:e instanceof Error?e.message:String(e),sessionId:t})}},a)}catch(e){throw o(!1),e instanceof Error&&a(e),e}},[t,s,o,n,g,onContextUpdate]),stopStreaming:(0,a.useCallback)(()=>{L.current&&L.current.clearCurrentRequest(),o(!1)},[o]),isStreaming:!1}}({sessionId:t,userId:null!=s?s:null==U?void 0:U.id,messages:K.messages,setMessages:K.setMessages,setIsStreaming:K.setIsStreaming,setIsTyping:K.setIsTyping,setIsThinking:K.setIsThinking,setTypingContext:K.setTypingContext,setCollectedData:K.setCollectedData,setValuationPreview:K.setValuationPreview,setCalculateOption:K.setCalculateOption,updateStreamingMessage:W.updateStreamingMessage,onValuationComplete:l,onReportUpdate:d,onDataCollected:m,onValuationPreview:p,onCalculateOptionAvailable:h,onProgressUpdate:g,onReportSectionUpdate:b,onSectionLoading:S,onSectionComplete:N,onReportComplete:C,onHtmlPreviewUpdate:L,trackModelPerformance:()=>{},trackConversationCompletion:()=>{}}),Y=(0,a.useCallback)(async e=>{let s=null!=e?e:K.input;if(!s||!s.trim()){i.pL.warn("Attempted to submit empty input",{sessionId:t});return}try{W.addMessage({type:"user",content:s.trim(),role:"user"}),K.setInput(""),await $.startStreaming(s.trim())}catch(e){i.pL.error("Stream submission failed",{error:e,sessionId:t}),K.setIsStreaming(!1)}},[K.input,K.setInput,K.setIsStreaming,$,W,t]),J={handleSuggestionSelect:(0,a.useCallback)(e=>{K.setInput(e),Y(e)},[K.setInput,Y]),handleSuggestionDismiss:(0,a.useCallback)(()=>{},[]),handleClarificationConfirm:(0,a.useCallback)(e=>{K.setInput("Yes"),Y("Yes")},[K.setInput,Y]),handleClarificationReject:(0,a.useCallback)(e=>{K.setInput("No"),Y("No")},[K.setInput,Y]),handleKBOSuggestionSelect:(0,a.useCallback)(e=>{K.setInput(e),Y(e)},[K.setInput,Y])},X=(0,a.useRef)("");(0,a.useEffect)(()=>{if(P&&P.length>0){let e=P.map(e=>e.id).join(",");(0===K.messages.length||X.current!==e)&&(i.pL.info("✅ Restoring conversation messages in StreamingChat",{sessionId:t,messagesCount:P.length,fingerprint:e}),K.setMessages(P),X.current=e)}},[P,t,K.messages.length,K.setMessages]);let{isInitializing:Q}=y(t,s,{addMessage:W.addMessage,setMessages:K.setMessages,getCurrentMessages:()=>K.messages,user:U,initialData:A,initialMessages:P,isRestoring:O,isSessionInitialized:D,pythonSessionId:B,isRestorationComplete:H,onSessionIdUpdate:Z}),{trackModelPerformance:ee,trackConversationCompletion:es}=_(t,s),{complete:er}=k({baseSpeed:50,adaptiveSpeed:!0,punctuationPauses:!0,showCursor:!0}),ea=(0,a.useCallback)(async e=>{if(e&&e.preventDefault(),K.input.trim())try{await Y()}catch(e){i.pL.error("Stream submission failed",{error:e,sessionId:t})}},[K.input,Y,t]);return(0,r.jsxs)("div",{className:"flex h-full flex-col overflow-hidden flex-1 ".concat(M),children:[(0,r.jsx)(et,{messages:K.messages,isTyping:K.isTyping,isThinking:K.isThinking,isInitializing:Q,onSuggestionSelect:J.handleSuggestionSelect,onSuggestionDismiss:J.handleSuggestionDismiss,onClarificationConfirm:J.handleClarificationConfirm,onClarificationReject:J.handleClarificationReject,onKBOSuggestionSelect:J.handleKBOSuggestionSelect,onValuationStart:c,calculateOption:K.calculateOption,valuationPreview:K.valuationPreview,messagesEndRef:K.refs.messagesEndRef}),(0,r.jsx)(j,{input:K.input,onInputChange:K.setInput,onSubmit:ea,isStreaming:K.isStreaming,disabled:R,placeholder:"Ask about your business valuation...",suggestions:G})]})};var er=es},50553:function(e,t,s){var r,a,n,i,o,l;s.d(t,{vu:function(){return a}}),(i=r||(r={})).TECHNOLOGY="technology",i.MANUFACTURING="manufacturing",i.RETAIL="retail",i.SERVICES="services",i.HEALTHCARE="healthcare",i.FINANCE="finance",i.REAL_ESTATE="real_estate",i.HOSPITALITY="hospitality",i.CONSTRUCTION="construction",i.OTHER="other",(o=a||(a={})).B2B_SAAS="b2b_saas",o.B2C="b2c",o.MARKETPLACE="marketplace",o.ECOMMERCE="ecommerce",o.MANUFACTURING="manufacturing",o.SERVICES="services",o.OTHER="other",(l=n||(n={})).PENDING="pending",l.EXECUTING="executing",l.COMPLETED="completed",l.SKIPPED="skipped",l.FAILED="failed"}}]);