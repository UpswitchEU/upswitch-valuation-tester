"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[61],{61:function(e,t,s){s.r(t),s.d(t,{ConversationalLayout:function(){return eZ}});var n,a,r,i,l,o,c=s(57437),d=s(2265),u=s(44134),m=s(71106),p=s(74697),h=s(54887);let g=e=>{let{isOpen:t,onClose:s,title:n="Valuation Report",children:a}=e;if((0,d.useEffect)(()=>{let e=e=>{"Escape"===e.key&&s()};if(t){document.addEventListener("keydown",e);let t=document.body.style.overflow,s=document.body.style.paddingRight,n=window.innerWidth-document.documentElement.clientWidth;return document.body.style.overflow="hidden",n>0&&(document.body.style.paddingRight="".concat(n,"px")),()=>{document.removeEventListener("keydown",e),document.body.style.overflow=t,document.body.style.paddingRight=s}}return()=>{document.removeEventListener("keydown",e)}},[t,s]),!t)return null;let r=(0,c.jsxs)("div",{className:"fixed inset-0 z-50 flex items-center justify-center",children:[(0,c.jsx)("div",{className:"absolute inset-0 bg-black/80",onClick:s}),(0,c.jsxs)("div",{className:"relative w-full h-full bg-zinc-950 flex flex-col",children:[(0,c.jsxs)("div",{className:"flex items-center justify-between p-4 border-b border-zinc-800 bg-zinc-900",children:[(0,c.jsxs)("div",{className:"flex items-center gap-3",children:[(0,c.jsx)(m.Z,{className:"w-5 h-5 text-blue-400"}),(0,c.jsx)("h2",{className:"text-xl font-semibold text-white",children:n})]}),(0,c.jsx)("button",{onClick:s,className:"p-2 rounded-lg hover:bg-zinc-800 transition-colors text-zinc-400 hover:text-white",title:"Close (ESC)",children:(0,c.jsx)(p.Z,{className:"w-5 h-5"})})]}),(0,c.jsx)("div",{className:"flex-1 overflow-auto",style:{WebkitOverflowScrolling:"touch",overscrollBehavior:"contain"},children:a})]})]});return"undefined"!=typeof document&&document.body?(0,h.createPortal)(r,document.body):r},f={MIN_WIDTH:20,MAX_WIDTH:50,DEFAULT_WIDTH:35},x=e=>{let{onResize:t,leftWidth:s,isMobile:n=!1}=e,[a,r]=(0,d.useState)(!1),i=(0,d.useRef)(!1),l=(0,d.useRef)(null),o=(0,d.useRef)(0),u=(0,d.useRef)(0),m=e=>{var s,n;let a=(null===(n=l.current)||void 0===n?void 0:null===(s=n.parentElement)||void 0===s?void 0:s.offsetWidth)||100,r=e.clientX-o.current,i=u.current+r/a*100;t(Math.max(f.MIN_WIDTH,Math.min(f.MAX_WIDTH,i)))},p=()=>{i.current=!1,r(!1),document.removeEventListener("mousemove",m),document.removeEventListener("mouseup",p)};return n?null:(0,c.jsxs)("div",{ref:l,className:"w-[1px] bg-zinc-800 cursor-col-resize flex items-center justify-center transition-all duration-150 ease-in-out relative group",onMouseDown:e=>{!n&&(i.current||(e.preventDefault(),i.current=!0,r(!0),o.current=e.clientX,u.current=s,document.addEventListener("mousemove",m),document.addEventListener("mouseup",p)))},style:{backgroundColor:a?"#71717a":void 0},children:[(0,c.jsx)("div",{className:"absolute inset-y-0 -left-2 -right-2 hover:bg-zinc-800/10"}),(0,c.jsx)("div",{className:"absolute top-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-100 transition-opacity duration-200",children:(0,c.jsxs)("div",{className:"flex flex-col gap-1",children:[(0,c.jsx)("div",{className:"w-[2px] h-[2px] rounded-full bg-zinc-500"}),(0,c.jsx)("div",{className:"w-[2px] h-[2px] rounded-full bg-zinc-500"}),(0,c.jsx)("div",{className:"w-[2px] h-[2px] rounded-full bg-zinc-500"})]})})]})};var y=s(55513),v=s(30761),b=s(46854);class _{}_.root=()=>"/",_.home=()=>"/home",_.reports=()=>"/reports",_.reportById=e=>"/reports/".concat(e),_.createNewReport=()=>"/reports/new",_.legacyManual=()=>"/manual",_.legacyAIGuided=()=>"/ai-guided",_.legacyInstant=()=>"/instant",_.privacy=()=>"/privacy",_.about=()=>"/about",_.howItWorks=()=>"/how-it-works",_.notFound=()=>"/404";var w=s(38691);function N(e){let t={};return e.forEach(e=>{let s=e.fieldId,n=e.value;switch(s){case"revenue":case"ebitda":case"number_of_employees":case"founding_year":if("string"==typeof n){let e=parseFloat(n.replace(/[^\d.-]/g,""));n=isNaN(e)?n:e}break;case"country_code":case"industry":case"company_name":case"legal_form":n=String(n);break;case"has_historical_data":case"is_profitable":"string"==typeof n&&(n="true"===n.toLowerCase()||"yes"===n.toLowerCase())}(s in t||void 0!==n)&&(t[s]=n)}),t}var j=s(69419),S=s(13184),k=s(25903);let C=e=>{let{children:t,showOutOfCreditsModal:s,onCloseModal:n,onSignUp:a,onTryManual:r}=e;return(0,c.jsxs)(c.Fragment,{children:[t,(0,c.jsx)(k.o,{isOpen:s,onClose:n,onSignUp:a,onTryManual:r})]})};function E(){let e=function(){let{dispatch:e}=L();return e}(),t=(0,d.useCallback)(t=>{e({type:"SET_SESSION_ID",payload:t})},[e]),s=(0,d.useCallback)(t=>{e({type:"SET_PYTHON_SESSION_ID",payload:t})},[e]),n=(0,d.useCallback)(t=>{e({type:"SET_RESTORED",payload:t})},[e]),a=(0,d.useCallback)(t=>{e({type:"SET_LOADING",payload:t})},[e]),r=(0,d.useCallback)(t=>{e({type:"SET_INITIALIZED",payload:t})},[e]),i=(0,d.useCallback)(t=>{e({type:"SET_ERROR",payload:t})},[e]),l=(0,d.useCallback)(t=>{e({type:"ADD_MESSAGE",payload:t})},[e]),o=(0,d.useCallback)(t=>{e({type:"SET_MESSAGES",payload:t})},[e]),c=(0,d.useCallback)(()=>{e({type:"CLEAR_MESSAGES"})},[e]),u=(0,d.useCallback)(t=>{e({type:"SET_VALUATION_RESULT",payload:t})},[e]),m=(0,d.useCallback)(t=>{e({type:"SET_GENERATING",payload:t})},[e]),p=(0,d.useCallback)(t=>{e({type:"SET_BUSINESS_PROFILE",payload:t})},[e]),h=(0,d.useCallback)(t=>{e({type:"SET_PROFILE_LOADING",payload:t})},[e]),g=(0,d.useCallback)(t=>{e({type:"SET_ACTIVE_TAB",payload:t})},[e]),f=(0,d.useCallback)(t=>{e({type:"SET_FULLSCREEN",payload:t})},[e]),x=(0,d.useCallback)(t=>{e({type:"SET_REGENERATION_WARNING",payload:t})},[e]),y=(0,d.useCallback)(t=>{e({type:"SET_PENDING_RESULT",payload:t})},[e]),v=(0,d.useCallback)(e=>{},[]),b=(0,d.useCallback)((t,s,n)=>{e({type:"SET_SESSION_ID",payload:t}),void 0!==s&&e({type:"SET_PYTHON_SESSION_ID",payload:s}),void 0!==n&&e({type:"SET_RESTORED",payload:n}),e({type:"SET_LOADING",payload:!0})},[e]);return{setSessionId:t,setPythonSessionId:s,setRestored:n,setLoading:a,setInitialized:r,setError:i,addMessage:l,setMessages:o,clearMessages:c,setValuationResult:u,setGenerating:m,setBusinessProfile:p,setProfileLoading:h,setActiveTab:g,setFullScreen:f,setRegenerationWarning:x,setPendingResult:y,setShowOutOfCreditsModal:v,initializeSession:b,startConversation:(0,d.useCallback)(t=>{e({type:"SET_BUSINESS_PROFILE",payload:t}),e({type:"SET_LOADING",payload:!1}),e({type:"SET_INITIALIZED",payload:!0}),e({type:"SET_ERROR",payload:null})},[e]),completeValuation:(0,d.useCallback)(t=>{e({type:"SET_VALUATION_RESULT",payload:t}),e({type:"SET_GENERATING",payload:!1}),e({type:"SET_LOADING",payload:!1})},[e]),resetConversation:(0,d.useCallback)(()=>{e({type:"RESET_STATE"})},[e])}}let I=(0,d.createContext)(void 0);function L(){let e=(0,d.useContext)(I);if(void 0===e)throw Error("useConversationContext must be used within a ConversationProvider");return e}function R(){let{state:e}=L();return e}var T=s(74232);function M(e){let t=new Date().getFullYear();return e>=1900&&e<=t}function z(e){let t=e.toLowerCase();for(let[e,s]of Object.entries({[l.B2B_SAAS]:["saas","software as a service","b2b","enterprise software","subscription software"],[l.B2C]:["b2c","consumer","retail","direct to consumer","customer"],[l.MARKETPLACE]:["marketplace","platform","two-sided","multi-sided"],[l.ECOMMERCE]:["ecommerce","e-commerce","online store","online shop","digital store"],[l.MANUFACTURING]:["manufacturing","production","factory","assembly"],[l.SERVICES]:["services","consulting","professional services","service business"]}))if(s.some(e=>t.includes(e)))return e;return null}function A(e){let t=e.match(/\b(19|20)\d{2}\b/);if(t){let e=parseInt(t[0]);return M(e)?e:null}let s=e.match(/(?:founded|started|established)\s+(?:in\s+)?(\d{4})/i);if(s){let e=parseInt(s[1]);return M(e)?e:null}return null}(n=i||(i={})).TECHNOLOGY="technology",n.MANUFACTURING="manufacturing",n.RETAIL="retail",n.SERVICES="services",n.HEALTHCARE="healthcare",n.FINANCE="finance",n.REAL_ESTATE="real_estate",n.HOSPITALITY="hospitality",n.CONSTRUCTION="construction",n.OTHER="other",(a=l||(l={})).B2B_SAAS="b2b_saas",a.B2C="b2c",a.MARKETPLACE="marketplace",a.ECOMMERCE="ecommerce",a.MANUFACTURING="manufacturing",a.SERVICES="services",a.OTHER="other",(r=o||(o={})).PENDING="pending",r.EXECUTING="executing",r.COMPLETED="completed",r.SKIPPED="skipped",r.FAILED="failed";class D{async fetchUserBusinessData(e){try{j.qA.debug("Fetching business profile for user",{userId:e});let t=await fetch("".concat(this.backendUrl,"/api/users/").concat(e,"/business-profile"),{method:"GET",headers:{"Content-Type":"application/json"},credentials:"include"});if(!t.ok){if(404===t.status)return j.qA.info("No business profile found for user",{userId:e}),null;throw Error("Failed to fetch business profile: ".concat(t.statusText))}let s=await t.json();if(!s.success)throw Error(s.error||"Failed to fetch business profile");return j.qA.info("Business profile fetched successfully",{data:s.data}),s.data}catch(t){return j.qA.error("Failed to fetch business data",{userId:e,error:t instanceof Error?t.message:"Unknown error"}),null}}transformToValuationRequest(e){let t={};if(e.company_name&&(t.company_name=e.company_name),e.industry&&(t.industry=e.industry),e.business_type&&(t.business_type=e.business_type),e.country&&(t.country_code=e.country),e.founded_year&&(t.founding_year=e.founded_year),e.revenue_range){let s=this.parseRevenueRange(e.revenue_range);s&&(t.revenue=s)}if(e.employee_count_range){let s=this.parseEmployeeRange(e.employee_count_range);s&&(t.employee_count=s)}return e.company_description&&(t.business_description=e.company_description),e.business_highlights&&(t.business_highlights=e.business_highlights),e.reason_for_selling&&(t.reason_for_selling=e.reason_for_selling),e.city&&(t.city=e.city),t}extractBusinessModel(e){var t,s,n;return e.business_model?(t=e.business_model,({saas:l.B2B_SAAS,software:l.B2B_SAAS,b2b:l.B2B_SAAS,consumer:l.B2C,retail:l.B2C,platform:l.MARKETPLACE,ecommerce:l.ECOMMERCE,"e-commerce":l.ECOMMERCE,manufacturing:l.MANUFACTURING,services:l.SERVICES,consulting:l.SERVICES,professional:l.SERVICES})[t.toLowerCase()]||t):e.industry?(s=e.industry,({technology:l.B2B_SAAS,software:l.B2B_SAAS,retail:l.B2C,ecommerce:l.ECOMMERCE,manufacturing:l.MANUFACTURING,services:l.SERVICES,healthcare:l.SERVICES,finance:l.SERVICES,real_estate:l.SERVICES,hospitality:l.SERVICES,construction:l.SERVICES})[s.toLowerCase()]||l.SERVICES):e.business_type?(n=e.business_type,({"sole-trader":l.SERVICES,company:l.SERVICES,partnership:l.SERVICES,llc:l.SERVICES,corporation:l.SERVICES})[n.toLowerCase()]||l.SERVICES):"services"}extractFoundingYear(e){return e.founded_year&&M(e.founded_year)?e.founded_year:e.years_in_operation?new Date().getFullYear()-e.years_in_operation:e.company_age?new Date().getFullYear()-e.company_age:new Date().getFullYear()-5}transformToConversationStartRequest(e,t){let s={business_context:{company_name:e.company_name,industry:e.industry,business_model:e.business_type,country_code:e.country||"BE",founding_year:e.founded_year,business_type_id:e.business_type_id},user_preferences:t},n={};if(e.company_name&&(n.company_name=e.company_name),e.industry&&(n.industry=e.industry),e.business_type&&(n.business_type=e.business_type),e.country&&(n.country_code=e.country),e.founded_year&&(n.founding_year=e.founded_year),e.business_type_id&&(n.business_type_id=e.business_type_id,j.qA.info("AI Flow: business_type_id included in pre-filled data",{business_type_id:e.business_type_id})),e.years_in_operation&&(n.years_in_operation=e.years_in_operation),e.revenue_range){let t=this.parseRevenueRange(e.revenue_range);t&&(n.revenue=t)}if(e.employee_count_range){let t=this.parseEmployeeRange(e.employee_count_range);t&&(n.employee_count=t)}return e.company_description&&(n.business_description=e.company_description),e.business_highlights&&(n.business_highlights=e.business_highlights),e.city&&(n.city=e.city),s.pre_filled_data=n,s}parseRevenueRange(e){let t=e.toLowerCase();return t.includes("<€100k")||t.includes("<100k")?5e4:t.includes("€100k-€500k")||t.includes("100k-500k")?3e5:t.includes("€500k-€1m")||t.includes("500k-1m")?75e4:t.includes("€1m-€5m")||t.includes("1m-5m")?3e6:t.includes("€5m+")||t.includes("5m+")?75e5:null}parseEmployeeRange(e){let t=e.toLowerCase();return t.includes("1-5")?3:t.includes("6-20")?13:t.includes("21-50")?35:t.includes("51-100")?75:t.includes("100+")?150:null}async getBusinessTypeAnalysis(e){try{let t=(void 0).VITE_BACKEND_URL||(void 0).VITE_API_BASE_URL||"https://web-production-8d00b.up.railway.app",s=await fetch("".concat(t,"/api/v1/analyze"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({business_type:e,country_code:"BE"})});if(!s.ok)throw Error("Failed to analyze business type: ".concat(s.statusText));return await s.json()}catch(e){return j.qA.error("Error analyzing business type",{error:e instanceof Error?e.message:"Unknown error"}),null}}hasCompleteBusinessProfile(e){return["company_name","industry","business_type","revenue_range"].every(t=>e[t]&&""!==e[t])}getMissingFields(e){return["company_name","industry","business_type","revenue_range"].filter(t=>!e[t]||""===e[t])}getFieldAnalysis(e){let t=["company_name","industry","business_type","revenue_range","employee_count_range","company_description","business_highlights","city","country"],s=["company_name","industry","business_type","revenue_range"],n=["company_description","business_highlights","city"],a=t.filter(t=>e[t]&&""!==e[t]),r=t.filter(t=>!e[t]||""===e[t]),i=r.filter(e=>s.includes(e)),l=r.filter(e=>s.includes(e)).length,o=r.filter(e=>n.includes(e)).length;return{missing:r,complete:a,priority:i,estimatedTime:Math.max(1,Math.round(1.5*l+.5*o)),completeness:Math.round(a.length/t.length*100)}}generateTargetedQuestions(e){let t=this.getFieldAnalysis(e),s={company_name:"What is your company name?",industry:"What industry is your company in?",business_type:"What type of business structure do you have?",revenue_range:"What is your annual revenue range?",employee_count_range:"How many employees do you have?",company_description:"Can you briefly describe your business?",business_highlights:"What are your key business highlights?",city:"What city is your business located in?",country:"What country is your business in?"};return{questions:t.missing.map(e=>({field:e,question:s[e]||"Please provide ".concat(e.replace("_"," ")),priority:t.priority.includes(e)?"high":["company_description","business_highlights"].includes(e)?"medium":"low"})),summary:"We have ".concat(t.complete.length,"/").concat(t.missing.length+t.complete.length," fields. We'll ask ").concat(t.priority.length," critical questions (").concat(t.estimatedTime," minutes)."),estimatedTime:t.estimatedTime}}getDataCompleteness(e){let t=["company_name","industry","business_type","years_in_operation","revenue_range","employee_count_range","company_description","business_highlights","city","country"];return Math.round(t.filter(t=>e[t]&&""!==e[t]).length/t.length*100)}constructor(){this.backendUrl=(void 0).VITE_BACKEND_URL||(void 0).VITE_API_BASE_URL||"https://web-production-8d00b.up.railway.app"}}let P=new D,O=d.memo(e=>{let{showPreConversationSummary:t,onTogglePreConversationSummary:n}=e,{user:a,isAuthenticated:r}=(0,v.a)(),{startConversation:i,setBusinessProfile:l,setProfileLoading:o}=E(),[u,m]=(0,d.useState)(null),[p,h]=(0,d.useState)(!0),[g,f]=(0,d.useState)(null),x=(0,d.useCallback)(async e=>{try{j.pL.info("Starting intelligent conversation with pre-filled data");let t=P.transformToConversationStartRequest(e,{time_commitment:"detailed",focus_area:"all"});(null==a?void 0:a.id)&&(t.user_id=a.id,j.pL.info("Added user_id for intelligent triage",{userId:a.id}));let{api:n}=await s.e(438).then(s.bind(s,54438)),r=await n.startConversation(t);j.pL.info("Intelligent conversation started",{response:r}),r.valuation_result||i(e)}catch(e){j.pL.error("Error starting intelligent conversation",{error:e instanceof Error?e.message:"Unknown error",stack:e instanceof Error?e.stack:void 0}),f("Failed to start intelligent conversation. Using manual flow."),i(null)}},[null==a?void 0:a.id,i]);return((0,d.useEffect)(()=>{(async()=>{try{if(h(!0),f(null),!r||!(null==a?void 0:a.id)){j.pL.info("No authenticated user, skipping profile fetch"),h(!1);return}let e=a.id;j.pL.debug("Fetching business profile for instant valuation");let t=await P.fetchUserBusinessData(e);t?(m(t),l(t),j.pL.info("Business profile loaded",{profileData:t}),x(t)):(j.pL.info("No business profile found, starting fresh conversation"),i(null))}catch(e){j.pL.error("Error fetching business profile",{error:e instanceof Error?e.message:"Unknown error",stack:e instanceof Error?e.stack:void 0}),f("Failed to load business profile. Starting fresh conversation.")}finally{h(!1),o(!1)}})()},[r,null==a?void 0:a.id,l,o,i,x]),u||p||g)?(0,c.jsxs)(c.Fragment,{children:[u&&!p&&(0,c.jsx)("div",{className:"border-b border-zinc-800 bg-zinc-900/30 px-3 sm:px-4 md:px-6 py-3 mx-4",children:(0,c.jsxs)("div",{className:"flex items-center gap-3",children:[(0,c.jsx)(T.Z,{className:"w-5 h-5 text-primary-400 flex-shrink-0"}),(0,c.jsxs)("div",{className:"min-w-0 flex-1",children:[(0,c.jsx)("h3",{className:"text-sm font-medium text-white truncate",children:u.company_name||"Your Business"}),(0,c.jsxs)("div",{className:"flex items-center gap-2 text-xs text-zinc-400",children:[u.industry&&(0,c.jsx)("span",{className:"bg-zinc-800 px-2 py-1 rounded",children:u.industry}),u.business_type&&(0,c.jsx)("span",{className:"bg-zinc-800 px-2 py-1 rounded",children:u.business_type}),u.revenue_range&&(0,c.jsx)("span",{className:"bg-zinc-800 px-2 py-1 rounded",children:u.revenue_range})]})]}),(0,c.jsxs)("div",{className:"text-xs text-zinc-500",children:[P.getDataCompleteness(u),"% complete"]})]})}),t&&u&&(0,c.jsx)("div",{className:"mx-4 mb-4",children:(0,c.jsx)("div",{className:"bg-primary-900/20 border border-primary-700/30 rounded-lg p-4",children:(0,c.jsxs)("div",{className:"flex items-start gap-3",children:[(0,c.jsx)("div",{className:"w-8 h-8 bg-primary-500/20 rounded-full flex items-center justify-center flex-shrink-0",children:(0,c.jsx)("span",{className:"text-primary-400 text-sm",children:"\uD83E\uDDE0"})}),(0,c.jsxs)("div",{className:"flex-1",children:[(0,c.jsx)("h3",{className:"text-lg font-semibold text-primary-300 mb-2",children:"Intelligent Triage Active"}),(0,c.jsx)("p",{className:"text-sm text-primary-200 mb-3",children:"We found your business profile! We'll skip the questions we already know and only ask for missing information."}),(()=>{let e=(0,d.useMemo)(()=>P.getFieldAnalysis(u),[]);return(0,c.jsxs)("div",{className:"space-y-3",children:[(0,c.jsxs)("div",{className:"flex items-center gap-2 text-sm",children:[(0,c.jsx)("span",{className:"text-primary-300",children:"Data completeness:"}),(0,c.jsxs)("span",{className:"font-semibold text-primary-200",children:[e.completeness,"%"]}),(0,c.jsx)("div",{className:"flex-1 bg-zinc-700 rounded-full h-2",children:(0,c.jsx)("div",{className:"bg-primary-500 h-2 rounded-full transition-all duration-300",style:{width:"".concat(e.completeness,"%")}})})]}),(0,c.jsxs)("div",{className:"text-sm text-primary-200",children:[(0,c.jsx)("span",{className:"text-primary-300",children:"Estimated time:"})," ",e.estimatedTime," minutes"]}),e.complete.length>0&&(0,c.jsxs)("div",{className:"text-sm",children:[(0,c.jsx)("span",{className:"text-primary-300",children:"We already know:"}),(0,c.jsx)("div",{className:"flex flex-wrap gap-1 mt-1",children:e.complete.map(e=>(0,c.jsx)("span",{className:"bg-primary-800/50 px-2 py-1 rounded text-xs",children:e.replace("_"," ")},e))})]}),e.priority.length>0&&(0,c.jsxs)("div",{className:"text-sm",children:[(0,c.jsx)("span",{className:"text-primary-300",children:"We need to ask about:"}),(0,c.jsx)("div",{className:"flex flex-wrap gap-1 mt-1",children:e.priority.map(e=>(0,c.jsx)("span",{className:"bg-accent-800/50 px-2 py-1 rounded text-xs",children:e.replace("_"," ")},e))})]}),(0,c.jsxs)("div",{className:"flex gap-2 pt-2",children:[(0,c.jsx)("button",{onClick:()=>{n(),x(u)},className:"px-4 py-2 bg-accent-600 hover:bg-accent-500 text-white rounded-lg text-sm font-medium transition-colors",children:"Start Smart Conversation"}),(0,c.jsx)("button",{onClick:()=>{n(),i(null)},className:"px-4 py-2 bg-zinc-700 hover:bg-zinc-600 text-zinc-300 rounded-lg text-sm font-medium transition-colors",children:"Start Fresh"})]})]})})()]})]})})}),g&&(0,c.jsx)("div",{className:"border-b border-rust-700 bg-rust-500/20 px-3 sm:px-4 md:px-6 py-3 mx-4",children:(0,c.jsxs)("div",{className:"flex items-center gap-2 text-sm text-rust-300",children:[(0,c.jsx)("span",{children:"⚠️"}),(0,c.jsx)("span",{children:g})]})}),p&&(0,c.jsx)("div",{className:"flex items-center justify-center h-32 mx-4",children:(0,c.jsxs)("div",{className:"text-center",children:[(0,c.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary-500 mx-auto mb-4"}),(0,c.jsx)("p",{className:"text-zinc-400 text-sm",children:"Loading your business profile..."})]})})]}):null});O.displayName="BusinessProfileSection";var V=s(36127);class U extends d.Component{static getDerivedStateFromError(e){return{hasError:!0,error:e}}componentDidCatch(e,t){let s=this.props.componentName||"Unknown";j.Sc.error("Error caught by ErrorBoundary in ".concat(s),{componentName:s,errorMessage:e.message,errorName:e.name,errorStack:e.stack,componentStack:t.componentStack,retryCount:this.state.retryCount},e)}render(){if(this.state.hasError){if(this.props.fallback)return this.props.fallback;let e=this.props.componentName||"Component",{retryCount:t}=this.state,s=t<2;return(0,c.jsx)("div",{className:"bg-red-50 border-2 border-red-300 rounded-lg p-6",children:(0,c.jsxs)("div",{className:"flex items-start gap-3",children:[(0,c.jsx)(V.Z,{className:"w-6 h-6 text-red-600 flex-shrink-0 mt-0.5"}),(0,c.jsxs)("div",{className:"flex-1",children:[(0,c.jsxs)("h3",{className:"text-lg font-semibold text-red-900 mb-2",children:[e," Error"]}),(0,c.jsxs)("p",{className:"text-sm text-red-800 mb-3",children:["An unexpected error occurred while rendering this component.",this.state.error&&(0,c.jsxs)(c.Fragment,{children:[" ",(0,c.jsx)("span",{className:"font-mono text-xs bg-red-100 px-2 py-1 rounded",children:this.state.error.message})]})]}),t>0&&s&&(0,c.jsxs)("div",{className:"mb-3 text-xs text-red-700 bg-red-100 p-2 rounded border border-red-200",children:[(0,c.jsxs)("strong",{children:["⚠️ This error has occurred ",t," time",t>1?"s":"","."]})," ","If it persists after another attempt, please reload the page."]}),!s&&(0,c.jsxs)("div",{className:"mb-3 text-xs text-red-800 bg-red-100 p-2 rounded border border-red-300",children:[(0,c.jsxs)("strong",{children:["❌ Maximum retry attempts reached (",2,")."]})," This appears to be a persistent error. Please reload the page or contact support if the issue continues."]}),(0,c.jsxs)("div",{className:"flex gap-3",children:[s?(0,c.jsxs)("button",{onClick:this.handleReset,className:"px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 text-sm font-medium transition-colors",children:["Try Again ",t>0&&"(".concat(t,"/").concat(2,")")]}):(0,c.jsx)("button",{onClick:this.handleReset,disabled:!0,className:"px-4 py-2 bg-gray-300 text-gray-500 rounded cursor-not-allowed text-sm font-medium",title:"Maximum retry attempts reached",children:"Try Again (Max Reached)"}),(0,c.jsx)("button",{onClick:()=>window.location.reload(),className:"px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 text-sm font-medium transition-colors",children:"Reload Page"})]}),!1]})]})})}return this.props.children}constructor(e){super(e),this.handleReset=()=>{this.setState(e=>({hasError:!1,error:null,retryCount:e.retryCount+1}))},this.state={hasError:!1,error:null,retryCount:0}}}class F{addMessage(e,t){let s={...t,id:this.generateMessageId(),timestamp:new Date};return j.pL.debug("Adding new message",{messageId:s.id,type:s.type,contentLength:s.content.length}),{updatedMessages:[...e,s],newMessage:s}}updateStreamingMessage(e,t,s,n,a){var r;let i=t||(null===(r=this.findStreamingMessage(e))||void 0===r?void 0:r.id);return i?(j.pL.debug("Updating streaming message",{messageId:i,contentLength:s.length,isComplete:n,hasMetadata:!!a,metadataKeys:a?Object.keys(a):[]}),e.map(e=>e.id===i?{...e,content:e.content+s,isComplete:n,isStreaming:!n,...a?{metadata:{...e.metadata,...a}}:{}}:e)):(j.pL.warn("No streaming message found to update"),e)}scrollToBottom(e){e.current?(e.current.scrollIntoView({behavior:"smooth"}),j.pL.debug("Scrolled to bottom of messages")):j.pL.warn("Messages end ref not available for scrolling")}generateMessageId(){return"msg_".concat(Date.now(),"_").concat(Math.random().toString(36).substr(2,9))}findMessageById(e,t){return e.find(e=>e.id===t)}getLastMessage(e){return e.length>0?e[e.length-1]:void 0}getMessagesByType(e,t){return e.filter(e=>e.type===t)}getUserMessageCount(e){return this.getMessagesByType(e,"user").length}getAIMessageCount(e){return this.getMessagesByType(e,"ai").length}hasStreamingMessages(e){return e.some(e=>e.isStreaming)}getIncompleteMessages(e){return e.filter(e=>!e.isComplete)}findStreamingMessage(e){return e.find(e=>e.isStreaming)}clearAllMessages(){return j.pL.debug("Clearing all messages"),[]}removeMessage(e,t){let s=e.filter(e=>e.id!==t);return j.pL.debug("Removed message",{messageId:t,remainingCount:s.length}),s}}class B{reset(){this.hasStartedMessage=!1,this.messageCreationLock=!1,this.chunkBuffer=[],this.lastProcessedChunks=[],this.lastCompleteMessageSignature=null}handleTyping(e){var t,s,n,a;j.pL.debug("AI typing indicator received"),null===(t=(s=this.callbacks).setIsTyping)||void 0===t||t.call(s,!0),null===(n=(a=this.callbacks).setIsThinking)||void 0===n||n.call(a,!0),this.ensureMessageExists().catch(e=>{j.pL.error("Failed to ensure message exists",{error:e})})}handleMessageStart(e){var t,s,n,a,r,i;console.log("\uD83C\uDFAF MESSAGE_START received:",{type:e.type,field:e.field,content:e.content,session_id:e.session_id,_is_confirmation:e._is_confirmation}),this.hasStartedMessage&&(j.pL.debug("message_start received while previous message active - completing previous message",{bufferedChunks:this.chunkBuffer.length}),this.callbacks.updateStreamingMessage("",!0),this.callbacks.setIsStreaming(!1)),this.hasStartedMessage=!1,this.messageCreationLock=!1,this.chunkBuffer=[],this.lastProcessedChunks=[],this.lastCompleteMessageSignature=null,null===(t=(s=this.callbacks).setIsThinking)||void 0===t||t.call(s,!1),null===(n=(a=this.callbacks).setIsTyping)||void 0===n||n.call(a,!1),null===(r=(i=this.callbacks).setTypingContext)||void 0===r||r.call(i,void 0),this.callbacks.setIsStreaming(!0)}async handleMessageChunk(e){let t=null!=e.content?String(e.content):"";if(!t){j.pL.warn("⚠️ Empty message chunk received - skipping update");return}let s=this.chunkBuffer.includes(t);if(this.lastProcessedChunks.slice(-3).includes(t)&&!s)return;if(await this.ensureMessageExists(),this.hasStartedMessage){var n,a,r,i;null===(n=(a=this.callbacks).setIsThinking)||void 0===n||n.call(a,!1),null===(r=(i=this.callbacks).setIsTyping)||void 0===r||r.call(i,!1)}if(!this.hasStartedMessage){j.pL.warn("⚠️ Message not created yet after ensureMessageExists - buffering chunk",{chunkContent:t.substring(0,30)}),s||this.chunkBuffer.push(t);return}if(s)return;this.lastProcessedChunks.push(t);let l=t+JSON.stringify(e.metadata||{});if(this.lastCompleteMessageSignature===l){j.pL.warn("⚠️ Duplicate message signature detected - skipping chunk",{signature:l.substring(0,50)});return}this.callbacks.updateStreamingMessage(t,!1,e.metadata),j.pL.debug("Message chunk processed",{chunkLength:t.length,totalChunks:this.lastProcessedChunks.length,hasStarted:this.hasStartedMessage})}handleMessageComplete(e){var t,s,n,a,r,i,l,o,c;let d=e.metadata||e.data||{},u=d.field||d.collected_field||d.clarification_field,m=void 0!==d.value?d.value:d.collected_value,p=d.source||"backend";j.pL.info("Message completed",{field:u,hasValue:void 0!==m,source:p,contentLength:(null===(t=e.content)||void 0===t?void 0:t.length)||0,metadataKeys:Object.keys(d)}),this.callbacks.updateStreamingMessage(e.content||"",!0,d),this.callbacks.setIsStreaming(!1),null===(s=(n=this.callbacks).setIsTyping)||void 0===s||s.call(n,!1),null===(a=(r=this.callbacks).setIsThinking)||void 0===a||a.call(r,!1);let h=(e.content||"")+JSON.stringify(d);this.lastCompleteMessageSignature=h,e.metrics&&(null===(o=(c=this.callbacks).trackModelPerformance)||void 0===o||o.call(c,e.metrics)),null===(i=(l=this.callbacks).trackConversationCompletion)||void 0===i||i.call(l,!0,!1)}async ensureMessageExists(){if(this.messageCreationLock){j.pL.debug("Message creation already in progress, skipping");return}if(this.hasStartedMessage){if(this.chunkBuffer.length>0){j.pL.debug("Flushing buffered chunks",{count:this.chunkBuffer.length});let e=this.chunkBuffer.join("");this.chunkBuffer=[],this.callbacks.updateStreamingMessage(e,!1)}return}this.messageCreationLock=!0;try{if(j.pL.debug("Creating new streaming message"),this.callbacks.addMessage({type:"ai",content:"",isStreaming:!0,isComplete:!1}),this.hasStartedMessage=!0,this.chunkBuffer.length>0){j.pL.debug("Flushing buffered chunks on message creation",{count:this.chunkBuffer.length});let e=this.chunkBuffer.join("");this.chunkBuffer=[],this.callbacks.updateStreamingMessage(e,!1)}j.pL.debug("Streaming message created successfully")}catch(e){throw j.pL.error("Failed to create streaming message",{error:e}),this.messageCreationLock=!1,e}finally{this.messageCreationLock=!1}}constructor(e){this.hasStartedMessage=!1,this.messageCreationLock=!1,this.chunkBuffer=[],this.lastProcessedChunks=[],this.lastCompleteMessageSignature=null,this.callbacks=e}}class H{handleReportUpdate(e){var t,s;let n=e.html||e.content||"",a=e.progress||0;j.pL.info("Report update received",{progress:a,htmlLength:n.length,hasHtml:!!n}),null===(t=(s=this.callbacks).onReportUpdate)||void 0===t||t.call(s,n,a)}handleSectionLoading(e){var t,s;let n=e.section||e.section_name||"unknown",a=e.html||e.content||"",r=e.phase||0,i=e.data||e.metadata||{};j.pL.info("Report section loading",{section:n,phase:r,htmlLength:a.length,dataKeys:Object.keys(i)}),null===(t=(s=this.callbacks).onSectionLoading)||void 0===t||t.call(s,n,a,r,i)}handleSectionComplete(e){var t,s;let n=e.section_id||e.section||"unknown",a=e.section_name||e.name||n,r=e.html||e.content||"",i=e.progress||0,l=e.phase;j.pL.info("Report section completed",{sectionId:n,sectionName:a,progress:i,phase:l,htmlLength:r.length}),null===(t=(s=this.callbacks).onSectionComplete)||void 0===t||t.call(s,{sectionId:n,sectionName:a,html:r,progress:i,phase:l})}handleReportSection(e){var t,s;let n=e.section||e.section_name||"unknown",a=e.html||e.content||"",r=e.phase||0,i=e.progress||0,l=e.is_fallback||!1,o=e.is_error||!1,c=e.error_message||e.error||"";j.pL.info("Report section update",{section:n,phase:r,progress:i,isFallback:l,isError:o,htmlLength:a.length,hasErrorMessage:!!c}),null===(t=(s=this.callbacks).onReportSectionUpdate)||void 0===t||t.call(s,n,a,r,i,l,o,c)}handleReportComplete(e){var t,s;let n=e.html||e.content||"",a=e.valuation_id||e.id||"";j.pL.info("Report completed",{valuationId:a,htmlLength:n.length,hasValuationId:!!a}),null===(t=(s=this.callbacks).onReportComplete)||void 0===t||t.call(s,n,a)}constructor(e){this.callbacks=e}}class W{handleProgressUpdate(e){var t,s;j.pL.debug("Progress update received",{progress:e.progress,message:e.message,step:e.step}),null===(t=(s=this.callbacks).onProgressUpdate)||void 0===t||t.call(s,e)}handleProgressSummary(e){var t,s;j.pL.info("Progress summary received",{summary:e.summary,totalSteps:e.total_steps,completedSteps:e.completed_steps,dataKeys:Object.keys(e)}),null===(t=(s=this.callbacks).onProgressUpdate)||void 0===t||t.call(s,e)}handleDataCollected(e){var t,s;let n=e.data||e.collected_data||e,a=n.field||n.key,r=n.value,i=n.source||"backend";j.pL.info("Data collected",{field:a,hasValue:void 0!==r,source:i,dataKeys:Object.keys(n)}),this.callbacks.setCollectedData(e=>({...e,[a]:r})),null===(t=(s=this.callbacks).onDataCollected)||void 0===t||t.call(s,n)}handleSuggestionOffered(e){let t=e.suggestions||e.options||[],s=e.field||e.for_field;j.pL.info("Suggestions offered",{field:s,suggestionCount:t.length,suggestions:t.slice(0,3)}),this.callbacks.addMessage({type:"suggestion",content:e.message||e.content||"Here are some suggestions:",metadata:{suggestions:t,originalValue:e.original_value,field:s},isComplete:!0})}handleClarificationNeeded(e){let t=e.field||e.clarification_field,s=e.message||e.content||"Please provide more information.",n=e.options||e.suggestions||[],a=e.input_type||"text";j.pL.info("Clarification needed",{field:t,inputType:a,hasOptions:n.length>0,optionCount:n.length,messageLength:s.length}),this.callbacks.addMessage({type:"ai",content:s,metadata:{needs_confirmation:!0,clarification_field:t,collected_field:t,input_type:a,options:n,clarification_message:s},isComplete:!0})}handleHtmlPreview(e){var t,s;let n=e.html||e.content||"",a=e.preview_type||e.type||"progressive";j.pL.info("HTML preview received",{previewType:a,htmlLength:n.length,hasHtml:!!n}),null===(t=(s=this.callbacks).onHtmlPreviewUpdate)||void 0===t||t.call(s,n,a)}handleError(e){var t,s,n,a,r,i,l,o;let c=e.message||e.content||e.error||"An unexpected error occurred",d=e.error_type||e.type||"unknown",u=!1!==e.retryable;j.pL.error("Streaming error received",{errorType:d,errorMessage:c.substring(0,100),isRetryable:u,dataKeys:Object.keys(e)}),this.callbacks.addMessage({type:"system",content:"Error: ".concat(c).concat(u?" Please try again.":""),isComplete:!0}),this.callbacks.setIsStreaming(!1),null===(t=(s=this.callbacks).setIsTyping)||void 0===t||t.call(s,!1),null===(n=(a=this.callbacks).setIsThinking)||void 0===n||n.call(a,!1),e.metrics&&(null===(l=(o=this.callbacks).trackModelPerformance)||void 0===l||l.call(o,{...e.metrics,error_occurred:!0,error_type:d})),null===(r=(i=this.callbacks).trackConversationCompletion)||void 0===r||r.call(i,!1,!1)}constructor(e){this.callbacks=e}}class q{handleValuationPreview(e){var t,s;j.pL.info("Valuation preview received",{hasValue:!!e.value,value:e.value,metadataKeys:Object.keys(e)}),this.callbacks.setValuationPreview(e),null===(t=(s=this.callbacks).onValuationPreview)||void 0===t||t.call(s,e)}handleCalculateOption(e){var t,s;j.pL.info("Calculate option received",{hasParameters:!!e.parameters,parametersKeys:e.parameters?Object.keys(e.parameters):[],hasValue:!!e.estimatedValue,estimatedValue:e.estimatedValue}),this.callbacks.setCalculateOption(e),null===(t=(s=this.callbacks).onCalculateOptionAvailable)||void 0===t||t.call(s,e)}handleValuationReady(e){j.pL.info("Valuation ready event received",{dataKeys:Object.keys(e)})}handleValuationConfirmed(e){j.pL.info("Valuation confirmed event received",{dataKeys:Object.keys(e)})}handleValuationComplete(e){var t,s,n,a;j.pL.info("Valuation completed",{hasResult:!!e.result,resultKeys:e.result?Object.keys(e.result):[],hasValuationId:!!e.valuation_id,valuationId:e.valuation_id}),null===(t=(s=this.callbacks).trackConversationCompletion)||void 0===t||t.call(s,!0,!0),null===(n=(a=this.callbacks).onValuationComplete)||void 0===n||n.call(a,e.result||e)}constructor(e){this.callbacks=e}}class G{reset(){j.pL.debug("Resetting StreamEventHandler state for new stream",{sessionId:this.sessionId}),this.messageHandlers.reset()}handleEvent(e){let t=(null==e?void 0:e.type)||(null==e?void 0:e.event)||"unknown";try{switch(t){case"typing":return this.messageHandlers.handleTyping(e);case"message_start":return this.messageHandlers.handleMessageStart(e);case"message_chunk":this.messageHandlers.handleMessageChunk(e).catch(e=>{j.pL.error("Error handling message chunk",{error:e})});return;case"message_complete":return this.messageHandlers.handleMessageComplete(e);case"report_update":return this.reportHandlers.handleReportUpdate(e);case"section_loading":return this.reportHandlers.handleSectionLoading(e);case"section_complete":return this.reportHandlers.handleSectionComplete(e);case"report_section":return this.reportHandlers.handleReportSection(e);case"report_complete":return this.reportHandlers.handleReportComplete(e);case"valuation_preview":return this.valuationHandlers.handleValuationPreview(e);case"calculate_option":return this.valuationHandlers.handleCalculateOption(e);case"valuation_ready":return this.valuationHandlers.handleValuationReady(e);case"valuation_confirmed":return this.valuationHandlers.handleValuationConfirmed(e);case"valuation_complete":return this.valuationHandlers.handleValuationComplete(e);case"progress_summary":return this.uiHandlers.handleProgressSummary(e);case"progress_update":return this.uiHandlers.handleProgressUpdate(e);case"data_collected":return this.uiHandlers.handleDataCollected(e);case"suggestion_offered":return this.uiHandlers.handleSuggestionOffered(e);case"clarification_needed":return this.uiHandlers.handleClarificationNeeded(e);case"html_preview":return this.uiHandlers.handleHtmlPreview(e);case"error":return this.uiHandlers.handleError(e);case"unknown":return this.uiHandlers.handleError({...e,message:e.message||e.content||"An unexpected event occurred",content:e.content||"Unknown event type"});default:return j.pL.warn("Unrecognized event type, treating as error",{type:t}),this.uiHandlers.handleError({...e,message:"Unrecognized event: ".concat(t),content:e.content||"An unexpected error occurred"})}}catch(s){j.pL.error("Error in handleEvent",{eventType:t,error:s instanceof Error?s.message:String(s),stack:s instanceof Error?s.stack:void 0}),this.uiHandlers.handleError({...e,message:"Event processing failed: ".concat(s instanceof Error?s.message:"Unknown error"),error_type:"handler_error"})}}constructor(e,t){this.callbacks=t,this.sessionId=e,this.messageHandlers=new B(t),this.reportHandlers=new H(t),this.valuationHandlers=new q(t),this.uiHandlers=new W(t)}}class Z{isEnabled(){return this.enabled}enable(){this.enabled=!0,localStorage.setItem("DEBUG_CONVERSATION","true"),console.log("\uD83D\uDD27 Debug logging enabled")}disable(){this.enabled=!1,localStorage.removeItem("DEBUG_CONVERSATION"),console.log("\uD83D\uDD07 Debug logging disabled")}log(e,t,s){this.enabled&&(s?console.log(e,t,s):console.log(e,t))}warn(e,t,s){this.enabled&&(s?console.warn(e,t,s):console.warn(e,t))}error(e,t,s){s?console.error(e,t,s):console.error(e,t)}info(e,t,s){this.enabled&&(s?console.info(e,t,s):console.info(e,t))}always(e,t,s){s?console.log(e,t,s):console.log(e,t)}constructor(){this.enabled=(void 0).DEV||"true"===localStorage.getItem("DEBUG_CONVERSATION")}}let K=new Z;window.enableDebug=()=>K.enable(),window.disableDebug=()=>K.disable();var Y=s(813);class ${async *streamConversation(e,t,s,n){let a=(e=>{let t;if(!e)return e;let s=/\b(usd|gbp|pounds?|dollars?|cad|aud|chf|yen|jpy|cny|hkd|sek|nok|dkk|zar)\b|[$£¥]/i.test(e)&&!/\b(eur|euro|euros)\b|€/i.test(e),n=(t=e.replace(/[€]/g,"").replace(/\b(eur|euro|euros)\b/gi,"").replace(/[^\d.,\s-]/g,"").trim().replace(/\s+/g,""),t=/^\d{1,3}(\.\d{3})*(,\d+)?$/.test(t)?t.replace(/\./g,"").replace(",","."):t.replace(/,/g,""));return n.match(/^[+-]?\d+(?:\.\d+)?$/)?s?"".concat(n," euro"):n:e})(t);try{j.pL.info("Stream started",{sessionId:e,userInput:t.substring(0,50)+"...",userId:s});let r=null;if(!s)try{r=await Y.L.getOrCreateSession()}catch(e){j.pL.warn("Failed to get guest session ID",{error:e})}let i={session_id:e,user_input:a,user_id:s,guest_session_id:r},l="".concat(this.baseURL,"/api/v1/intelligent-conversation/stream"),o=await fetch(l,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify(i),signal:n});if(!o.ok){let e=await o.text();throw j.pL.error("SSE request failed",{status:o.status,errorText:e}),Error("HTTP error! status: ".concat(o.status,", body: ").concat(e))}if(!o.body)throw j.pL.error("Response body is null"),Error("Response body is null");let c=o.body.getReader();if(!c)throw Error("No response body");let d=new TextDecoder,u="";for(;;){if(null==n?void 0:n.aborted){j.pL.info("SSE stream aborted",{sessionId:e}),c.cancel();break}let{done:t,value:s}=await c.read();if(t){j.pL.debug("SSE stream completed");break}let a=d.decode(s,{stream:!0}),r=(u+=a).split("\n");for(let e of(u=r.pop()||"",r))if(!e.startsWith(": ")&&e.startsWith("data: ")&&e.trim().length>6){let t=e.slice(6).trim();if(t)try{let e=JSON.parse(t);if("error"===e.type){j.pL.error("SSE Error received",{message:e.message,sessionId:e.session_id}),yield e;return}if("ping"===e.type)continue;yield e}catch(s){j.pL.error("Failed to parse SSE data",{line:e,jsonStr:t,parseError:s instanceof Error?s.message:String(s)});continue}}}}catch(t){if(t instanceof Error&&"AbortError"===t.name){j.pL.info("SSE stream aborted (expected)",{sessionId:e});return}yield{type:"error",content:t instanceof Error?t.message:"Connection failed"};return}}streamConversationEventSource(e,t,s,n,a,r){let i="".concat(this.baseURL,"/api/v1/intelligent-conversation/stream");j.pL.info("Starting EventSource streaming",{sessionId:e,userInput:t.substring(0,50)+"...",userId:s,url:i});let l=new EventSource("".concat(i,"?session_id=").concat(e,"&user_input=").concat(encodeURIComponent(t),"&user_id=").concat(s||""));return l.onopen=()=>{j.pL.info("EventSource connection opened",{sessionId:e})},l.onmessage=e=>{try{var t;let s=JSON.parse(e.data);j.pL.info("EventSource message received",{type:s.type,hasContent:!!s.content,contentLength:null===(t=s.content)||void 0===t?void 0:t.length}),n&&n(s)}catch(t){j.pL.error("Failed to parse EventSource data",{data:e.data,parseError:t instanceof Error?t.message:"Unknown error"}),a&&a(Error("Parse error: ".concat(t)))}},l.onerror=t=>{j.pL.error("EventSource error",{error:t,sessionId:e,readyState:l.readyState}),a&&a(Error("EventSource error: ".concat(t)))},setTimeout(()=>{l.readyState!==EventSource.CLOSED&&(j.pL.info("EventSource auto-closing after timeout",{sessionId:e}),l.close(),r&&r())},3e4),l}constructor(){this.baseURL=(void 0).VITE_BACKEND_URL||(void 0).VITE_API_URL||"https://web-production-8d00b.up.railway.app"}}let X=new $;class J{setLockRefs(e,t){this.isRequestInProgressRef=e,this.setIsStreamingCallback=t}releaseLocks(e,t){K.warn("[StreamingManager]","Releasing locks: ".concat(e),{requestId:t}),this.requestIdRef.current=null,this.isRequestInProgressRef&&(this.isRequestInProgressRef.current=!1),this.setIsStreamingCallback&&this.setIsStreamingCallback(!1),this.currentAbortController&&(this.currentAbortController.abort(),this.currentAbortController=null)}cleanup(){K.info("[StreamingManager]","Cleanup called - releasing all locks"),this.releaseLocks("Component unmount or cleanup")}async startStreaming(e,t,s,n,a,r){var i,l;let o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;if(!t.trim()||this.requestIdRef.current){this.requestIdRef.current&&(K.warn("[StreamingManager]","Request already in progress",{existingRequestId:this.requestIdRef.current,sessionId:e}),j.pL.warn("Request already in progress",{currentRequestId:this.requestIdRef.current,sessionId:e}));return}let c="".concat(e,"_").concat(Date.now());this.requestIdRef.current=c,j.pL.info("Stream request",{sessionId:e,userInput:t.substring(0,30)});let d=n.extractBusinessModelFromInput(t),u=n.extractFoundingYearFromInput(t);(d||u)&&(null===(l=n.onContextUpdate)||void 0===l||l.call(n,{extracted_business_model:d,extracted_founding_year:u,extraction_confidence:{business_model:d?.8:0,founding_year:u?.8:0}})),null===(i=n.onStreamStart)||void 0===i||i.call(n),n.setIsStreaming(!0),this.currentAbortController=new AbortController;let m=this.currentAbortController.signal,p=new Promise((e,t)=>{setTimeout(()=>{t(Error("Stream timeout after ".concat(3e4,"ms - no response from backend")))},3e4)});try{await Promise.race([this.streamWithAsyncGenerator(e,t,s,a,m),p])}catch(l){let i=o<3;if(i||this.releaseLocks("Error in stream processing (no retry)",c),l instanceof Error&&l.message.includes("Stream timeout"))throw K.error("[StreamingManager]","Stream timeout",{error:l}),n.setIsStreaming(!1),n.addMessage({type:"ai",content:"⚠️ Connection timeout. The server took too long to respond. Please try again.",isComplete:!0,isStreaming:!1}),l;if(K.error("[StreamingManager]","Error in streamWithAsyncGenerator",{error:l,message:l instanceof Error?l.message:String(l),stack:l instanceof Error?l.stack:void 0}),j.pL.error("Async generator error",{error:l instanceof Error?l.message:"Unknown error",stack:l instanceof Error?l.stack:void 0,sessionId:e,userInput:t.substring(0,50)+"...",attempt:o,maxRetries:3}),i){let i=Math.min(1e3*Math.pow(2,o),1e4);j.pL.info("Retrying streaming conversation",{attempt:o+1,delay:i,sessionId:e}),this.releaseLocks("Error in stream processing (will retry)",c),setTimeout(()=>{this.startStreaming(e,t,s,n,a,r,o+1)},i);return}n.setIsStreaming(!1),this.currentStreamingMessageRef.current&&n.updateStreamingMessage("I apologize, but I'm having trouble connecting. Please try again.",!0),r(l instanceof Error?l:Error("Unknown streaming error"))}finally{null!==this.requestIdRef.current?(K.warn("[StreamingManager]","Finally block releasing locks (safety net)",{requestId:c}),this.releaseLocks("Finally block (safety net)",c)):K.log("[StreamingManager]","Finally block - locks already released",{requestId:c})}}async streamWithAsyncGenerator(e,t,s,n,a){let r,i=0;r=setTimeout(()=>{throw j.pL.warn("Async generator timeout - no events received in 10 seconds",{sessionId:e}),Error("Streaming timeout")},1e4);try{for await(let l of X.streamConversation(e,t,s,a)){if(null==a?void 0:a.aborted)throw j.pL.info("Stream aborted via AbortSignal",{sessionId:e}),clearTimeout(r),Error("Stream aborted");clearTimeout(r),i++;try{n(l)}catch(e){throw j.pL.error("❌ Error in onEvent callback",{error:e instanceof Error?e.message:String(e),stack:e instanceof Error?e.stack:void 0,eventType:l.type,eventCount:i}),e}}if(clearTimeout(r),j.pL.debug("Async generator completed",{totalEvents:i,sessionId:e}),0===i)throw j.pL.warn("No events received from async generator",{sessionId:e}),Error("No events received from async generator")}catch(e){throw clearTimeout(r),e}}streamWithEventSource(e,t,s,n,a,r){return j.pL.info("Starting EventSource fallback",{sessionId:e}),X.streamConversationEventSource(e,t,s,e=>{j.pL.info("EventSource event received",{type:e.type,hasContent:!!e.content}),n(e)},e=>{j.pL.error("EventSource error",{error:e.message}),a(e)},()=>{j.pL.info("EventSource completed",{sessionId:e}),r()})}isRequestInProgress(){return null!==this.requestIdRef.current}getCurrentRequestId(){return this.requestIdRef.current}clearCurrentRequest(){this.releaseLocks("Manual clearCurrentRequest call")}getCurrentStreamingMessage(){return this.currentStreamingMessageRef.current}setCurrentStreamingMessage(e){this.currentStreamingMessageRef.current=e}constructor(e,t){this.currentAbortController=null,this.isRequestInProgressRef=null,this.setIsStreamingCallback=null,this.requestIdRef=e,this.currentStreamingMessageRef=t}}let Q=[{question:"Welcome! Let me help you value your business. What is the name of your company?",field:"company_name",inputType:"text",helpText:"Enter your registered company name"},{question:"What type of business do you run?",field:"business_type",inputType:"select",options:["Technology","Manufacturing","Services","Retail","Other"]},{question:"What was your annual revenue last year?",field:"revenue",inputType:"number",helpText:"Enter your total annual revenue"},{question:"How many employees do you have?",field:"employee_count",inputType:"number",helpText:"Enter the number of full-time employees"}],ee=(e,t,s)=>{let[n,a]=(0,d.useState)(!0),r=(0,d.useRef)(!1),i=(0,d.useRef)(null),l=(0,d.useRef)(null),o=(0,d.useCallback)(()=>{if(!s)return;let t=Q[0],n={id:"fallback-".concat(Date.now()),type:"ai",role:"assistant",content:t.question,timestamp:new Date,metadata:{intent:"question",topic:"company_name",collected_field:t.field,help_text:t.helpText,fallback_mode:!0}};s.setMessages([n]),a(!1),j.pL.info("Using fallback mode - backend unavailable",{session_id:e,question:t.question})},[e,s]),c=(0,d.useCallback)(async function(){var n,r,l,d,u,m,p,h,g,f,x,y,v,b,_,w,N,S,k,C,E,I,L,R,T,M,z,A,D,P,O,V,U,F,B,H,W,q,G,Z,K,$,X;let J=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,Q=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3;if(!s)return;let ee=Date.now();try{a(!0);let X=(void 0).VITE_BACKEND_URL||(void 0).VITE_API_URL||"https://web-production-8d00b.up.railway.app",et=setTimeout(()=>{i.current&&i.current.abort()},1e4);try{let a=null;if(!t)try{a=await Y.L.getOrCreateSession()}catch(e){j.pL.warn("Failed to get guest session ID",{error:e})}let o=await fetch("".concat(X,"/api/v1/intelligent-conversation/start"),{method:"POST",signal:null===(n=i.current)||void 0===n?void 0:n.signal,credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({user_id:t||null,guest_session_id:a,business_context:t?{company_name:null===(r=s.user)||void 0===r?void 0:r.company_name,industry:null===(l=s.user)||void 0===l?void 0:l.industry,business_type:null===(d=s.user)||void 0===d?void 0:d.business_type,country_code:null===(u=s.user)||void 0===u?void 0:u.country,founding_year:null===(m=s.user)||void 0===m?void 0:m.founded_year}:void 0,pre_filled_data:t?{user_id:t,company_name:null===(p=s.user)||void 0===p?void 0:p.company_name,business_type:null===(h=s.user)||void 0===h?void 0:h.business_type,industry:null===(g=s.user)||void 0===g?void 0:g.industry,founded_year:null===(f=s.user)||void 0===f?void 0:f.founded_year,years_in_operation:null===(x=s.user)||void 0===x?void 0:x.years_in_operation,employee_count_range:null===(y=s.user)||void 0===y?void 0:y.employee_count_range,city:null===(v=s.user)||void 0===v?void 0:v.city,country:null===(b=s.user)||void 0===b?void 0:b.country,company_description:null===(_=s.user)||void 0===_?void 0:_.company_description}:void 0,user_preferences:{time_commitment:"detailed",focus_area:"all"}})});if(clearTimeout(et),!o.ok){let e=await o.text();throw j.pL.error("Conversation start failed",{status:o.status,statusText:o.statusText,errorBody:e,requestBody:{user_id:t||null,business_context:t?{company_name:null===(S=s.user)||void 0===S?void 0:S.company_name,industry:null===(k=s.user)||void 0===k?void 0:k.industry,business_type:null===(C=s.user)||void 0===C?void 0:C.business_type,country_code:null===(E=s.user)||void 0===E?void 0:E.country,founding_year:null===(I=s.user)||void 0===I?void 0:I.founded_year}:void 0,pre_filled_data:t?{user_id:t,company_name:null===(L=s.user)||void 0===L?void 0:L.company_name,business_type:null===(R=s.user)||void 0===R?void 0:R.business_type,industry:null===(T=s.user)||void 0===T?void 0:T.industry,founded_year:null===(M=s.user)||void 0===M?void 0:M.founded_year,years_in_operation:null===(z=s.user)||void 0===z?void 0:z.years_in_operation,employee_count_range:null===(A=s.user)||void 0===A?void 0:A.employee_count_range,city:null===(D=s.user)||void 0===D?void 0:D.city,country:null===(P=s.user)||void 0===P?void 0:P.country,company_description:null===(O=s.user)||void 0===O?void 0:O.company_description}:void 0,user_preferences:{time_commitment:"detailed",focus_area:"all"}}}),Error("HTTP ".concat(o.status,": ").concat(e))}let c=await o.json(),H=c.session_id;if(!H)throw j.pL.error("Missing session_id in /start response",{clientSessionId:e,responseKeys:Object.keys(c)}),Error("Backend did not return session_id");if(j.pL.info("Received session ID from Python backend",{clientSessionId:e,backendSessionId:H,isAuthenticated:!!t}),null===(w=s.onSessionIdUpdate)||void 0===w||w.call(s,H),!c.ai_message||!c.field_name)throw Error("Invalid response structure from backend");if(!(null===(N=i.current)||void 0===N?void 0:N.signal.aborted)){let n=Date.now()-ee;j.pL.info("Conversation initialized successfully",{sessionId:e,userId:t,isAuthenticated:!!t,firstField:c.field_name,backendDriven:!0,attempt:J,timeToFirstQuestionMs:n}),j.pL.info("conversation_initialized",{session_id:e,user_id:t,is_authenticated:!!t,time_to_first_question_ms:n,backend_driven:!0,first_field:c.field_name,attempt:J,has_profile_data:!!((null===(V=s.user)||void 0===V?void 0:V.company_name)||(null===(U=s.user)||void 0===U?void 0:U.business_type)||(null===(F=s.user)||void 0===F?void 0:F.industry))});let a={type:"ai",content:c.ai_message,isComplete:!0,isStreaming:!1,metadata:{collected_field:c.field_name,help_text:c.help_text,session_phase:"data_collection",conversation_turn:1}};s.addMessage(a),j.pL.debug("Initial message created from /start",{field:c.field_name,questionPreview:null===(B=c.ai_message)||void 0===B?void 0:B.substring(0,50)})}}catch(a){if(clearTimeout(et),a instanceof Error&&"AbortError"===a.name){j.pL.info("Initialization cancelled",{sessionId:e,userId:t});return}if(a instanceof Error&&"AbortError"===a.name&&(null===(H=i.current)||void 0===H?void 0:H.signal.aborted)){j.pL.warn("Initialization timed out",{sessionId:e,userId:t,timeoutMs:1e4}),(null===(K=i.current)||void 0===K?void 0:K.signal.aborted)||s.addMessage({type:"ai",content:"Sorry, the connection is taking too long. Let me start with a simple question: What is the name of your company?",isComplete:!0,metadata:{collected_field:"company_name"}});return}if(J<Q){let s=Math.min(1e3*Math.pow(2,J-1),5e3);return j.pL.warn("Initialization attempt ".concat(J," failed, retrying in ").concat(s,"ms"),{sessionId:e,userId:t,error:a instanceof Error?a.message:"Unknown error",nextAttempt:J+1,maxAttempts:Q}),await new Promise(e=>setTimeout(e,s)),c(J+1,Q)}let n=Date.now()-ee;j.pL.error("All initialization attempts failed",{error:a instanceof Error?a.message:"Unknown error",sessionId:e,userId:t,stack:a instanceof Error?a.stack:void 0,errorType:a instanceof Error?a.name:"Unknown",totalAttempts:J,timeElapsedMs:n}),j.pL.error("conversation_initialization_failed",{session_id:e,user_id:t,error_type:a instanceof Error?a.name:"Unknown",error_message:a instanceof Error?a.message:"Unknown error",time_elapsed_ms:n,fallback_used:!0,total_attempts:J,has_profile_data:!!((null===(W=s.user)||void 0===W?void 0:W.company_name)||(null===(q=s.user)||void 0===q?void 0:q.business_type)||(null===(G=s.user)||void 0===G?void 0:G.industry))}),o(),(null===(Z=i.current)||void 0===Z?void 0:Z.signal.aborted)||s.addMessage({type:"ai",content:"Welcome! Let me help you value your business. What is the name of your company?",isComplete:!0,metadata:{collected_field:"company_name"}})}finally{clearTimeout(et),(null===($=i.current)||void 0===$?void 0:$.signal.aborted)||a(!1)}}catch(n){j.pL.error("Unexpected error in initialization retry logic",{error:n instanceof Error?n.message:"Unknown error",sessionId:e,userId:t,stack:n instanceof Error?n.stack:void 0}),(null===(X=i.current)||void 0===X?void 0:X.signal.aborted)||!s||(s.addMessage({type:"ai",content:"Welcome! Let me help you value your business. What type of business do you run?",isComplete:!0,metadata:{collected_field:"business_type"}}),a(!1))}},[e,t,s,o]);return(0,d.useEffect)(()=>{var t;if(!s)return;let n=null!==(t=s.pythonSessionId)&&void 0!==t?t:null,o=l.current!==n;o&&(j.pL.info("\uD83D\uDD04 Python sessionId changed - resetting initialization state",{previousSessionId:l.current,newSessionId:n,sessionId:e}),r.current=!1,a(!0),l.current=n,i.current&&(i.current.abort(),i.current=new AbortController));let d=s.getCurrentMessages?s.getCurrentMessages():[],u=d.length>0;if(j.pL.debug("useConversationInitializer: state check",{sessionId:e,pythonSessionId:n,messageCount:d.length,hasMessages:u,isRestoring:s.isRestoring,isSessionInitialized:s.isSessionInitialized,isRestorationComplete:s.isRestorationComplete,hasInitialized:r.current,pythonSessionIdChanged:o}),u){j.pL.info("✅ Messages found - using existing conversation",{sessionId:e,messageCount:d.length,pythonSessionId:n}),r.current=!0,a(!1);return}if(!s.isSessionInitialized){j.pL.debug("Session not initialized - waiting",{sessionId:e,pythonSessionId:n});return}if(!s.isRestorationComplete){j.pL.debug("Restoration not complete - waiting",{sessionId:e,pythonSessionId:n});return}if(r.current){j.pL.debug("Already initialized - skipping",{sessionId:e,pythonSessionId:n});return}return j.pL.info("\uD83D\uDE80 Starting new conversation",{sessionId:e,pythonSessionId:n}),r.current=!0,c(),()=>{i.current&&i.current.abort()}},[e,c,s,null==s?void 0:s.isRestoring,null==s?void 0:s.isSessionInitialized,null==s?void 0:s.isRestorationComplete,null==s?void 0:s.pythonSessionId,null==s?void 0:s.getCurrentMessages]),{isInitializing:n,initializeWithRetry:c,resetInitialization:(0,d.useCallback)(()=>{r.current=!1,a(!0),i.current&&i.current.abort(),i.current=new AbortController},[]),useFallbackMode:o}},et=(e,t)=>{let[s,n]=(0,d.useState)({session_id:e,user_id:t,started_at:new Date,total_turns:0,successful:!1,ai_response_count:0,user_message_count:0,error_count:0,retry_count:0,avg_response_time_ms:0,valuation_generated:!1,data_completeness_percent:0,collected_fields:[],total_tokens_used:0,estimated_cost_usd:0,feedback_provided:!1}),a=(0,d.useCallback)(t=>{j.pL.info("Model performance tracked",{sessionId:e,model:t.model_name,responseTime:t.total_response_time_ms,tokens:t.output_tokens,cost:t.estimated_cost_usd}),n(e=>({...e,total_tokens_used:e.total_tokens_used+t.output_tokens,estimated_cost_usd:e.estimated_cost_usd+t.estimated_cost_usd,avg_response_time_ms:0===e.avg_response_time_ms?t.total_response_time_ms:(e.avg_response_time_ms+t.total_response_time_ms)/2})),t.total_response_time_ms>5e3&&j.pL.warn("Slow model response detected",{sessionId:e,responseTime:t.total_response_time_ms,threshold:5e3}),t.estimated_cost_usd>.1&&j.pL.warn("High cost response detected",{sessionId:e,cost:t.estimated_cost_usd,tokens:t.output_tokens})},[e]),r=(0,d.useCallback)((a,r)=>{j.pL.info("Conversation completion tracked",{sessionId:e,success:a,hasValuation:r,totalTurns:s.total_turns}),n(e=>({...e,successful:a,valuation_generated:r})),j.pL.info("conversation_completed",{session_id:e,user_id:t,success:a,has_valuation:r,total_turns:s.total_turns,ai_responses:s.ai_response_count,user_messages:s.user_message_count,errors:s.error_count,retries:s.retry_count,avg_response_time_ms:s.avg_response_time_ms,total_tokens:s.total_tokens_used,estimated_cost_usd:s.estimated_cost_usd,data_completeness_percent:s.data_completeness_percent,collected_fields:s.collected_fields})},[e,t,s]),i=(0,d.useCallback)(t=>{n(e=>({...e,...t})),j.pL.debug("Metrics updated",{sessionId:e,updates:Object.keys(t)})},[e]),l=(0,d.useCallback)(()=>{n(e=>({...e,total_turns:e.total_turns+1}))},[]),o=(0,d.useCallback)(()=>{n(e=>({...e,ai_response_count:e.ai_response_count+1}))},[]),c=(0,d.useCallback)(()=>{n(e=>({...e,user_message_count:e.user_message_count+1}))},[]),u=(0,d.useCallback)(()=>{n(e=>({...e,error_count:e.error_count+1}))},[]),m=(0,d.useCallback)(()=>{n(e=>({...e,retry_count:e.retry_count+1}))},[]),p=(0,d.useCallback)((e,t)=>{n(s=>({...s,data_completeness_percent:e,collected_fields:t}))},[]),h=(0,d.useCallback)(()=>{n(e=>({...e,feedback_provided:!0}))},[]),g=(0,d.useCallback)(()=>{n({session_id:e,user_id:t,started_at:new Date,total_turns:0,successful:!1,ai_response_count:0,user_message_count:0,error_count:0,retry_count:0,avg_response_time_ms:0,valuation_generated:!1,data_completeness_percent:0,collected_fields:[],total_tokens_used:0,estimated_cost_usd:0,feedback_provided:!1})},[e,t]),f=(0,d.useCallback)(()=>({sessionId:e,userId:t,duration:Date.now()-s.started_at.getTime(),totalTurns:s.total_turns,success:s.successful,aiResponses:s.ai_response_count,userMessages:s.user_message_count,errors:s.error_count,retries:s.retry_count,avgResponseTime:s.avg_response_time_ms,valuationGenerated:s.valuation_generated,dataCompleteness:s.data_completeness_percent,collectedFields:s.collected_fields.length,totalTokens:s.total_tokens_used,estimatedCost:s.estimated_cost_usd,feedbackProvided:s.feedback_provided}),[e,t,s]);return{metrics:s,trackModelPerformance:a,trackConversationCompletion:r,updateMetrics:i,incrementTurn:l,incrementAIResponse:o,incrementUserMessage:c,incrementError:u,incrementRetry:m,updateDataCompleteness:p,markFeedbackProvided:h,resetMetrics:g,getMetricsSummary:f}},es=(e,t)=>{let[s,n]=(0,d.useState)([]),a=(0,d.useCallback)(t=>{if(t.length<=100)return t;let s=t.slice(0,10),n=t.slice(-50),a=[...s,...n.filter(e=>!s.find(t=>t.id===e.id))];return console.warn("Message pruning: ".concat(t.length," -> ").concat(a.length," messages"),{sessionId:e,keptFirst:s.length,keptRecent:n.length,removed:t.length-a.length}),a},[e]),r=(0,d.useCallback)(e=>{n(t=>{let s="function"==typeof e?e(t):e;return s.length>=120?a(s):s})},[a]),[i,l]=(0,d.useState)(""),[o,c]=(0,d.useState)(!1),[u,m]=(0,d.useState)(!1),[p,h]=(0,d.useState)(!1),[g,f]=(0,d.useState)(void 0),[x,y]=(0,d.useState)({}),[v,b]=(0,d.useState)(null),[_,w]=(0,d.useState)(null),[N,j]=(0,d.useState)({session_id:e,user_id:t,started_at:new Date,total_turns:0,successful:!1,ai_response_count:0,user_message_count:0,error_count:0,retry_count:0,avg_response_time_ms:0,valuation_generated:!1,data_completeness_percent:0,collected_fields:[],total_tokens_used:0,estimated_cost_usd:0,feedback_provided:!1}),S=(0,d.useRef)(null),k=(0,d.useRef)(null),C=(0,d.useRef)(null);return{messages:s,input:i,isStreaming:o,isTyping:u,isThinking:p,typingContext:g,collectedData:x,valuationPreview:v,calculateOption:_,conversationMetrics:N,refs:{messagesEndRef:S,eventSourceRef:k,currentStreamingMessageRef:C,requestIdRef:(0,d.useRef)(null),hasInitializedRef:(0,d.useRef)(!1),abortControllerRef:(0,d.useRef)(null)},setMessages:r,setInput:l,setIsStreaming:c,setIsTyping:m,setIsThinking:h,setTypingContext:f,setCollectedData:y,setValuationPreview:b,setCalculateOption:w,setConversationMetrics:j}},en=e=>{let[t,s]=(0,d.useState)(""),[n,a]=(0,d.useState)(!1),r=(0,d.useRef)(""),i=(0,d.useRef)(0),l=(0,d.useRef)(),o=(0,d.useRef)(0),c=(0,d.useCallback)(e=>{r.current+=e,n||(a(!0),h())},[n,h]),u=(0,d.useCallback)((t,s)=>{if(!(null==e?void 0:e.adaptiveSpeed))return(null==e?void 0:e.baseSpeed)||50;let n=t.length-s,a=t[s];return n<50?30:t.includes("valuation")||t.includes("€")||t.includes("million")?70:a&&/[0-9€$%]/.test(a)?60:50},[null==e?void 0:e.adaptiveSpeed,null==e?void 0:e.baseSpeed]),m=(0,d.useCallback)(t=>(null==e?void 0:e.punctuationPauses)&&/[.,:\n]/.test(t),[null==e?void 0:e.punctuationPauses]),p=(0,d.useCallback)(e=>({".":200,",":100,"\n":150,":":120})[e]||0,[]),h=(0,d.useCallback)(()=>{let e=t=>{if(t-o.current>=u(r.current,i.current)){if(i.current<r.current.length){let n=r.current[i.current];if(s(r.current.substring(0,i.current+1)),i.current++,o.current=t,m(n)){setTimeout(()=>{l.current=requestAnimationFrame(e)},p(n));return}}else{a(!1);return}}l.current=requestAnimationFrame(e)};l.current=requestAnimationFrame(e)},[u,m,p]),g=(0,d.useCallback)(()=>{l.current&&cancelAnimationFrame(l.current),s(r.current),i.current=r.current.length,a(!1)},[]),f=(0,d.useCallback)(()=>{l.current&&cancelAnimationFrame(l.current),r.current="",i.current=0,s(""),a(!1)},[]);return(0,d.useEffect)(()=>()=>{l.current&&cancelAnimationFrame(l.current)},[]),{displayedText:t,isTyping:n,addToBuffer:c,complete:g,reset:f}},ea=e=>{let{input:t,onInputChange:s,onSubmit:n,isStreaming:a,disabled:r=!1,placeholder:i="Ask about your business valuation...",suggestions:l=[]}=e;return(0,c.jsx)("div",{className:"p-4 border-t border-zinc-800",children:(0,c.jsxs)("form",{onSubmit:n,className:"focus-within:bg-zinc-900/60 group flex flex-col gap-3 p-4 duration-300 w-full rounded-3xl border border-white/10 bg-zinc-900/40 text-base shadow-xl transition-all ease-in-out focus-within:border-zinc-500/40 hover:border-zinc-600/30 backdrop-blur-md",children:[(0,c.jsx)("div",{className:"relative flex items-center",children:(0,c.jsx)("textarea",{value:t,onChange:e=>s(e.target.value),onKeyPress:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),n(e))},placeholder:i,disabled:r||a,className:"textarea-seamless flex w-full rounded-md px-3 py-3 ring-offset-background placeholder:text-zinc-400 focus-visible:outline-none focus-visible:ring-0 focus-visible:ring-offset-0 disabled:cursor-not-allowed disabled:opacity-50 resize-none text-base leading-snug placeholder-shown:text-ellipsis placeholder-shown:whitespace-nowrap md:text-base max-h-[200px] bg-transparent focus:bg-transparent flex-1 text-white border-0 border-none",style:{minHeight:"80px",height:"80px"},spellCheck:"false"})}),(0,c.jsxs)("div",{className:"flex gap-2 flex-wrap items-center",children:[l.filter(Boolean).map((e,t)=>(0,c.jsx)("button",{type:"button",onClick:()=>s(e),disabled:a,className:"px-3 py-1.5 bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 hover:border-zinc-600 rounded-full text-xs text-zinc-300 hover:text-white transition-all duration-200 hover:shadow-md disabled:opacity-50 disabled:cursor-not-allowed",children:e},t)),(0,c.jsx)("div",{className:"flex flex-grow items-center justify-end gap-2",children:(0,c.jsx)("button",{type:"submit",disabled:!t.trim()||a||r,className:"submit-button-white flex h-8 w-8 items-center justify-center rounded-full transition-all duration-200 ease-out shadow-lg disabled:cursor-not-allowed disabled:opacity-50 disabled:shadow-none ".concat(a?"bg-zinc-800 scale-95 ring-2 ring-primary-500/20":"bg-white hover:bg-zinc-200 hover:shadow-white/20 active:scale-90"),children:a?(0,c.jsxs)("div",{className:"relative w-4 h-4",children:[(0,c.jsx)("div",{className:"absolute inset-0 border-2 border-zinc-600 rounded-full"}),(0,c.jsx)("div",{className:"absolute inset-0 border-2 border-t-primary-500 rounded-full animate-spin"})]}):(0,c.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",strokeLinecap:"round",strokeLinejoin:"round",className:"text-zinc-900 ml-0.5",children:[(0,c.jsx)("line",{x1:"22",y1:"2",x2:"11",y2:"13"}),(0,c.jsx)("polygon",{points:"22 2 15 22 11 13 2 9 22 2"})]})})})]})]})})};var er=s(13763),ei=s(3274),el=s(68954),eo=s(92940);(void 0).VITE_VALUATION_ENGINE_URL||(void 0).VITE_VALUATION_API_URL,(void 0).VITE_ENABLE_STREAMING,parseInt((void 0).VITE_STREAMING_TIMEOUT||"30000"),parseInt((void 0).VITE_MAX_RETRY_ATTEMPTS||"3"),(void 0).MODE;let ec={enabled:"true"===(void 0).VITE_AI_ENHANCED_MODE||!0,model:(void 0).VITE_OPENAI_MODEL||"gpt-4o-mini",showReasoning:"true"===(void 0).VITE_SHOW_AI_REASONING||!0,showHelpText:"true"===(void 0).VITE_SHOW_AI_HELP_TEXT||!0,showNarratives:"true"===(void 0).VITE_SHOW_VALUATION_NARRATIVES||!0,branding:{expertTitle:"AI Valuation Expert",levelIndicator:"Big 4 Level",showLevelBadge:"true"===(void 0).VITE_SHOW_LEVEL_BADGE||!0}};var ed=s(37151),eu=s(53225),em=s(71976);let ep=e=>{let{answer:t,reasoning:s,example:n,nudge:a,timestamp:r}=e;return(0,c.jsx)(er.E.div,{initial:{opacity:0,y:10,scale:.98},animate:{opacity:1,y:0,scale:1},transition:{duration:.3,ease:"easeOut"},className:"flex justify-start",children:(0,c.jsx)("div",{className:"max-w-[85%] mr-auto",children:(0,c.jsxs)("div",{className:"flex items-start gap-3",children:[(0,c.jsx)("div",{className:"flex-shrink-0 w-8 h-8 bg-gradient-to-br from-accent-500/20 to-accent-600/20 rounded-full flex items-center justify-center border border-accent-400/30 shadow-lg shadow-accent-500/20 mt-1",children:(0,c.jsx)(el.Z,{className:"w-4 h-4 text-accent-300"})}),(0,c.jsxs)("div",{className:"flex flex-col gap-1",children:[(0,c.jsxs)("div",{className:"rounded-2xl rounded-tl-sm px-5 py-4 bg-gradient-to-br from-accent-900/20 via-accent-800/10 to-accent-900/20 border border-accent-400/20 shadow-lg backdrop-blur-sm",children:[(0,c.jsxs)("div",{className:"flex items-center gap-2 mb-3 pb-2 border-b border-accent-400/20",children:[(0,c.jsx)(ed.Z,{className:"w-4 h-4 text-accent-300"}),(0,c.jsx)("span",{className:"text-xs font-semibold text-accent-300 uppercase tracking-wider",children:"AI Assistant"})]}),(0,c.jsxs)("div",{className:"space-y-3",children:[(0,c.jsx)("div",{className:"text-[15px] leading-relaxed text-zinc-100",children:t}),s&&(0,c.jsxs)("div",{className:"flex items-start gap-2 p-3 bg-accent-500/10 rounded-lg border border-accent-400/20",children:[(0,c.jsx)(eu.Z,{className:"w-4 h-4 text-accent-300 flex-shrink-0 mt-0.5"}),(0,c.jsxs)("div",{className:"text-sm text-accent-200 leading-relaxed",children:[(0,c.jsx)("span",{className:"font-medium text-accent-300",children:"Why it matters: "}),s]})]}),n&&(0,c.jsxs)("div",{className:"p-3 bg-accent-500/10 rounded-lg border border-accent-400/20",children:[(0,c.jsx)("div",{className:"text-xs font-medium text-accent-300 mb-1.5 uppercase tracking-wider",children:"Example:"}),(0,c.jsx)("div",{className:"text-sm text-accent-100 leading-relaxed",children:n})]}),(0,c.jsxs)("div",{className:"flex items-start gap-2 pt-3 mt-3 border-t border-accent-400/20",children:[(0,c.jsx)(em.Z,{className:"w-4 h-4 text-accent-300 flex-shrink-0 mt-0.5"}),(0,c.jsx)("div",{className:"text-sm text-accent-200 leading-relaxed",children:a})]})]})]}),r&&(0,c.jsxs)("div",{className:"text-xs text-zinc-500 ml-1 flex items-center gap-1",children:[(0,c.jsx)("span",{className:"text-accent-400",children:"●"}),r.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})]})]})]})})})};var eh=s(13231),eg=s(16717);let ef=e=>{let{businessType:t,industry:s,category:n,icon:a="\uD83C\uDFE2",confidence:r,timestamp:i}=e;return(0,c.jsx)(er.E.div,{initial:{opacity:0,y:10,scale:.98},animate:{opacity:1,y:0,scale:1},transition:{duration:.3,ease:"easeOut"},className:"flex justify-start w-full my-2",children:(0,c.jsx)("div",{className:"max-w-[85%] mr-auto w-full",children:(0,c.jsxs)("div",{className:"flex items-start gap-3",children:[(0,c.jsx)("div",{className:"flex-shrink-0 w-8 h-8 bg-primary-500/20 rounded-full flex items-center justify-center border border-primary-500/30 shadow-lg shadow-primary-500/10 mt-1",children:(0,c.jsx)(eh.Z,{className:"w-4 h-4 text-primary-400"})}),(0,c.jsxs)("div",{className:"flex flex-col gap-1 w-full",children:[(0,c.jsxs)("div",{className:"rounded-2xl rounded-tl-sm overflow-hidden border border-primary-500/20 shadow-lg backdrop-blur-sm bg-zinc-900/40",children:[(0,c.jsx)("div",{className:"px-5 py-3 bg-gradient-to-r from-primary-900/20 to-transparent border-b border-primary-500/10 flex items-center justify-between",children:(0,c.jsxs)("span",{className:"text-xs font-semibold text-primary-400 uppercase tracking-wider flex items-center gap-1.5",children:[(0,c.jsx)("span",{className:"w-1.5 h-1.5 rounded-full bg-primary-400 animate-pulse"}),"Verified Business Type"]})}),(0,c.jsxs)("div",{className:"p-5",children:[(0,c.jsxs)("div",{className:"flex items-start gap-4",children:[(0,c.jsx)("div",{className:"flex-shrink-0 w-12 h-12 rounded-xl bg-gradient-to-br from-zinc-800 to-zinc-900 border border-zinc-700/50 flex items-center justify-center text-2xl shadow-inner",children:a}),(0,c.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,c.jsx)("h3",{className:"text-lg font-semibold text-white leading-tight mb-1",children:t}),(0,c.jsxs)("div",{className:"flex flex-wrap gap-2 mt-2",children:[s&&(0,c.jsxs)("div",{className:"inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md bg-zinc-800/50 border border-zinc-700/50 text-xs font-medium text-zinc-300",children:[(0,c.jsx)(T.Z,{className:"w-3 h-3 text-zinc-400"}),s]}),n&&(0,c.jsxs)("div",{className:"inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md bg-zinc-800/50 border border-zinc-700/50 text-xs font-medium text-zinc-300",children:[(0,c.jsx)(eg.Z,{className:"w-3 h-3 text-zinc-400"}),n]})]})]})]}),(0,c.jsx)("div",{className:"mt-4 pt-3 border-t border-white/5 text-sm text-zinc-400 leading-relaxed",children:"We've successfully matched your business to our valuation database."})]})]}),i&&(0,c.jsxs)("div",{className:"text-xs text-zinc-500 ml-1 flex items-center gap-1",children:[(0,c.jsx)("span",{className:"text-primary-500/50",children:"●"}),i.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})]})]})]})})})},ex=e=>{let{suggestions:t,onSelect:s}=e,[n,a]=(0,d.useState)(!1),r=e=>{"none"===e&&a(!0),s(e)};return n?null:(0,c.jsxs)("div",{className:"mt-4 space-y-2",children:[(0,c.jsx)("div",{className:"text-xs text-zinc-400 mb-3",children:"Select the business type that best describes your business:"}),(0,c.jsx)("div",{className:"space-y-2",children:t.map(e=>(0,c.jsx)("button",{onClick:()=>r(e.number.toString()),className:"w-full text-left group relative","aria-label":"Select ".concat(e.title),children:(0,c.jsxs)("div",{className:"flex items-start gap-3 p-3 bg-zinc-800/50 border border-zinc-700/50 rounded-lg hover:border-primary-500/50 hover:bg-zinc-800/70 transition-all duration-200 cursor-pointer",children:[(0,c.jsx)("div",{className:"flex-shrink-0 w-8 h-8 bg-primary-600/20 text-primary-400 rounded-full flex items-center justify-center text-sm font-semibold",children:e.number}),(0,c.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,c.jsxs)("div",{className:"flex items-center gap-2",children:[(0,c.jsx)("span",{className:"text-lg flex-shrink-0",children:e.icon||"\uD83C\uDFE2"}),(0,c.jsx)("span",{className:"font-semibold text-white group-hover:text-primary-300 transition-colors",children:e.title})]}),e.description&&(0,c.jsx)("div",{className:"text-xs text-zinc-400 mt-1 ml-8",children:e.description}),e.category&&(0,c.jsx)("div",{className:"text-xs text-zinc-500 mt-1 ml-8 font-medium",children:e.category})]}),(0,c.jsx)("div",{className:"flex-shrink-0 opacity-0 group-hover:opacity-100 transition-opacity",children:(0,c.jsx)("div",{className:"w-2 h-2 bg-primary-500 rounded-full"})})]})},e.number))}),(0,c.jsx)("button",{onClick:()=>r("none"),className:"w-full mt-3 p-3 bg-zinc-800/30 border border-zinc-700/30 rounded-lg hover:border-zinc-600 hover:bg-zinc-800/50 transition-all duration-200 text-center","aria-label":"None of these business types match",children:(0,c.jsxs)("div",{className:"flex items-center justify-center gap-2 text-sm text-zinc-300 hover:text-white",children:[(0,c.jsx)(p.Z,{className:"w-4 h-4"}),(0,c.jsx)("span",{children:"None of these match - let me type it"})]})})]})};var ey=s(22023),ev=s(24241);let eb=e=>{let{companyName:t,registrationNumber:s,legalForm:n,foundingYear:a,industryDescription:r,confidence:i,timestamp:l}=e;return(0,c.jsx)(er.E.div,{initial:{opacity:0,y:10,scale:.98},animate:{opacity:1,y:0,scale:1},transition:{duration:.3,ease:"easeOut"},className:"flex justify-start w-full my-2",children:(0,c.jsx)("div",{className:"max-w-[85%] mr-auto w-full",children:(0,c.jsxs)("div",{className:"flex items-start gap-3",children:[(0,c.jsx)("div",{className:"flex-shrink-0 w-8 h-8 bg-primary-500/20 rounded-full flex items-center justify-center border border-primary-500/30 shadow-lg shadow-primary-500/10 mt-1",children:(0,c.jsx)(eh.Z,{className:"w-4 h-4 text-primary-400"})}),(0,c.jsxs)("div",{className:"flex flex-col gap-1 w-full",children:[(0,c.jsxs)("div",{className:"rounded-2xl rounded-tl-sm overflow-hidden border border-primary-500/20 shadow-lg backdrop-blur-sm bg-zinc-900/40",children:[(0,c.jsx)("div",{className:"px-5 py-3 bg-gradient-to-r from-primary-900/20 to-transparent border-b border-primary-500/10 flex items-center justify-between",children:(0,c.jsxs)("span",{className:"text-xs font-semibold text-primary-400 uppercase tracking-wider flex items-center gap-1.5",children:[(0,c.jsx)("span",{className:"w-1.5 h-1.5 rounded-full bg-primary-400 animate-pulse"}),"Verified Company"]})}),(0,c.jsxs)("div",{className:"p-5",children:[(0,c.jsxs)("div",{className:"flex items-start gap-4",children:[(0,c.jsx)("div",{className:"flex-shrink-0 w-12 h-12 rounded-xl bg-gradient-to-br from-zinc-800 to-zinc-900 border border-zinc-700/50 flex items-center justify-center text-2xl shadow-inner",children:"\uD83C\uDFE2"}),(0,c.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,c.jsx)("h3",{className:"text-lg font-semibold text-white leading-tight mb-1",children:t}),(0,c.jsxs)("div",{className:"flex flex-wrap gap-2 mt-2",children:[s&&(0,c.jsxs)("div",{className:"inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md bg-zinc-800/50 border border-zinc-700/50 text-xs font-medium text-zinc-300",children:[(0,c.jsx)(ey.Z,{className:"w-3 h-3 text-zinc-400"}),"Registration: ",s]}),n&&(0,c.jsxs)("div",{className:"inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md bg-zinc-800/50 border border-zinc-700/50 text-xs font-medium text-zinc-300",children:[(0,c.jsx)(T.Z,{className:"w-3 h-3 text-zinc-400"}),"Type: ",n]}),a&&(0,c.jsxs)("div",{className:"inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md bg-zinc-800/50 border border-zinc-700/50 text-xs font-medium text-zinc-300",children:[(0,c.jsx)(ev.Z,{className:"w-3 h-3 text-zinc-400"}),"Founded: ",a]}),r&&(0,c.jsxs)("div",{className:"inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md bg-zinc-800/50 border border-zinc-700/50 text-xs font-medium text-zinc-300",children:[(0,c.jsx)(T.Z,{className:"w-3 h-3 text-zinc-400"}),r]})]})]})]}),(0,c.jsx)("div",{className:"mt-4 pt-3 border-t border-white/5 text-sm text-zinc-400 leading-relaxed",children:"We've successfully verified your company in the KBO registry."})]})]}),l&&(0,c.jsxs)("div",{className:"text-xs text-zinc-500 ml-1 flex items-center gap-1",children:[(0,c.jsx)("span",{className:"text-primary-500/50",children:"●"}),l.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})]})]})]})})})},e_=e=>{let{suggestions:t,onSelect:s}=e,[n,a]=(0,d.useState)(!1),r=e=>{"none"===e&&a(!0),s(e)};return n?null:(0,c.jsxs)("div",{className:"mt-4 space-y-2",children:[(0,c.jsx)("div",{className:"text-xs text-zinc-400 mb-3",children:"Select a company from the list below:"}),(0,c.jsx)("div",{className:"space-y-2",children:t.map(e=>(0,c.jsx)("button",{onClick:()=>r(e.number.toString()),className:"w-full text-left group relative","aria-label":"Select ".concat(e.companyName),children:(0,c.jsxs)("div",{className:"flex items-start gap-3 p-3 bg-zinc-800/50 border border-zinc-700/50 rounded-lg hover:border-primary-500/50 hover:bg-zinc-800/70 transition-all duration-200 cursor-pointer",children:[(0,c.jsx)("div",{className:"flex-shrink-0 w-8 h-8 bg-primary-600/20 text-primary-400 rounded-full flex items-center justify-center text-sm font-semibold",children:e.number}),(0,c.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,c.jsxs)("div",{className:"flex items-center gap-2",children:[(0,c.jsx)(T.Z,{className:"w-4 h-4 text-zinc-400 flex-shrink-0"}),(0,c.jsx)("span",{className:"font-semibold text-white group-hover:text-primary-300 transition-colors",children:e.companyName})]}),e.registrationNumber&&(0,c.jsx)("div",{className:"text-xs text-zinc-400 mt-1 ml-6",children:e.registrationNumber})]}),(0,c.jsx)("div",{className:"flex-shrink-0 opacity-0 group-hover:opacity-100 transition-opacity",children:(0,c.jsx)("div",{className:"w-2 h-2 bg-primary-500 rounded-full"})})]})},e.number))}),(0,c.jsx)("button",{onClick:()=>r("none"),className:"w-full mt-3 p-3 bg-zinc-800/30 border border-zinc-700/30 rounded-lg hover:border-zinc-600 hover:bg-zinc-800/50 transition-all duration-200 text-center","aria-label":"None of these companies match",children:(0,c.jsxs)("div",{className:"flex items-center justify-center gap-2 text-sm text-zinc-300 hover:text-white",children:[(0,c.jsx)(p.Z,{className:"w-4 h-4"}),(0,c.jsx)("span",{children:"None of these match"})]})})]})};var ew=s(45348),eN=s(33907),ej=s(71935);let eS=e=>{let{suggestions:t,originalValue:s,onSelect:n,onDismiss:a}=e;return(0,c.jsxs)("div",{className:"suggestion-chips-container my-4",children:[(0,c.jsxs)(er.E.div,{initial:{opacity:0,y:5},animate:{opacity:1,y:0},className:"flex items-center gap-2.5 mb-3",children:[(0,c.jsx)("div",{className:"w-6 h-6 rounded-full bg-primary-500/10 border border-primary-500/20 flex items-center justify-center shadow-[0_0_10px_rgba(59,130,246,0.1)]",children:(0,c.jsx)(eN.Z,{className:"w-3.5 h-3.5 text-primary-400"})}),(0,c.jsx)("p",{className:"text-[13px] font-medium text-zinc-400 tracking-wide",children:"Did you mean one of these?"})]}),(0,c.jsx)("div",{className:"flex flex-wrap gap-2.5 ml-1",children:(0,c.jsxs)(ew.M,{mode:"popLayout",children:[t.map((e,t)=>(0,c.jsxs)(er.E.button,{initial:{opacity:0,scale:.9,y:10},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.9},transition:{delay:.05*t,duration:.2},onClick:()=>n(e.text),className:"group relative flex items-center gap-2.5 px-4 py-2.5 bg-zinc-800/40 border border-white/5 rounded-xl hover:bg-zinc-800/80 hover:border-primary-500/30 active:scale-[0.98] transition-all duration-200 shadow-sm hover:shadow-[0_4px_12px_rgba(0,0,0,0.2)] backdrop-blur-sm",children:[(0,c.jsx)("span",{className:"text-[14px] font-medium text-zinc-200 group-hover:text-white transition-colors",children:e.text}),e.confidence>.9&&(0,c.jsx)("span",{className:"flex items-center justify-center w-4 h-4 rounded-full bg-moss-500/10",children:(0,c.jsx)(eo.Z,{className:"w-3 h-3 text-moss-400"})}),(0,c.jsx)(em.Z,{className:"w-3.5 h-3.5 text-primary-400 opacity-0 -ml-2 group-hover:opacity-100 group-hover:ml-0 transition-all duration-200"}),(0,c.jsxs)("div",{className:"absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-1.5 bg-zinc-900 text-zinc-300 text-xs font-medium rounded-lg opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none border border-white/10 shadow-xl z-10",children:[e.reason,(0,c.jsx)("div",{className:"absolute top-full left-1/2 transform -translate-x-1/2 -mt-1 border-4 border-transparent border-t-zinc-900"})]})]},"suggestion-".concat(t))),s&&s.trim().length>0&&(0,c.jsxs)(er.E.button,{initial:{opacity:0,scale:.9,y:10},animate:{opacity:1,scale:1,y:0},transition:{delay:.05*t.length,duration:.2},onClick:a,className:"flex items-center gap-2 px-4 py-2.5 bg-transparent border border-white/5 rounded-xl hover:bg-white/5 hover:border-white/10 active:scale-[0.98] transition-all duration-200 group",children:[(0,c.jsxs)("span",{className:"text-[13px] font-medium text-zinc-500 group-hover:text-zinc-300 transition-colors",children:['Keep "',s,'"']}),(0,c.jsx)(ej.Z,{className:"w-3.5 h-3.5 text-zinc-600 group-hover:text-zinc-400 transition-colors"})]},"keep-original")]})})]})};function ek(e){let t;let s=[],n=/(\d+)\.\s+(.+?)(?:\n|$)/g;for(;null!==(t=n.exec(e));){let e=t[2].trim();if(e.length>1&&!e.toLowerCase().includes("best describes")){let n=e.charAt(0),a=/[\u{1F300}-\u{1F9FF}]/u.test(n),r=a?e.slice(1).trim():e,i=a?n:void 0;s.push({number:parseInt(t[1],10),id:t[1],title:r,icon:i})}}return s}function eC(e){let t=/business type|Which one best describes/i.test(e),s=/\d+\.\s+.+?(?:\n|$)/i.test(e);return t&&s}function eE(e){let t;let s=[],n=/(\d+)\.\s+\*\*(.+?)\*\*(?:\s+\(([^)]+)\))?/g;for(;null!==(t=n.exec(e));){let e=t[2].trim();if(e.length>1&&!e.toLowerCase().includes("did you mean")){var a;s.push({number:parseInt(t[1],10),companyName:e,registrationNumber:null===(a=t[3])||void 0===a?void 0:a.trim()})}}return s}function eI(e){let t=/KBO registry|Did you mean/i.test(e),s=/\d+\.\s+\*\*.*\*\*/i.test(e);return t&&s}let eL=e=>{let{question:t,buttonText:s="Create Valuation Report",onConfirm:n,timestamp:a}=e;return(0,c.jsx)(er.E.div,{initial:{opacity:0,y:10,scale:.98},animate:{opacity:1,y:0,scale:1},transition:{duration:.3,ease:"easeOut"},className:"flex justify-start",children:(0,c.jsx)("div",{className:"max-w-[85%] mr-auto",children:(0,c.jsxs)("div",{className:"flex items-start gap-3",children:[(0,c.jsx)("div",{className:"flex-shrink-0 w-8 h-8 bg-white/10 rounded-full flex items-center justify-center border border-white/10 shadow-sm mt-1",children:(0,c.jsx)(el.Z,{className:"w-4 h-4 text-primary-400"})}),(0,c.jsxs)("div",{className:"flex flex-col gap-1 flex-1",children:[(0,c.jsxs)("div",{className:"rounded-2xl rounded-tl-sm px-6 py-5 bg-white/5 text-white border border-white/10 shadow-sm backdrop-blur-sm",children:[(0,c.jsxs)("div",{className:"flex items-center gap-2 mb-4 pb-3 border-b border-white/10",children:[(0,c.jsx)(eo.Z,{className:"w-5 h-5 text-primary-400"}),(0,c.jsx)("span",{className:"text-sm font-semibold text-primary-400 uppercase tracking-wider",children:"Ready for Valuation"})]}),(0,c.jsx)("div",{className:"whitespace-pre-wrap text-[15px] leading-relaxed text-zinc-100 mb-5",children:t}),(0,c.jsxs)("button",{onClick:n,className:"w-full py-4 px-6 bg-gradient-to-r from-primary-600 to-primary-500 hover:from-primary-500 hover:to-primary-400 text-white rounded-xl font-semibold text-base shadow-lg hover:shadow-xl hover:shadow-primary-500/30 transition-all duration-200 flex items-center justify-center gap-3 active:scale-[0.98] focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 group",children:[(0,c.jsx)(eu.Z,{className:"w-5 h-5 group-hover:scale-110 transition-transform"}),(0,c.jsx)("span",{children:s}),(0,c.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",strokeLinecap:"round",strokeLinejoin:"round",className:"group-hover:translate-x-1 transition-transform",children:[(0,c.jsx)("line",{x1:"5",y1:"12",x2:"19",y2:"12"}),(0,c.jsx)("polyline",{points:"12 5 19 12 12 19"})]})]}),(0,c.jsx)("div",{className:"mt-4 pt-4 border-t border-primary-400/10",children:(0,c.jsxs)("div",{className:"flex items-center justify-between text-xs text-zinc-400",children:[(0,c.jsx)("span",{children:"Estimated completion time: 2-3 minutes"}),(0,c.jsx)("span",{className:"text-primary-400",children:"● All data collected"})]})})]}),a&&(0,c.jsxs)("div",{className:"text-xs text-zinc-500 ml-1 flex items-center gap-1",children:[(0,c.jsx)("span",{className:"text-primary-400",children:"●"}),a.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})]})]})]})})})},eR=d.memo(e=>{var t,s,n;let{message:a,onSuggestionSelect:r,onSuggestionDismiss:i,onClarificationConfirm:l,onClarificationReject:o,onKBOSuggestionSelect:u,onValuationStart:m,isTyping:p=!1,isThinking:h=!1}=e,g=(0,d.useCallback)((e,t)=>{var s;let n=a.metadata;return null!==(s=null==n?void 0:n[e])&&void 0!==s?s:t},[a.metadata]),f=(0,d.useCallback)(function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";return g(e,t)||t},[g]),x=(e,t)=>g(e,t),y=!0===g("is_ai_help"),v=g("ai_response"),b="cta_button"===f("input_type"),_=f("button_text","Create Valuation Report"),w=d.useMemo(()=>a.content?a.content.replace(/<span class="[^"]*animate-pulse[^"]*"><\/span>/g,"").trimEnd():a.content,[a.content]),N=d.useMemo(()=>{let e=f("clarification_message");return e&&eC(e)?ek(e):eC(a.content)?ek(a.content):null},[a.content,f]),j=null!==N&&N.length>0,S=(0,d.useCallback)(()=>j&&N?(0,c.jsx)("div",{className:"mt-3",children:(0,c.jsx)(ex,{suggestions:N,onSelect:u})}):null,[j,N,u]),k=d.useMemo(()=>{let e=f("clarification_message");return e&&eI(e)?eE(e):eI(a.content)?eE(a.content):null},[a.content,f]),C=null!==k&&k.length>0;if(y&&v)return(0,c.jsx)(ep,{answer:f("answer",v.answer)||a.content,reasoning:f("reasoning",v.reasoning),example:f("example",v.example),nudge:f("nudge",v.nudge)||"",timestamp:a.timestamp});if(b)return(0,c.jsx)(eL,{question:w,buttonText:_,onConfirm:()=>{"valuation_confirmed"===f("clarification_field")&&m&&m(),l(a.id)},timestamp:a.timestamp});if(!0===g("is_business_type_confirmation")){let e=f("industry_mapping")||f("industry")||void 0;return(0,c.jsx)(ef,{businessType:f("business_type",""),industry:e,category:f("category"),icon:f("icon"),confidence:x("confidence"),timestamp:a.timestamp})}return!0===g("is_company_name_confirmation")?(K.log("[MessageItem]","Rendering CompanyNameConfirmationCard",{companyName:f("company_name")||a.content||"",registrationNumber:f("registration_number"),legalForm:f("legal_form"),hasMetadata:!!a.metadata,metadataKeys:a.metadata?Object.keys(a.metadata):[]}),(0,c.jsx)(eb,{companyName:f("company_name")||a.content||"",registrationNumber:f("registration_number"),legalForm:f("legal_form"),foundingYear:x("founding_year"),industryDescription:f("industry_description"),confidence:x("confidence"),timestamp:a.timestamp})):(0,c.jsx)(er.E.div,{initial:{opacity:0,y:10,scale:.98},animate:{opacity:1,y:0,scale:1},transition:{duration:.3,ease:"easeOut"},className:"flex ".concat("user"===a.type?"justify-end":"justify-start"),children:(0,c.jsx)("div",{className:"max-w-[85%] ".concat("user"===a.type?"ml-auto":"mr-auto"),children:"user"===a.type?(0,c.jsxs)("div",{className:"flex flex-col gap-1 items-end",children:[(0,c.jsx)("div",{className:"rounded-2xl rounded-tr-sm px-5 py-3.5 bg-primary-600 text-white shadow-md",children:(0,c.jsx)("div",{className:"whitespace-pre-wrap text-[15px] leading-relaxed font-medium",children:a.content})}),(0,c.jsx)("div",{className:"text-xs text-zinc-500 text-right pr-1",children:a.timestamp.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]}):(0,c.jsxs)("div",{className:"flex items-start gap-3",children:[(0,c.jsx)("div",{className:"flex-shrink-0 w-8 h-8 bg-white/10 rounded-full flex items-center justify-center border border-white/10 shadow-sm mt-1",children:a.isStreaming||p||h?(0,c.jsx)(ei.Z,{className:"w-4 h-4 text-primary-400 animate-spin"}):(0,c.jsx)(el.Z,{className:"w-4 h-4 text-primary-400"})}),(0,c.jsxs)("div",{className:"flex flex-col gap-1",children:[(0,c.jsxs)("div",{className:"rounded-2xl rounded-tl-sm px-5 py-3.5 bg-white/5 text-white border border-white/10 shadow-sm backdrop-blur-sm",children:[(0,c.jsx)("div",{className:"whitespace-pre-wrap text-[15px] leading-relaxed text-zinc-100",children:w}),"suggestion"===a.type&&g("suggestions")&&(0,c.jsx)("div",{className:"mt-4",children:(0,c.jsx)(eS,{suggestions:(g("suggestions")||[]).map(e=>({text:(null==e?void 0:e.text)||"",confidence:(null==e?void 0:e.confidence)||0,reason:(null==e?void 0:e.reason)||""})),originalValue:f("originalValue",""),onSelect:r,onDismiss:i})}),S(),(()=>{var e,t;let s=(null===(e=a.content)||void 0===e?void 0:e.includes("No problem!"))&&(null===(t=a.content)||void 0===t?void 0:t.includes("What's your company name?"));return C&&k&&!s&&(0,c.jsx)("div",{className:"mt-3",children:(0,c.jsx)(e_,{suggestions:k,onSelect:u})})})(),(null===(t=a.metadata)||void 0===t?void 0:t.needs_confirmation)&&!C&&!j&&(null===(s=a.metadata)||void 0===s?void 0:s.collected_field)!=="business_type"&&(null===(n=a.metadata)||void 0===n?void 0:n.collected_field)!=="company_name"&&(0,c.jsxs)(er.E.div,{initial:{opacity:0,y:5},animate:{opacity:1,y:0},transition:{delay:.2},className:"flex flex-col gap-2 mt-4 p-3 bg-white/5 rounded-xl border border-white/10",children:[(0,c.jsx)("p",{className:"text-xs text-zinc-400 font-medium uppercase tracking-wider mb-1",children:"Confirm Details"}),(0,c.jsxs)("div",{className:"flex gap-3",children:[(0,c.jsxs)("button",{onClick:()=>l(a.id),className:"flex-1 py-2.5 px-4 bg-primary-600/20 hover:bg-primary-600/30 border border-primary-500/30 hover:border-primary-500/50 text-primary-300 rounded-lg text-sm font-medium transition-all flex items-center justify-center gap-2 active:scale-[0.98]",children:[(0,c.jsx)(eo.Z,{className:"h-4 w-4"}),"Yes, that's correct"]}),(0,c.jsx)("button",{onClick:()=>o(a.id),className:"px-4 py-2.5 bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 hover:border-zinc-600 text-zinc-400 hover:text-zinc-300 rounded-lg text-sm font-medium transition-all active:scale-[0.98]",children:"No, edit"})]})]}),ec.showHelpText&&f("help_text")&&(0,c.jsx)("div",{className:"mt-3 pt-3 border-t border-white/10",children:(0,c.jsxs)("p",{className:"text-xs text-zinc-400 flex items-start gap-1.5",children:[(0,c.jsx)("span",{className:"mt-0.5",children:"ℹ️"}),(0,c.jsx)("span",{className:"leading-relaxed",children:f("help_text")})]})}),ec.showNarratives&&f("valuation_narrative")&&(0,c.jsxs)("div",{className:"mt-3 p-3 bg-primary-600/10 rounded-xl border border-primary-600/20",children:[(0,c.jsx)("h4",{className:"text-xs font-semibold text-primary-300 mb-1 uppercase tracking-wider",children:"Valuation Insight"}),(0,c.jsx)("div",{className:"text-sm text-zinc-300 whitespace-pre-wrap leading-relaxed",children:f("valuation_narrative")})]})]}),(0,c.jsx)("div",{className:"text-xs text-zinc-500 ml-1",children:a.timestamp.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]})]})})})});eR.displayName="MessageItem";let eT=()=>(0,c.jsxs)(er.E.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,scale:.95},className:"max-w-[80%] mr-auto",children:[(0,c.jsxs)("div",{className:"flex items-start gap-3",children:[(0,c.jsx)("div",{className:"flex-shrink-0 w-8 h-8 bg-white/10 rounded-full flex items-center justify-center border border-white/10 shadow-sm",children:(0,c.jsx)(el.Z,{className:"w-4 h-4 text-primary-400"})}),(0,c.jsx)("div",{className:"rounded-2xl rounded-tl-sm px-5 py-3.5 bg-white/5 text-white border border-white/10 shadow-sm backdrop-blur-sm",children:(0,c.jsxs)("div",{className:"flex items-center gap-3",children:[(0,c.jsx)("div",{className:"flex gap-1.5 h-2 items-center",children:[0,1,2].map(e=>(0,c.jsx)(er.E.span,{className:"w-1.5 h-1.5 bg-primary-400/80 rounded-full",animate:{y:["0%","-40%","0%"],opacity:[.4,1,.4],scale:[.9,1.1,.9]},transition:{duration:.8,repeat:1/0,ease:"easeInOut",delay:.12*e}},e))}),(0,c.jsx)("span",{className:"text-[13px] font-medium text-zinc-400 tracking-wide",children:"AI is thinking..."})]})})]}),(0,c.jsx)("div",{className:"text-xs text-zinc-500 mt-1 text-left ml-11",children:new Date().toLocaleTimeString()})]}),eM=e=>{var t;let{messages:s,isTyping:n,isThinking:a,isInitializing:r,onSuggestionSelect:i,onSuggestionDismiss:l,onClarificationConfirm:o,onClarificationReject:d,onKBOSuggestionSelect:u,onValuationStart:m,calculateOption:p,valuationPreview:h,messagesEndRef:g}=e;return(0,c.jsxs)("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:[(0,c.jsx)(ew.M,{initial:!1,mode:"popLayout",children:s.filter(e=>{var t,s;return(null===(t=e.metadata)||void 0===t?void 0:t.is_business_type_confirmation)===!0||(null===(s=e.metadata)||void 0===s?void 0:s.is_company_name_confirmation)===!0||e.content&&e.content.trim().length>0}).map(e=>(0,c.jsx)(eR,{message:e,onSuggestionSelect:i,onSuggestionDismiss:l,onClarificationConfirm:o,onClarificationReject:d,onKBOSuggestionSelect:u,onValuationStart:m,isTyping:n,isThinking:a},e.id))}),(0,c.jsx)(ew.M,{children:(n||r&&0===s.length)&&(0,c.jsx)("div",{className:"flex justify-start",children:(0,c.jsx)(eT,{})},"typing-indicator")}),p&&(0,c.jsx)("div",{className:"flex justify-center",children:(0,c.jsx)("button",{onClick:()=>{},className:"px-6 py-2 bg-accent-600 text-white rounded-lg hover:bg-accent-500 transition-colors",children:"Calculate Now"})}),h&&(0,c.jsxs)("div",{className:"bg-primary-600/10 p-4 rounded-lg border border-primary-600/30",children:[(0,c.jsx)("h3",{className:"font-semibold text-primary-300 mb-2",children:"Valuation Preview"}),(0,c.jsxs)("div",{className:"text-2xl font-bold text-primary-200",children:["$",null===(t=h.value)||void 0===t?void 0:t.toLocaleString()]})]}),(0,c.jsx)("div",{ref:g})]})},ez=e=>{let{sessionId:t,userId:s,onMessageComplete:n,onValuationComplete:a,onValuationStart:r,onReportUpdate:i,onDataCollected:l,onValuationPreview:o,onCalculateOptionAvailable:u,onProgressUpdate:m,onReportSectionUpdate:p,onSectionLoading:h,onSectionComplete:g,onReportComplete:f,onContextUpdate:x,onHtmlPreviewUpdate:y,onPythonSessionIdReceived:b,className:_="",disabled:w=!1,initialMessage:N=null,autoSend:S=!1,initialData:k,initialMessages:C=[],isRestoring:E=!1,isSessionInitialized:I=!1,pythonSessionId:L,isRestorationComplete:R=!1}=e,{user:T}=(0,v.a)(),[M,D]=d.useState(null),P=null!=L?L:M,O=(0,d.useCallback)(e=>{D(e),e&&b&&b(e)},[b]);(0,d.useEffect)(()=>{void 0!==L&&L!==M&&D(L)},[L,M]);let V=es(t,s),U=function(e){let{sessionId:t,messages:s,setMessages:n,onMessageComplete:a}=e,r=(0,d.useMemo)(()=>new F,[]),i=(0,d.useCallback)(e=>{let t=null==e?void 0:e.metadata;if(!t)return!1;let s=t.collected_field||t.clarification_field||t.field;return"cta_button"===t.input_type&&"valuation_confirmed"===s},[]),l=(0,d.useCallback)((e,t)=>i(t)?e.filter(e=>!i(e)):e,[i]);return{addMessage:(0,d.useCallback)(e=>{let t=l(s,e),a=r.addMessage(t,e);return n(a.updatedMessages),a},[s,n,l,r]),updateStreamingMessage:(0,d.useCallback)((e,t,i)=>{let l=s.find(e=>e.isStreaming&&!e.isComplete),o=(null==l?void 0:l.id)||"",c=r.updateStreamingMessage(s,o,e,null!=t&&t,i);if(n(c),t){let e=c.find(e=>"ai"===e.type&&e.isComplete&&!e.isStreaming);e&&a&&a(e)}},[s,n,r,a]),dedupeValuationCTA:l,isValuationReadyCTA:i}}({sessionId:t,messages:V.messages,setMessages:V.setMessages,onMessageComplete:n}),{suggestions:B}=function(e){let{messages:t}=e,s=e=>{switch(e){case"business_type":return["SaaS Platform","E-commerce Store","Consulting Firm","Digital Agency"];case"revenue":return["$1M - $5M ARR","$5M - $10M ARR","$10M - $50M ARR","$50M+ ARR"];case"employee_count":return["1-10 team","11-50 team","51-200 team","200+ team"];case"industry":return["Technology","Healthcare","Finance","Retail","Manufacturing"];case"country_code":return["United States","United Kingdom","Germany","France","Canada"];default:return[]}};return{suggestions:(0,d.useMemo)(()=>{if(0===t.length)return[];let e=t[t.length-1];if((null==e?void 0:e.type)==="ai"&&e.metadata){let t=e.metadata,n=t.collected_field||t.clarification_field||t.field;if(n)return s(n)}return[]},[t,s]),getSuggestionsForField:s}}({messages:V.messages}),H=function(e){let{sessionId:t,userId:s,messages:n,setMessages:a,setIsStreaming:r,setIsTyping:i,setIsThinking:l,setTypingContext:o,setCollectedData:c,setValuationPreview:u,setCalculateOption:m,updateStreamingMessage:p,onValuationComplete:h,onReportUpdate:g,onDataCollected:f,onValuationPreview:x,onCalculateOptionAvailable:y,onProgressUpdate:v,onReportSectionUpdate:b,onSectionLoading:_,onSectionComplete:w,onReportComplete:N,onContextUpdate:S,onHtmlPreviewUpdate:k}=e,C=(0,d.useRef)(null),E=(0,d.useRef)(null);return(0,d.useRef)(null),(0,d.useEffect)(()=>{let e={current:null},s={current:null};return C.current=new J({current:null},{current:null}),E.current=new G(t,{updateStreamingMessage:p,setIsStreaming:r,setIsTyping:i,setIsThinking:l,setTypingContext:o,setCollectedData:c,setValuationPreview:u,setCalculateOption:m,addMessage:e=>(a(t=>[...t,{...e,id:"msg-".concat(Date.now()),timestamp:new Date}]),{updatedMessages:[],newMessage:{}}),onValuationComplete:h,onReportUpdate:g,onDataCollected:f,onValuationPreview:x,onCalculateOptionAvailable:y,onProgressUpdate:v,onReportSectionUpdate:b,onSectionLoading:_,onSectionComplete:w,onReportComplete:N,onContextUpdate:S,onHtmlPreviewUpdate:k}),()=>{e.current&&e.current.close(),s.current&&s.current.abort()}},[t,a,r,i,l,o,c,u,m,p,h,g,f,x,y,v,b,_,w,N,S,k]),{startStreaming:(0,d.useCallback)(async e=>{if(!C.current||!E.current)throw Error("Streaming coordinator not initialized");if(!e||!e.trim()){j.pL.warn("Attempted to start streaming with empty input",{sessionId:t});return}let n=e=>{j.pL.error("Streaming error",{error:e.message,sessionId:t,stack:e.stack}),r(!1),a(t=>[...t,{id:"error-".concat(Date.now()),type:"system",content:"Error: ".concat(e.message),timestamp:new Date}])};try{r(!0),E.current.reset(),await C.current.startStreaming(t,e,s,{setIsStreaming:r,addMessage:e=>(a(t=>[...t,{...e,id:"msg-".concat(Date.now()),timestamp:new Date}]),{updatedMessages:[],newMessage:{}}),updateStreamingMessage:p,extractBusinessModelFromInput:z,extractFoundingYearFromInput:A,onStreamStart:()=>{var e;null===(e=E.current)||void 0===e||e.reset()}},e=>{try{var s;null===(s=E.current)||void 0===s||s.handleEvent(e)}catch(e){j.pL.error("Error handling streaming event",{error:e instanceof Error?e.message:String(e),sessionId:t})}},n)}catch(e){throw r(!1),e instanceof Error&&n(e),e}},[t,s,r,a,p,S]),stopStreaming:(0,d.useCallback)(()=>{C.current&&C.current.clearCurrentRequest(),r(!1)},[r]),isStreaming:!1}}({sessionId:t,userId:null!=s?s:null==T?void 0:T.id,messages:V.messages,setMessages:V.setMessages,setIsStreaming:V.setIsStreaming,setIsTyping:V.setIsTyping,setIsThinking:V.setIsThinking,setTypingContext:V.setTypingContext,setCollectedData:V.setCollectedData,setValuationPreview:V.setValuationPreview,setCalculateOption:V.setCalculateOption,updateStreamingMessage:U.updateStreamingMessage,onValuationComplete:a,onReportUpdate:i,onDataCollected:l,onValuationPreview:o,onCalculateOptionAvailable:u,onProgressUpdate:m,onReportSectionUpdate:p,onSectionLoading:h,onSectionComplete:g,onReportComplete:f,onContextUpdate:x,onHtmlPreviewUpdate:y}),W=(0,d.useCallback)(async e=>{let s=null!=e?e:V.input;if(!s||!s.trim()){j.pL.warn("Attempted to submit empty input",{sessionId:t});return}try{U.addMessage({type:"user",content:s.trim(),role:"user"}),V.setInput(""),await H.startStreaming(s.trim())}catch(e){j.pL.error("Stream submission failed",{error:e,sessionId:t}),V.setIsStreaming(!1)}},[V.input,V.setInput,V.setIsStreaming,H,U,t]),q={handleSuggestionSelect:(0,d.useCallback)(e=>{V.setInput(e),W(e)},[V.setInput,W]),handleSuggestionDismiss:(0,d.useCallback)(()=>{},[]),handleClarificationConfirm:(0,d.useCallback)(e=>{V.setInput("Yes"),W("Yes")},[V.setInput,W]),handleClarificationReject:(0,d.useCallback)(e=>{V.setInput("No"),W("No")},[V.setInput,W]),handleKBOSuggestionSelect:(0,d.useCallback)(e=>{V.setInput(e),W(e)},[V.setInput,W])},Z=(0,d.useRef)("");(0,d.useEffect)(()=>{if(C&&C.length>0){let e=C.map(e=>e.id).join(",");(0===V.messages.length||Z.current!==e)&&(j.pL.info("✅ Restoring conversation messages in StreamingChat",{sessionId:t,messagesCount:C.length,fingerprint:e}),V.setMessages(C),Z.current=e)}},[C,t,V.messages.length,V.setMessages]);let{isInitializing:K}=ee(t,s,{addMessage:U.addMessage,setMessages:V.setMessages,getCurrentMessages:()=>V.messages,user:T,initialData:k,initialMessages:C,isRestoring:E,isSessionInitialized:I,pythonSessionId:P,isRestorationComplete:R,onSessionIdUpdate:O}),{trackModelPerformance:Y,trackConversationCompletion:$}=et(t,s),{complete:X}=en({baseSpeed:50,adaptiveSpeed:!0,punctuationPauses:!0,showCursor:!0}),Q=(0,d.useCallback)(async e=>{if(e&&e.preventDefault(),V.input.trim())try{await W()}catch(e){j.pL.error("Stream submission failed",{error:e,sessionId:t})}},[V.input,W,t]);return(0,c.jsxs)("div",{className:"flex h-full flex-col overflow-hidden flex-1 ".concat(_),children:[(0,c.jsx)(eM,{messages:V.messages,isTyping:V.isTyping,isThinking:V.isThinking,isInitializing:K,onSuggestionSelect:q.handleSuggestionSelect,onSuggestionDismiss:q.handleSuggestionDismiss,onClarificationConfirm:q.handleClarificationConfirm,onClarificationReject:q.handleClarificationReject,onKBOSuggestionSelect:q.handleKBOSuggestionSelect,onValuationStart:r,calculateOption:V.calculateOption,valuationPreview:V.valuationPreview,messagesEndRef:V.refs.messagesEndRef}),(0,c.jsx)(ea,{input:V.input,onInputChange:V.setInput,onSubmit:Q,isStreaming:V.isStreaming,disabled:w,placeholder:"Ask about your business valuation...",suggestions:B})]})},eA=(0,d.memo)(e=>{let{sessionId:t,userId:s,restoredMessages:n,isRestoring:a,isRestorationComplete:r,isSessionInitialized:i,pythonSessionId:l,onPythonSessionIdReceived:o,onValuationComplete:d,onValuationStart:u,onReportUpdate:m,onDataCollected:p,onValuationPreview:h,onCalculateOptionAvailable:g,onProgressUpdate:f,onReportSectionUpdate:x,onSectionLoading:y,onSectionComplete:v,onReportComplete:b,onContextUpdate:_,onHtmlPreviewUpdate:w,initialMessage:N,autoSend:j,initialData:S}=e;return(0,c.jsx)("div",{className:"h-full",children:(0,c.jsx)(U,{fallback:(0,c.jsx)("div",{className:"flex items-center justify-center h-full",children:(0,c.jsxs)("div",{className:"text-center",children:[(0,c.jsx)("p",{className:"text-zinc-400 mb-4",children:"Chat temporarily unavailable. Please refresh."}),(0,c.jsx)("button",{onClick:()=>window.location.reload(),className:"px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700",children:"Refresh"})]})}),children:(0,c.jsx)(ez,{sessionId:t,userId:s,initialMessages:n,isRestoring:a&&!r,isSessionInitialized:i,pythonSessionId:l,isRestorationComplete:r,onPythonSessionIdReceived:o,onValuationComplete:d,onValuationStart:u,onReportUpdate:m,onDataCollected:p,onValuationPreview:h,onCalculateOptionAvailable:g,onProgressUpdate:f,onReportSectionUpdate:x,onSectionLoading:y,onSectionComplete:v,onReportComplete:b,onContextUpdate:_,onHtmlPreviewUpdate:w,className:"h-full",placeholder:"Ask about your business valuation...",initialMessage:N,autoSend:j,initialData:S})})})});eA.displayName="ConversationPanel";var eD=s(39451),eP=s(7746),eO=s(6884);let eV=e=>{let{result:t}=e;if(!t)return(0,c.jsxs)("div",{className:"flex flex-col items-center justify-center h-full p-8",children:[(0,c.jsx)(eP.Z,{className:"w-16 h-16 text-zinc-400 mb-4"}),(0,c.jsx)("p",{className:"text-zinc-500",children:"No valuation data available"})]});let s=t.html_report||null,n=async()=>{if(!s){j.a.error("Cannot copy: HTML report not available",{valuationId:t.valuation_id});return}try{await navigator.clipboard.writeText(s),j.a.debug("HTML report copied to clipboard",{valuationId:t.valuation_id})}catch(e){j.a.error("Failed to copy HTML",{error:e,valuationId:t.valuation_id})}};if(!s||0===s.trim().length){var a;return(0,c.jsxs)("div",{className:"h-full flex flex-col bg-zinc-900",children:[(0,c.jsx)("div",{className:"p-4 border-b border-zinc-800 flex items-center justify-between",children:(0,c.jsx)("h3",{className:"text-white font-medium",children:"HTML Report"})}),(0,c.jsxs)("div",{className:"flex-1 flex flex-col items-center justify-center p-8",children:[(0,c.jsx)(eP.Z,{className:"w-16 h-16 text-rust-400 mb-4"}),(0,c.jsx)("h3",{className:"text-lg font-semibold text-white mb-2",children:"HTML Report Not Available"}),(0,c.jsx)("p",{className:"text-sm text-zinc-400 mb-4 text-center max-w-md",children:"The server-generated HTML report is not available. This indicates an issue with the valuation response. Fallback HTML generation has been removed per bank-grade standards."}),(0,c.jsxs)("div",{className:"text-xs text-zinc-500 text-center",children:[(0,c.jsxs)("p",{children:["Valuation ID: ",t.valuation_id||"N/A"]}),(0,c.jsxs)("p",{children:["HTML Report: ",t.html_report?"Present but empty":"Not present"]}),(0,c.jsxs)("p",{children:["HTML Length: ",(null===(a=t.html_report)||void 0===a?void 0:a.length)||0," characters"]})]})]})]})}return(0,c.jsxs)("div",{className:"h-full flex flex-col bg-zinc-900",children:[(0,c.jsxs)("div",{className:"p-4 border-b border-zinc-800 flex items-center justify-between",children:[(0,c.jsx)("h3",{className:"text-white font-medium",children:"HTML Report"}),(0,c.jsxs)("button",{onClick:n,className:"px-3 py-1.5 bg-primary-600 text-white rounded text-sm hover:bg-primary-700 flex items-center gap-2 transition-colors",children:[(0,c.jsx)(eO.Z,{className:"w-4 h-4"}),"Copy HTML"]})]}),(0,c.jsx)("div",{className:"flex-1 overflow-auto p-4",children:(0,c.jsx)("pre",{className:"text-xs text-zinc-300 whitespace-pre-wrap font-mono",children:s})})]})};var eU=s(38263),eF=s(7054);let eB=()=>(0,c.jsxs)("div",{className:"flex flex-col items-center justify-center h-full p-8 text-center bg-canvas",children:[(0,c.jsx)("div",{className:"w-12 h-12 sm:w-16 sm:h-16 rounded-full bg-primary-50 flex items-center justify-center mb-3 sm:mb-4 transition-all duration-300 hover:scale-110",children:(0,c.jsx)(eu.Z,{className:"w-6 h-6 sm:w-8 sm:h-8 text-primary-500"})}),(0,c.jsx)("h3",{className:"mt-4 text-lg font-semibold text-slate-ink",children:"Reports will appear here"}),(0,c.jsx)("p",{className:"mt-2 text-sm text-gray-600 max-w-sm leading-relaxed",children:"Start a conversation in the chat to generate insights and reports about your valuation"})]}),eH=d.lazy(()=>Promise.all([s.e(581),s.e(181)]).then(s.bind(s,74181)).then(e=>({default:e.ValuationInfoPanel}))),eW=d.lazy(()=>s.e(595).then(s.bind(s,70595)).then(e=>({default:e.Results}))),eq=e=>{let{message:t="Loading..."}=e;return(0,c.jsx)("div",{className:"flex items-center justify-center p-8",children:(0,c.jsxs)("div",{className:"flex items-center gap-3",children:[(0,c.jsx)("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-primary-600"}),(0,c.jsx)("span",{className:"text-zinc-600",children:t})]})})},eG=d.memo(e=>{let{className:t=""}=e,s=R(),[n,a]=(0,d.useState)("preview");return(0,c.jsxs)("div",{className:"h-full min-h-[400px] lg:min-h-0 flex flex-col bg-white overflow-hidden ".concat(t),children:[(0,c.jsx)("div",{className:"flex border-b border-zinc-200",children:[{id:"preview",label:"Preview"},{id:"source",label:"Source"},{id:"info",label:"Info"}].map(e=>(0,c.jsx)("button",{onClick:()=>a(e.id),className:"px-4 py-3 text-sm font-medium border-b-2 transition-colors ".concat(n===e.id?"border-primary-500 text-primary-600":"border-transparent text-zinc-500 hover:text-zinc-700 hover:border-zinc-300"),children:e.label},e.id))}),(0,c.jsx)("div",{className:"flex-1 overflow-y-auto",children:(()=>{var e;let t=!!(null===(e=s.valuationResult)||void 0===e?void 0:e.html_report),a=s.isGenerating;switch(n){case"preview":return(0,c.jsxs)("div",{className:"h-full",children:[!t&&!a&&(0,c.jsxs)("div",{className:"flex flex-col items-center justify-center h-full p-6 sm:p-8 text-center",children:[(0,c.jsx)("div",{className:"w-12 h-12 sm:w-16 sm:h-16 rounded-full bg-zinc-100 flex items-center justify-center mb-3 sm:mb-4",children:(0,c.jsx)(eu.Z,{className:"w-6 h-6 sm:w-8 sm:h-8 text-zinc-400"})}),(0,c.jsx)("h3",{className:"text-base sm:text-lg font-semibold text-zinc-900 mb-2",children:"Valuation Preview"}),(0,c.jsx)("p",{className:"text-xs sm:text-sm text-zinc-500 max-w-xs",children:"Your valuation report will appear here once the conversation is complete."})]}),t?(0,c.jsx)(d.Suspense,{fallback:(0,c.jsx)(eq,{message:"Loading report..."}),children:(0,c.jsx)(eW,{})}):a?(0,c.jsx)(eB,{}):null]});case"source":return(0,c.jsx)(eV,{result:s.valuationResult});case"info":return(0,c.jsx)("div",{className:"h-full",children:s.isGenerating?(0,c.jsx)(eU.G,{steps:eF.O,variant:"light",centered:!0}):s.valuationResult?(0,c.jsx)(d.Suspense,{fallback:(0,c.jsx)(eq,{message:"Loading calculation details..."}),children:(0,c.jsx)(eH,{result:s.valuationResult})}):(0,c.jsxs)("div",{className:"flex flex-col items-center justify-center h-full p-6 sm:p-8 text-center",children:[(0,c.jsx)("div",{className:"w-12 h-12 sm:w-16 sm:h-16 rounded-full bg-zinc-100 flex items-center justify-center mb-3 sm:mb-4",children:(0,c.jsx)(eD.Z,{className:"w-6 h-6 sm:w-8 sm:h-8 text-zinc-400"})}),(0,c.jsx)("h3",{className:"text-base sm:text-lg font-semibold text-zinc-900 mb-2",children:"Calculation Details"}),(0,c.jsx)("p",{className:"text-xs sm:text-sm text-zinc-500 max-w-xs",children:"Detailed calculation breakdown will appear here once the conversation is complete."})]})});default:return null}})()})]})});eG.displayName="ReportPanel";let eZ=d.memo(e=>{var t,n,a,r,i,l,o;let{reportId:m,onComplete:p,initialQuery:h=null,autoSend:k=!1}=e,{user:I}=(0,v.a)(),L=R(),T=E(),{setResult:M,updateFormData:z}=(0,w.useValuationStore)(),[A,D]=(0,d.useState)([]),[P,V]=(0,d.useState)(!1),U=(0,d.useCallback)(e=>{D(e);let t=N(e);z(t),j.pL.info("Conversational flow collected data:",t)},[z]),F=(0,d.useCallback)(e=>{let t=N(e);z(t),j.pL.info("Conversational flow collection complete:",t),V(!1)},[z]),B=(0,d.useCallback)(e=>{j.pL.debug("Conversational flow progress:",e)},[]),[H,W]=(0,d.useState)(!1),[q,G]=(0,d.useState)(!1),[Z,K]=(0,d.useState)("chat"),[Y,$]=(0,d.useState)(!1),[X,J]=(0,d.useState)(()=>{try{let e=localStorage.getItem("upswitch-panel-width");if(e){let t=parseFloat(e);if(!isNaN(t)&&t>=f.MIN_WIDTH&&t<=f.MAX_WIDTH)return t}}catch(e){j.pL.warn("Failed to load saved panel width",{error:e})}return f.DEFAULT_WIDTH}),[Q,ee]=(0,d.useState)(!1);(0,d.useEffect)(()=>{let e=()=>G(window.innerWidth<1024);return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]),(0,d.useEffect)(()=>{try{localStorage.setItem("upswitch-panel-width",X.toString())}catch(e){j.pL.warn("Failed to save panel width",{error:e})}},[X]),(0,d.useEffect)(()=>{L.valuationResult&&M(L.valuationResult)},[L.valuationResult,M]);let et=(0,d.useCallback)(e=>{let t=Math.max(f.MIN_WIDTH,Math.min(f.MAX_WIDTH,e));2>Math.abs(t-f.DEFAULT_WIDTH)?J(f.DEFAULT_WIDTH):J(t)},[]),es=(0,d.useCallback)(()=>{let e=(0,S.rg)();window.location.href=_.reportById(e)},[]),en=(0,d.useCallback)(async()=>{if(L.valuationResult&&L.valuationResult.html_report)try{var e,t,n,a,r,i;let{DownloadService:l}=await Promise.all([s.e(581),s.e(673)]).then(s.bind(s,55673)),o={companyName:(null===(e=L.businessProfile)||void 0===e?void 0:e.company_name)||"Company",valuationAmount:L.valuationResult.equity_value_mid,valuationDate:new Date,method:L.valuationResult.methodology||"DCF Analysis",confidenceScore:L.valuationResult.confidence_score,inputs:{revenue:null===(t=L.businessProfile)||void 0===t?void 0:t.revenue,ebitda:null===(n=L.businessProfile)||void 0===n?void 0:n.ebitda,industry:null===(a=L.businessProfile)||void 0===a?void 0:a.industry,employees:null===(r=L.businessProfile)||void 0===r?void 0:r.employees},assumptions:{growth_rate:"5%",discount_rate:"10%",terminal_growth:"2%"},htmlContent:L.valuationResult.html_report||""};await l.downloadPDF(o,{format:"pdf",filename:l.getDefaultFilename(null===(i=L.businessProfile)||void 0===i?void 0:i.company_name,"pdf")})}catch(e){j.pL.error("PDF download failed",{error:e,reportId:m})}},[L.valuationResult,L.businessProfile,m]),ea=(0,d.useCallback)(e=>{j.pL.info("Python session ID received, updating conversation state",{sessionId:e,reportId:m}),T.setPythonSessionId(e)},[T,m]),er=(0,d.useCallback)(async e=>{T.setValuationResult(e),p(e),I||void 0===e.creditsRemaining||b.u.setCredits(e.creditsRemaining)},[T,p,I]),ei=!!I||b.u.hasCredits();return(0,c.jsx)(C,{hasCredits:ei,isBlocked:!1,showOutOfCreditsModal:!1,onCloseModal:()=>{},onSignUp:()=>{j.pL.info("User clicked sign up from out of credits modal")},onTryManual:()=>{j.pL.info("User clicked try manual flow from out of credits modal")},children:(0,c.jsxs)("div",{className:"flex flex-col h-full overflow-hidden",children:[(0,c.jsx)(y.x,{onRefresh:es,onDownload:en,onFullScreen:()=>W(!0),isGenerating:L.isGenerating,user:I,valuationName:"Valuation",valuationId:null===(t=L.valuationResult)||void 0===t?void 0:t.valuation_id,activeTab:"preview",onTabChange:()=>{},companyName:null===(n=L.businessProfile)||void 0===n?void 0:n.company_name,valuationMethod:null===(a=L.valuationResult)||void 0===a?void 0:a.methodology}),L.error&&(0,c.jsx)("div",{className:"mx-4 mb-4",children:(0,c.jsxs)("div",{className:"bg-rust-500/20 border border-rust-600/30 rounded-lg p-4",children:[(0,c.jsxs)("div",{className:"flex items-center gap-2 text-rust-300",children:[(0,c.jsx)("span",{className:"text-rust-400",children:"⚠️"}),(0,c.jsx)("span",{className:"font-medium",children:"Error"})]}),(0,c.jsx)("p",{className:"text-rust-200 text-sm mt-1",children:L.error})]})}),(0,c.jsx)(O,{showPreConversationSummary:Y,onTogglePreConversationSummary:()=>$(!1)}),(0,c.jsxs)("div",{className:"flex flex-col lg:flex-row flex-1 overflow-hidden mx-4 my-4 rounded-lg border border-zinc-800",style:{transition:"width 150ms ease-out"},children:[(0,c.jsx)("div",{className:"".concat(q?"chat"===Z?"w-full":"hidden":""," h-full flex flex-col bg-zinc-900 border-r border-zinc-800 w-full lg:w-auto"),style:{width:q?"100%":"".concat(X,"%")},children:(0,c.jsx)("div",{className:"flex-1 overflow-y-auto",children:Q?(0,c.jsxs)("div",{className:"p-4",children:[(0,c.jsxs)("div",{className:"mb-4",children:[(0,c.jsx)("h3",{className:"text-lg font-semibold text-white mb-2",children:"Data Collection"}),(0,c.jsx)("p",{className:"text-sm text-zinc-400",children:"Using the same data collection system as manual forms, but in conversational context."})]}),(0,c.jsx)(u.hK,{method:"manual_form",onDataCollected:U,onProgressUpdate:B,onComplete:F,initialData:{company_name:null===(r=L.businessProfile)||void 0===r?void 0:r.company_name,revenue:null===(i=L.businessProfile)||void 0===i?void 0:i.revenue,ebitda:null===(l=L.businessProfile)||void 0===l?void 0:l.ebitda,number_of_employees:null===(o=L.businessProfile)||void 0===o?void 0:o.number_of_employees}})]}):(0,c.jsx)(eA,{sessionId:L.sessionId,userId:null==I?void 0:I.id,restoredMessages:L.messages.filter(e=>e.isComplete),isRestoring:!1,isRestorationComplete:L.isRestored,isSessionInitialized:L.isInitialized,pythonSessionId:L.pythonSessionId,onPythonSessionIdReceived:ea,onValuationComplete:er,onValuationStart:()=>T.setGenerating(!0),onReportUpdate:()=>{},onDataCollected:e=>{e.field&&void 0!==e.value&&j.pL.debug("Data collected from conversational flow",{field:e.field,value:e.value})},onValuationPreview:()=>{},onCalculateOptionAvailable:()=>{},onProgressUpdate:()=>{},onReportSectionUpdate:()=>{},onSectionLoading:()=>{},onSectionComplete:()=>{},onReportComplete:()=>{},onContextUpdate:()=>{},onHtmlPreviewUpdate:()=>{},initialMessage:h,autoSend:k})})}),(0,c.jsx)(x,{onResize:et,leftWidth:X,isMobile:q}),(0,c.jsx)("div",{className:"".concat(q?"preview"===Z?"w-full":"hidden":""," h-full min-h-[400px] lg:min-h-0 w-full lg:w-auto border-t lg:border-t-0 border-zinc-800"),style:{width:q?"100%":"".concat(100-X,"%")},children:(0,c.jsx)(eG,{})})]}),q&&(0,c.jsxs)("div",{className:"fixed bottom-4 left-1/2 transform -translate-x-1/2 flex gap-2 bg-zinc-800 p-1 rounded-full shadow-lg",children:[(0,c.jsx)("button",{onClick:()=>K("chat"),className:"px-4 py-2 rounded-full transition-colors ".concat("chat"===Z?"bg-accent-600 text-white":"text-zinc-400 hover:text-white"),children:"Chat"}),(0,c.jsx)("button",{onClick:()=>K("preview"),className:"px-4 py-2 rounded-full transition-colors ".concat("preview"===Z?"bg-accent-600 text-white":"text-zinc-400 hover:text-white"),children:"Preview"})]}),(0,c.jsx)(g,{isOpen:H,onClose:()=>W(!1),title:"Valuation - Full Screen",children:(0,c.jsx)(eG,{className:"h-full"})})]})})});eZ.displayName="ConversationalLayout"}}]);