(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[697],{90820:function(e,t,r){Promise.resolve().then(r.bind(r,76810))},76810:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return x}});var a=r(57437),n=r(2265),i=r(16463),s=r(69419);let o={async savePartialData(e,t){s.a.debug("Mock savePartialData called",{reportId:e,data:t})},getReport:async e=>(s.a.debug("Mock getReport called",{reportId:e}),{success:!1,data:null}),updateReport:async(e,t)=>(s.a.debug("Mock updateReport called",{reportId:e,data:t}),{success:!0,data:t}),async completeReport(e,t){s.a.debug("Mock completeReport called",{reportId:e,data:t})}};var l=r(13184),u=r(3274);let d=[{text:"Assessing data quality...",subtext:"Evaluating completeness, validity, and consistency across 5 dimensions"},{text:"Validating financial metrics...",subtext:"Extracting revenue, EBITDA, and business profile data"},{text:"Consulting academic frameworks...",subtext:"Referencing Koller, Damodaran & IVS 2017 standards"},{text:"Selecting valuation methodology...",subtext:"Determining DCF vs. Market Multiples eligibility for SMEs"},{text:"Benchmarking against comparables...",subtext:"Analyzing industry multiples from real market transactions"},{text:"Calibrating SME risk factors...",subtext:"Assessing owner dependency, size discount, and liquidity"},{text:"Synthesizing final valuation...",subtext:"Generating Big 4-grade professional report with Belgian compliance"}],c=[{text:"Connecting to secure cloud...",subtext:"Establishing encrypted connection to Upswitch servers"},{text:"Initializing valuation engine...",subtext:"Loading financial modeling tools and market data"},{text:"Preparing workspace...",subtext:"Setting up your secure valuation environment"}],p=e=>{let{steps:t=d,variant:r="light",centered:i=!0,compact:s=!1,containerClassName:o}=e,[l,c]=(0,n.useState)(0);(0,n.useEffect)(()=>{let e=setInterval(()=>{c(e=>(e+1)%t.length)},3e3);return()=>clearInterval(e)},[t.length]);let p=t[l],m="dark"===r;return(0,a.jsxs)("div",{className:o||"flex flex-col items-center w-full h-full max-w-lg mx-auto text-center ".concat(i?"justify-center min-h-[300px] px-4 py-6":"justify-start min-h-[200px] px-4 py-2"),children:[(0,a.jsxs)("div",{className:"relative group ".concat(i?"mb-2":"mb-1"),children:[(0,a.jsx)("div",{className:"absolute inset-0 rounded-full animate-ping ".concat(m?"bg-primary-400/20":"bg-primary-500/10"),style:{animationDuration:"3s"}}),(0,a.jsx)("div",{className:"absolute inset-0 rounded-full animate-ping ".concat(m?"bg-primary-300/10":"bg-primary-400/5"),style:{animationDuration:"4s",animationDelay:"1s"}}),(0,a.jsx)("div",{className:"relative p-6 rounded-2xl shadow-sm border z-10 flex items-center justify-center transform transition-all duration-500 ".concat(m?"bg-zinc-900 border-zinc-800 shadow-primary-900/10":"bg-white border-gray-200 shadow-lg"),children:(0,a.jsx)(u.Z,{className:"w-10 h-10 animate-spin ".concat(m?"text-primary-400":"text-primary-600"),strokeWidth:1.5})})]}),(0,a.jsx)("div",{className:"".concat(s?"mt-0.5 mb-0.5":"mt-6 mb-3"," animate-in fade-in slide-in-from-bottom-2 duration-700 delay-100 fill-mode-backwards"),children:(0,a.jsxs)("span",{className:"text-xs font-semibold tracking-wide uppercase px-3 py-1.5 rounded-full ".concat(m?"text-primary-300 bg-primary-900/30 border border-primary-800/50":"text-primary-700 bg-primary-50 border border-primary-100"),children:["Step ",l+1," of ",t.length]})}),(0,a.jsxs)("div",{className:"flex flex-col items-center max-w-md mx-auto text-center",children:[(0,a.jsx)("h3",{className:"text-xl md:text-2xl font-semibold tracking-tight animate-in fade-in slide-in-from-bottom-3 duration-500 text-center ".concat(m?"text-white":"text-slate-ink"),children:p.text},"title-".concat(l)),(0,a.jsx)("p",{className:"mt-1.5 text-base leading-relaxed animate-in fade-in slide-in-from-bottom-4 duration-500 delay-75 text-center ".concat(m?"text-zinc-400":"text-zinc-500"),children:p.subtext},"subtext-".concat(l))]})]})},m=(0,n.lazy)(()=>r.e(892).then(r.bind(r,65892)).then(e=>({default:e.ValuationFlow}))),h=n.memo(e=>{let{session:t,stage:r,error:i,prefilledQuery:s,autoSend:o,onComplete:l}=e,u=(0,n.useMemo)(()=>(null==t?void 0:t.currentView)==="manual"?"manual":"conversational",[null==t?void 0:t.currentView]),d=(0,n.useMemo)(()=>t?"".concat(t.currentView,"-flow"):"no-session-flow",[null==t?void 0:t.currentView,t]);return"loading"===r?(0,a.jsx)(p,{steps:c,variant:"dark"}):i?(0,a.jsx)("div",{className:"flex items-center justify-center h-full",children:(0,a.jsx)("div",{className:"max-w-md mx-auto text-center",children:(0,a.jsxs)("div",{className:"bg-rust-500/20 border border-rust-500/30 rounded-lg p-6",children:[(0,a.jsx)("h3",{className:"text-lg font-semibold text-rust-400 mb-2",children:"Error"}),(0,a.jsx)("p",{className:"text-rust-300 mb-4",children:i}),(0,a.jsx)("button",{onClick:()=>window.location.reload(),className:"px-4 py-2 bg-rust-600 hover:bg-rust-700 text-white rounded-lg transition-colors",children:"Reload Page"})]})})}):"data-entry"===r&&t?(0,a.jsx)("div",{className:"relative h-full w-full",children:(0,a.jsx)("div",{className:"absolute inset-0 animate-in fade-in duration-200 ease-out",children:(0,a.jsx)(n.Suspense,{fallback:null,children:(0,a.jsx)(m,{reportId:t.reportId,flowType:u,onComplete:l,initialQuery:s,autoSend:o})})},d)}):(0,a.jsx)("div",{className:"flex items-center justify-center h-full",children:(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary-500 mx-auto mb-4"}),(0,a.jsx)("p",{className:"text-zinc-400",children:"Loading valuation interface..."})]})})});h.displayName="ValuationFlowSelector";var v=r(30761);let y="upswitch_guest_credits",g={getCredits(){let e=localStorage.getItem(y);return e?parseInt(e,10):(this.initializeCredits(),3)},initializeCredits(){localStorage.setItem(y,"3")},useCredit(){let e=this.getCredits();return!(e<=0)&&(localStorage.setItem(y,(e-1).toString()),!0)},hasCredits(){return this.getCredits()>0},resetCredits(){localStorage.setItem(y,"3")},setCredits(e){localStorage.setItem(y,Math.max(0,e).toString())},getCreditsRemaining(){return this.getCredits()},getCreditStatus(){let e=this.getCredits();return{remaining:e,total:3,hasCredits:e>0,isFirstTime:!localStorage.getItem(y)}}};var _=r(65030);let f=e=>{let{isOpen:t,onClose:r,onSignUp:n,onTryManual:i}=e;return t?(0,a.jsx)("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:(0,a.jsx)("div",{className:"bg-zinc-900 border border-zinc-700 rounded-2xl p-8 max-w-md w-full mx-4",children:(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)("div",{className:"w-16 h-16 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-4",children:(0,a.jsx)("span",{className:"text-red-400 text-2xl",children:"\uD83D\uDD12"})}),(0,a.jsx)("h2",{className:"text-2xl font-bold text-white mb-2",children:"You've Used All 3 Free Credits!"}),(0,a.jsx)("p",{className:"text-zinc-400 mb-6",children:"You've completed 3 AI-guided valuations. Sign up to get 3 more free credits and save your reports forever."}),(0,a.jsxs)("div",{className:"space-y-3",children:[(0,a.jsx)("button",{onClick:n,className:"w-full bg-purple-600 hover:bg-purple-700 text-white font-medium py-3 px-4 rounded-lg transition-colors",children:"Sign Up for Free (3 More Credits)"}),(0,a.jsx)("button",{onClick:i,className:"w-full bg-zinc-700 hover:bg-zinc-600 text-zinc-300 font-medium py-3 px-4 rounded-lg transition-colors",children:"Try Manual Entry (Always Free)"}),(0,a.jsx)("button",{onClick:r,className:"w-full text-zinc-500 hover:text-zinc-400 font-medium py-2 px-4 rounded-lg transition-colors",children:"Maybe Later"})]}),(0,a.jsx)("div",{className:"mt-6 p-4 bg-zinc-800/50 rounded-lg",children:(0,a.jsxs)("p",{className:"text-xs text-zinc-400",children:[(0,a.jsx)("span",{className:"text-green-400",children:"✓"})," Sign up is completely free",(0,a.jsx)("br",{}),(0,a.jsx)("span",{className:"text-green-400",children:"✓"})," Get 3 more AI-guided valuations",(0,a.jsx)("br",{}),(0,a.jsx)("span",{className:"text-green-400",children:"✓"})," Save reports forever",(0,a.jsx)("br",{}),(0,a.jsx)("span",{className:"text-green-400",children:"✓"})," No credit card required"]})})]})})}):null},w=n.memo(e=>{let{reportId:t,children:r}=e,o=(0,i.useSearchParams)(),l=(0,i.usePathname)(),u=(0,i.useRouter)(),{isAuthenticated:d}=(0,v.a)(),{session:c,initializeSession:p}=(0,_.L)(),[m,h]=(0,n.useState)(""),[y,w]=(0,n.useState)("loading"),[b,x]=(0,n.useState)(null),[S,I]=(0,n.useState)(!1),D={},A=D.prefilledQuery||null,E=D.autoSend||!1,k=(0,n.useRef)(new Map),R=(0,n.useCallback)(async e=>{let t=k.current.get(e);if((null==t||!t.isInitializing)&&(null==t||!t.initialized)){k.current.set(e,{initialized:!1,isInitializing:!0});try{if(!o)return;let t=o.get("flow"),r="manual"===t||"conversational"===t?t:"manual";if("conversational"===r&&!d&&!g.hasCredits()){I(!0),await p(e,"manual"),w("data-entry"),k.current.set(e,{initialized:!0,isInitializing:!1});return}await p(e,r,A),w("data-entry"),k.current.set(e,{initialized:!0,isInitializing:!1})}catch(t){k.current.set(e,{initialized:!1,isInitializing:!1}),s.a.error("Failed to initialize session",{error:t,reportId:e}),x("Failed to initialize valuation session")}}},[d,p,A,o]);return(0,n.useEffect)(()=>{t&&(m&&m!==t&&k.current.delete(m),h(t),R(t))},[t,R,m]),(0,n.useEffect)(()=>{if(!(null==c?void 0:c.currentView)||!(null==c?void 0:c.reportId))return;let e=k.current.get(c.reportId);if((null==e?void 0:e.initialized)&&o&&o.get("flow")!==c.currentView){let e=new URLSearchParams(o.toString());e.set("flow",c.currentView),u.replace("".concat(l,"?").concat(e.toString()))}},[null==c?void 0:c.currentView,null==c?void 0:c.reportId,l,o,u]),(0,a.jsxs)(a.Fragment,{children:[r({session:c,stage:y,error:b,showOutOfCreditsModal:S,onCloseModal:()=>I(!1),prefilledQuery:A,autoSend:E}),(0,a.jsx)(f,{isOpen:S,onClose:()=>I(!1),onSignUp:()=>{I(!1),s.a.info("Sign up clicked from out of credits modal",{reportId:t})},onTryManual:async()=>{I(!1),c&&await _.L.getState().switchView("manual",!0,!0)}})]})});w.displayName="ValuationSessionManager";let b=n.memo(e=>{let{reportId:t}=e,r=(0,i.useRouter)(),u=async e=>{try{await o.completeReport(t,e)}catch(e){s.a.error("Failed to save completed valuation",{error:e,reportId:t})}};return(n.useEffect(()=>{if(!t||!(0,l.qi)(t)){let e=(0,l.rg)();r.replace("/reports/".concat(e))}},[t,r]),t&&(0,l.qi)(t))?(0,a.jsx)("div",{className:"flex h-screen w-screen flex-col overflow-hidden bg-zinc-950",children:(0,a.jsx)(w,{reportId:t,children:e=>{let{session:t,stage:r,error:n,showOutOfCreditsModal:i,onCloseModal:s,prefilledQuery:o,autoSend:l}=e;return(0,a.jsx)(h,{session:t,stage:r,error:n,prefilledQuery:o,autoSend:l,onComplete:u})}})}):null});function x(e){let{params:t}=e,{id:r}=(0,n.use)(t);return(0,a.jsx)(b,{reportId:r})}b.displayName="ValuationReport"},30761:function(e,t,r){"use strict";r.d(t,{a:function(){return i}});var a=r(2265);let n=(0,a.createContext)(void 0);r(69419);let i=()=>{let e=(0,a.useContext)(n);if(!e)throw Error("useAuth must be used within AuthProvider");return e}},74177:function(e,t,r){"use strict";r.d(t,{T:function(){return w}});class a extends Error{constructor(e,t,r=!0,n){super(e),this.name="ValuationError",this.code=t,this.recoverable=r,this.context=n,Error.captureStackTrace&&Error.captureStackTrace(this,a)}}class n extends a{constructor(e,t,r,a=!0,n){super(e,"API_ERROR",a,n),this.name="APIError",this.statusCode=t,this.endpoint=r}}class i extends a{constructor(e,t,r,a){super(e,"VALIDATION_ERROR",!0,a),this.name="ValidationError",this.field=t,this.value=r}}class s extends a{constructor(e,t=0){super(e,"CREDIT_ERROR",!1,{creditsRemaining:t}),this.name="CreditError",this.creditsRemaining=t}}class o extends a{constructor(e,t){super(e,"AUTHENTICATION_ERROR",!1,t),this.name="AuthenticationError"}}class l extends a{constructor(e,t){super(e,"RATE_LIMIT_ERROR",!0,{retryAfter:t}),this.name="RateLimitError",this.retryAfter=t}}class u extends a{constructor(e,t){super(e,"NETWORK_ERROR",!0,t),this.name="NetworkError"}}var d=r(69419),c=r(38472),p=r(813);class m{setupInterceptors(){this.client.interceptors.request.use(async e=>{if(p.L.isGuest())try{let t=await p.L.getOrCreateSession();t&&e.data&&(e.data={...e.data,guest_session_id:t}),p.L.updateActivity().catch(()=>{})}catch(e){d.bn.warn("Failed to add guest session to request",{error:e})}return e},e=>Promise.reject(e)),this.client.interceptors.response.use(e=>{let t=(0,d.l2)(e);return t&&((0,d.eW)(e),d.bn.debug("Correlation ID extracted from response",{correlationId:t,url:e.config.url,status:e.status})),e},e=>{let t=e.config?(0,d.l2)(e.response):null;if(t){var r,a;d.bn.error("API request failed with correlation ID",{correlationId:t,url:null===(r=e.config)||void 0===r?void 0:r.url,status:null===(a=e.response)||void 0===a?void 0:a.status,error:e.message})}return Promise.reject(e)})}async executeRequest(e,t){return(null==t?void 0:t.retry)?this.executeRequestWithRetry(e,t):this.executeSingleRequest(e,t)}async executeRequestWithRetry(e,t){let r;let{maxRetries:a=3,initialDelay:n=1e3,maxDelay:i=1e4,backoffMultiplier:s=2,shouldRetry:o=this.shouldRetryError}=t.retry;for(let l=0;l<=a;l++)try{return l>0&&d.bn.info("Retrying API request",{attempt:l,maxRetries:a,url:e.url,method:e.method}),await this.executeSingleRequest(e,{...t,retry:void 0})}catch(u){if(r=u,!o(u)||l>=a)throw u;let t=Math.min(n*Math.pow(s,l),i);d.bn.warn("API request failed, retrying",{attempt:l,maxRetries:a,delay:t,url:e.url,error:u.message}),await new Promise(e=>setTimeout(e,t))}throw r}shouldRetryError(e){var t;if(!e.response)return!0;let r=null===(t=e.response)||void 0===t?void 0:t.status;return r>=500&&r<600}async executeSingleRequest(e,t){var r,a;let n=(null==t?void 0:t.timeout)||9e4,i=Math.random().toString(36).substring(2,15);this.activeRequests.has(i)&&(d.bn.warn("Duplicate request detected, cancelling previous",{correlationId:i}),null===(r=this.activeRequests.get(i))||void 0===r||r.abort());let s=new AbortController;this.activeRequests.set(i,s);let o=(null==t?void 0:t.signal)||s.signal,l=setTimeout(()=>{d.bn.warn("Request timeout, aborting",{correlationId:i,timeout:n}),s.abort()},n);this.requestTimeouts.set(i,l);try{d.bn.debug("Making API request",{correlationId:i,url:e.url,method:e.method,timeout:n});let t=await this.client.request({...e,signal:o});return(null===(a=t.data)||void 0===a?void 0:a.data)||t.data}finally{this.activeRequests.delete(i),this.requestTimeouts.has(i)&&(clearTimeout(this.requestTimeouts.get(i)),this.requestTimeouts.delete(i))}}cleanup(){for(let[e,t]of this.activeRequests)d.bn.debug("Cleaning up active request",{correlationId:e}),t.abort();for(let[e,t]of(this.activeRequests.clear(),this.requestTimeouts))clearTimeout(t);this.requestTimeouts.clear()}constructor(e,t=9e4){this.activeRequests=new Map,this.requestTimeouts=new Map,this.client=c.Z.create({baseURL:e||(void 0).VITE_BACKEND_URL||(void 0).VITE_API_BASE_URL||"https://web-production-8d00b.up.railway.app",timeout:t,headers:{"Content-Type":"application/json"},withCredentials:!0}),this.setupInterceptors()}}class h extends m{async getCreditStatus(e){try{return await this.executeRequest({method:"GET",url:"/api/credits/status"},e)}catch(e){this.handleCreditError(e,"get credit status")}}async saveValuation(e,t){try{return await this.executeRequest({method:"POST",url:"/api/valuation/save",data:e},t)}catch(e){this.handleCreditError(e,"save valuation")}}handleCreditError(e,t){var r,a,i,l;if(d.bn.error("Credit ".concat(t," failed"),{error:e}),(null===(r=e.response)||void 0===r?void 0:r.status)===401||(null===(a=e.response)||void 0===a?void 0:a.status)===403)throw new o("Authentication required for credit operations");if((null===(i=e.response)||void 0===i?void 0:i.status)===402)throw new s("Insufficient credits for this operation");if((null===(l=e.response)||void 0===l?void 0:l.status)===429)throw new s("Too many credit operations. Please wait before trying again.");throw new n("Failed to ".concat(t),e)}}class v extends m{async getReport(e,t){try{return await this.executeRequest({method:"GET",url:"/api/reports/".concat(e)},t)}catch(e){this.handleReportError(e,"get report")}}async updateReport(e,t,r){try{return await this.executeRequest({method:"PUT",url:"/api/reports/".concat(e),data:t},r)}catch(e){this.handleReportError(e,"update report")}}async deleteReport(e,t){try{return await this.executeRequest({method:"DELETE",url:"/api/reports/".concat(e)},t)}catch(e){this.handleReportError(e,"delete report")}}async downloadAccountantViewPDF(e,t){var r,a,i,s,l,c,p,m,h,v,y;let g=Math.random().toString(36).substring(2,15);this.activeRequests.has(g)&&(d.bn.warn("Duplicate PDF download request detected, cancelling previous",{correlationId:g}),null===(r=this.activeRequests.get(g))||void 0===r||r.abort());let _=new AbortController;this.activeRequests.set(g,_);let f=(null==t?void 0:t.signal)||_.signal,w=(null==t?void 0:t.timeout)||12e4,b=setTimeout(()=>{d.bn.warn("PDF download timeout, aborting",{correlationId:g,timeout:w}),_.abort()},w);this.requestTimeouts.set(g,b);try{d.bn.info("Starting PDF download",{correlationId:g,reportId:e,timeout:w});let t=await this.client.request({method:"GET",url:"/api/reports/".concat(e,"/accountant-pdf"),responseType:"blob",signal:f,timeout:w}),r=(null===(a=t.data)||void 0===a?void 0:a.size)||0;if(d.bn.info("PDF download completed",{correlationId:g,reportId:e,contentLength:r,contentType:null===(i=t.headers)||void 0===i?void 0:i["content-type"]}),!t.data||0===t.data.size)throw Error("Received empty PDF blob");return(null===(s=t.headers)||void 0===s?void 0:s["content-type"])!=="application/pdf"&&d.bn.warn("Unexpected content type for PDF download",{contentType:null===(l=t.headers)||void 0===l?void 0:l["content-type"],expected:"application/pdf"}),t.data}catch(r){let t={correlationId:g,reportId:e,error:r.message,status:null===(c=r.response)||void 0===c?void 0:c.status,statusText:null===(p=r.response)||void 0===p?void 0:p.statusText,isTimeout:"ECONNABORTED"===r.code,isAbort:"AbortError"===r.name};if((null===(m=r.response)||void 0===m?void 0:m.status)===404)throw d.bn.error("Report not found for PDF download",t),new n("Report not found. Please check the report ID.");if((null===(h=r.response)||void 0===h?void 0:h.status)===403||(null===(v=r.response)||void 0===v?void 0:v.status)===401)throw d.bn.error("Unauthorized PDF download attempt",t),new o("You do not have permission to download this report.");if("ECONNABORTED"===r.code)throw d.bn.error("PDF download timed out",t),new u("PDF download timed out. Please try again.");if("AbortError"===r.name)throw d.bn.info("PDF download was cancelled",t),r;throw d.bn.error("PDF download failed with unknown error",{...t,stack:r.stack,responseData:null===(y=r.response)||void 0===y?void 0:y.data}),new n("Failed to download PDF. Please try again.",r)}finally{this.activeRequests.delete(g),this.requestTimeouts.has(g)&&(clearTimeout(this.requestTimeouts.get(g)),this.requestTimeouts.delete(g))}}handleReportError(e,t){var r,a,i;if(d.bn.error("Report ".concat(t," failed"),{error:e}),(null===(r=e.response)||void 0===r?void 0:r.status)===404)throw new n("Report not found",e);if((null===(a=e.response)||void 0===a?void 0:a.status)===401||(null===(i=e.response)||void 0===i?void 0:i.status)===403)throw new o("Authentication required for report operation");if("ECONNABORTED"===e.code||"ENOTFOUND"===e.code)throw new u("Network error during report operation");throw new n("Failed to ".concat(t),e)}}class y extends m{async getValuationSession(e,t){try{let r=await this.executeRequest({method:"GET",url:"/api/sessions/".concat(e)},t);return r&&r.session&&"ai-guided"===r.session.currentView&&(r.session.currentView="conversational"),r}catch(t){var r;if((null===(r=t.response)||void 0===r?void 0:r.status)===404)return d.bn.debug("Session does not exist yet",{reportId:e}),null;this.handleSessionError(t,"get session")}}async createValuationSession(e,t){try{let r={...e,currentView:"conversational"===e.currentView?"ai-guided":e.currentView},a=await this.executeRequest({method:"POST",url:"/api/sessions",data:r},t);return{...a,currentView:"ai-guided"===a.currentView?"conversational":a.currentView}}catch(e){this.handleSessionError(e,"create session")}}async updateValuationSession(e,t,r){try{let a={...t,currentView:"conversational"===t.currentView?"ai-guided":t.currentView},n=await this.executeRequest({method:"PUT",url:"/api/sessions/".concat(e),data:a},r);return{...n,currentView:"ai-guided"===n.currentView?"conversational":n.currentView}}catch(e){this.handleSessionError(e,"update session")}}async switchValuationView(e,t,r){try{let a=await this.executeRequest({method:"PUT",url:"/api/sessions/".concat(e,"/switch-view"),data:{view:"conversational"===t?"ai-guided":t}},r);return{...a,currentView:"ai-guided"===a.currentView?"conversational":a.currentView}}catch(e){this.handleSessionError(e,"switch view")}}handleSessionError(e,t){var r,a,i,s;if(d.bn.error("Session ".concat(t," failed"),{error:e}),(null===(r=e.response)||void 0===r?void 0:r.status)===404)throw new n("Session not found",e);if((null===(a=e.response)||void 0===a?void 0:a.status)===401||(null===(i=e.response)||void 0===i?void 0:i.status)===403)throw new o("Authentication required for session operation");if((null===(s=e.response)||void 0===s?void 0:s.status)===409)throw new n("Session conflict - please refresh and try again",e);throw new n("Failed to ".concat(t),e)}}class g extends m{async health(e){try{return await this.executeRequest({method:"GET",url:"/api/health"},e)}catch(e){throw d.bn.error("Health check failed",{error:e}),new n("Health check failed",e)}}async migrateGuestData(e,t){try{return await this.executeRequest({method:"POST",url:"/api/migrate-guest-data",data:{guestSessionId:e}},t)}catch(t){throw d.bn.error("Guest data migration failed",{error:t,guestSessionId:e}),new n("Failed to migrate guest data",t)}}async getConversationStatus(e,t){var r,a,n,i,s;try{let a=await this.client.request({method:"GET",url:"/api/conversation/status/".concat(e),signal:null==t?void 0:t.signal,timeout:(null==t?void 0:t.timeout)||1e4}),n=(null===(r=a.data)||void 0===r?void 0:r.data)||a.data;if((null==n?void 0:n.exists)===!1)return d.bn.debug("Conversation status check returned exists: false",{sessionId:e}),{exists:!1};if(n&&"object"==typeof n)return{exists:!0,messages:n.messages||[],metadata:n.metadata||{}};return d.bn.warn("Unexpected conversation status response format",{sessionId:e,responseKeys:Object.keys(n||{})}),{exists:!1}}catch(t){if("AbortError"===t.name)throw d.bn.debug("Conversation status check was cancelled",{sessionId:e}),t;if((null===(a=t.response)||void 0===a?void 0:a.status)===404)return d.bn.debug("Conversation does not exist (404)",{sessionId:e}),{exists:!1};if((null===(n=t.response)||void 0===n?void 0:n.status)===500&&(d.bn.warn("Conversation status check failed with 500 error",{sessionId:e}),(null===(s=t.response.data)||void 0===s?void 0:s.exists)===!1))return d.bn.debug("Conversation status check returned exists: false in 500 response",{sessionId:e}),{exists:!1};return d.bn.warn("Conversation status check failed, returning empty state",{sessionId:e,error:t.message,status:null===(i=t.response)||void 0===i?void 0:i.status}),{exists:!1}}}async getConversationHistory(e,t){var r,a;try{let a=await this.client.request({method:"GET",url:"/api/conversation/history/".concat(e),signal:t,timeout:3e4}),n=(null===(r=a.data)||void 0===r?void 0:r.data)||a.data;if(n&&Array.isArray(n.messages))return{messages:n.messages,exists:!0};return{messages:[],exists:!1}}catch(t){if("AbortError"===t.name)throw d.bn.debug("Conversation history request was cancelled",{conversationId:e}),t;if((null===(a=t.response)||void 0===a?void 0:a.status)===404)return d.bn.debug("Conversation history does not exist",{conversationId:e}),{messages:[],exists:!1};return d.bn.error("Failed to get conversation history",{conversationId:e,error:t.message}),{messages:[],exists:!1}}}}class _ extends m{async calculateManualValuation(e,t){try{return await this.executeRequest({method:"POST",url:"/api/valuation/calculate-manual",data:{...e,dataSource:"manual"}},{...t,retry:{maxRetries:2,initialDelay:1e3,...null==t?void 0:t.retry}})}catch(e){this.handleValuationError(e,"manual valuation")}}async calculateAIGuidedValuation(e,t){try{return await this.executeRequest({method:"POST",url:"/api/valuation/calculate-ai-guided",data:{...e,dataSource:"ai-guided"}},t)}catch(e){this.handleValuationError(e,"AI-guided valuation")}}async calculateInstantValuation(e,t){try{return await this.executeRequest({method:"POST",url:"/api/valuation/calculate-instant",data:{...e,dataSource:"instant"}},t)}catch(e){this.handleValuationError(e,"instant valuation")}}async calculateValuationUnified(e,t){try{let r={...e,dataSource:"conversational"===e.dataSource?"ai-guided":e.dataSource};return await this.executeRequest({method:"POST",url:"/api/valuation/calculate-unified",data:r},{...t,retry:{maxRetries:3,initialDelay:1e3,...null==t?void 0:t.retry}})}catch(e){this.handleValuationError(e,"unified valuation")}}async generatePreviewHtml(e,t){try{return await this.executeRequest({method:"POST",url:"/api/valuation/preview-html",data:e},t)}catch(e){throw d.bn.error("Failed to generate preview HTML",{error:e}),new n("Failed to generate valuation preview",e)}}handleValuationError(e,t){var r,a,c,p,m,h,v;if(d.bn.error("Valuation ".concat(t," failed"),{error:e}),(null===(r=e.response)||void 0===r?void 0:r.status)===429)throw new l("Too many valuation requests. Please wait before trying again.");if((null===(a=e.response)||void 0===a?void 0:a.status)===401||(null===(c=e.response)||void 0===c?void 0:c.status)===403)throw new o("Authentication required for valuation calculation.");if((null===(p=e.response)||void 0===p?void 0:p.status)===402)throw new s("Insufficient credits for valuation calculation.");if((null===(m=e.response)||void 0===m?void 0:m.status)===400)throw new i((null===(v=e.response)||void 0===v?void 0:null===(h=v.data)||void 0===h?void 0:h.message)||"Invalid valuation data provided.");if("ECONNABORTED"===e.code||"ENOTFOUND"===e.code)throw new u("Network error during valuation calculation. Please check your connection.");throw new n("Failed to complete ".concat(t),e)}}class f{async calculateManualValuation(e,t){return this.valuationAPI.calculateManualValuation(e,t)}async calculateAIGuidedValuation(e){return this.valuationAPI.calculateAIGuidedValuation(e)}async calculateInstantValuation(e){return this.valuationAPI.calculateInstantValuation(e)}async calculateValuationForReport(e){return this.valuationAPI.calculateValuationUnified(e)}async calculateValuation(e){return this.valuationAPI.calculateValuationUnified(e)}async calculateValuationUnified(e,t){return this.valuationAPI.calculateValuationUnified(e,t)}async generatePreviewHtml(e){return this.valuationAPI.generatePreviewHtml(e)}async getReport(e){return this.reportAPI.getReport(e)}async updateReport(e,t){return this.reportAPI.updateReport(e,t)}async deleteReport(e){return this.reportAPI.deleteReport(e)}async downloadAccountantViewPDF(e){return this.reportAPI.downloadAccountantViewPDF(e)}async getValuationSession(e){return this.sessionAPI.getValuationSession(e)}async createValuationSession(e){return this.sessionAPI.createValuationSession(e)}async updateValuationSession(e,t){return this.sessionAPI.updateValuationSession(e,t)}async switchValuationView(e,t){return this.sessionAPI.switchValuationView(e,t)}async getCreditStatus(){return this.creditAPI.getCreditStatus()}async saveValuation(e){return this.creditAPI.saveValuation(e)}async health(){return this.utilityAPI.health()}async migrateGuestData(e){return this.utilityAPI.migrateGuestData(e)}async getConversationStatus(e){return this.utilityAPI.getConversationStatus(e)}async getConversationHistory(e,t){return this.utilityAPI.getConversationHistory(e,t)}cleanup(){this.valuationAPI.cleanup(),this.reportAPI.cleanup(),this.sessionAPI.cleanup(),this.creditAPI.cleanup(),this.utilityAPI.cleanup()}constructor(){this.valuationAPI=new _,this.reportAPI=new v,this.sessionAPI=new y,this.creditAPI=new h,this.utilityAPI=new g}}let w=new f},813:function(e,t,r){"use strict";r.d(t,{L:function(){return d}});var a=r(69419);let n="upswitch_guest_session_id",i="upswitch_guest_session_expires_at",s="upswitch_activity_update_disabled",o="upswitch_activity_failure_count",l="upswitch_activity_last_failure";class u{restoreCircuitBreakerState(){try{let e=localStorage.getItem(s),t=parseInt(localStorage.getItem(o)||"0",10),r=parseInt(localStorage.getItem(l)||"0",10);"true"===e?Date.now()-r<3e5?(this.circuitBreakerOpen=!0,this.circuitBreakerOpenUntil=r+3e5,this.consecutiveFailures=t):this.resetCircuitBreaker():this.consecutiveFailures=t}catch(e){this.resetCircuitBreaker()}}resetCircuitBreaker(){this.circuitBreakerOpen=!1,this.circuitBreakerOpenUntil=0,this.consecutiveFailures=0;try{localStorage.removeItem(s),localStorage.removeItem(o),localStorage.removeItem(l)}catch(e){}}recordFailure(){this.consecutiveFailures++;let e=Date.now();try{localStorage.setItem(o,this.consecutiveFailures.toString()),localStorage.setItem(l,e.toString())}catch(e){}if(this.consecutiveFailures>=5){this.circuitBreakerOpen=!0,this.circuitBreakerOpenUntil=e+3e5;try{localStorage.setItem(s,"true")}catch(e){}a.a.warn("Guest session activity updates disabled due to repeated failures. Will retry after cooldown period.")}}recordSuccess(){if(this.consecutiveFailures>0){this.consecutiveFailures=0;try{localStorage.removeItem(o),localStorage.removeItem(l)}catch(e){}}}isCircuitBreakerOpen(){return!!this.circuitBreakerOpen&&(!(Date.now()>=this.circuitBreakerOpenUntil)||(this.resetCircuitBreaker(),!1))}generateSessionId(){let e=Date.now(),t=Math.random().toString(36).substring(2,10);return"guest_".concat(e,"_").concat(t)}async getOrCreateSession(){try{let e=localStorage.getItem(n),t=localStorage.getItem(i);if(e&&t&&new Date(t)>new Date)try{let t=await fetch("".concat(this.apiUrl,"/api/guest/session/").concat(e),{method:"GET",headers:{"Content-Type":"application/json"}});if(t.ok){let r=await t.json();if(r.success)return localStorage.setItem(i,r.data.expires_at),e}}catch(e){a.a.warn("Failed to verify existing session, creating new one",{error:e})}let r=this.generateSessionId(),s=await fetch("".concat(this.apiUrl,"/api/guest/session"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({session_id:r})});if(!s.ok)throw Error("Failed to create guest session: ".concat(s.statusText));let o=await s.json();if(!o.success)throw Error("Failed to create guest session");return localStorage.setItem(n,o.data.session_id),localStorage.setItem(i,o.data.expires_at),a.a.info("Guest session created",{session_id:o.data.session_id,expires_at:o.data.expires_at,days_remaining:o.data.days_remaining}),o.data.session_id}catch(r){a.a.error("Failed to get or create guest session",{error:r});let e=this.generateSessionId();localStorage.setItem(n,e);let t=new Date;return t.setDate(t.getDate()+7),localStorage.setItem(i,t.toISOString()),e}}getCurrentSessionId(){return localStorage.getItem(n)}async updateActivity(){let e=this.getCurrentSessionId();if(!e)return;let t=Date.now();if(!(t-this.lastActivityUpdate<5e3||this.isCircuitBreakerOpen())){this.lastActivityUpdate=t;try{let t=new AbortController,r=setTimeout(()=>t.abort(),3e3),a=await fetch("".concat(this.apiUrl,"/api/guest/session/").concat(e,"/activity"),{method:"POST",headers:{"Content-Type":"application/json"},signal:t.signal});clearTimeout(r),a.ok||0===a.status?this.recordSuccess():this.recordFailure()}catch(e){"AbortError"===e.name||"TypeError"===e.name&&e.message.includes("Failed to fetch"),this.recordFailure()}}}isSessionExpired(){let e=localStorage.getItem(i);return!e||new Date(e)<new Date}getDaysRemaining(){let e=localStorage.getItem(i);if(!e)return 0;let t=new Date;return Math.max(0,Math.ceil((new Date(e).getTime()-t.getTime())/864e5))}clearSession(){localStorage.removeItem(n),localStorage.removeItem(i)}isGuest(){let e=localStorage.getItem("upswitch_auth_token"),t=localStorage.getItem("upswitch_user_id");return!e&&!t}resetActivityUpdateCircuitBreaker(){this.resetCircuitBreaker(),a.a.info("Guest session activity update circuit breaker manually reset")}getActivityUpdateStatus(){let e=Date.now(),t=this.circuitBreakerOpen&&this.circuitBreakerOpenUntil>e?Math.max(0,this.circuitBreakerOpenUntil-e):void 0;return{enabled:!this.isCircuitBreakerOpen(),consecutiveFailures:this.consecutiveFailures,circuitBreakerOpen:this.circuitBreakerOpen,cooldownRemaining:t}}constructor(){this.lastActivityUpdate=0,this.consecutiveFailures=0,this.circuitBreakerOpen=!1,this.circuitBreakerOpenUntil=0,this.apiUrl=(void 0).VITE_BACKEND_URL||(void 0).VITE_API_BASE_URL||"https://web-production-8d00b.up.railway.app",this.restoreCircuitBreakerState()}}let d=new u},65030:function(e,t,r){"use strict";r.d(t,{L:function(){return s}});var a=r(39099),n=r(74177),i=r(69419);let s=(0,a.Ue)((e,t)=>{let a=0,s=null;return{session:null,isSyncing:!1,syncError:null,pendingFlowSwitch:null,initializeSession:async function(r){let a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"manual",s=arguments.length>2?arguments[2]:void 0;try{i.sK.info("Initializing valuation session",{reportId:r,currentView:a,hasPrefilledQuery:!!s});let{session:o}=t();if((null==o?void 0:o.reportId)===r&&o.currentView){if(i.sK.info("Session already exists locally, skipping initialization",{reportId:r,existingView:o.currentView,requestedView:a}),s&&o.partialData){let t={...o.partialData};t._prefilledQuery||(t._prefilledQuery=s,e({session:{...o,partialData:t}}))}return}let l=await n.T.getValuationSession(r);if(l){let t={...l.partialData};s&&!t._prefilledQuery&&(t._prefilledQuery=s),e({session:{...l,partialData:t,createdAt:new Date(l.createdAt),updatedAt:new Date(l.updatedAt),completedAt:l.completedAt?new Date(l.completedAt):void 0},syncError:null}),i.sK.info("Loaded existing session",{reportId:r,currentView:l.currentView})}else{let t="session_".concat(Date.now(),"_").concat(Math.random().toString(36).substring(2,15)),o={sessionId:t,reportId:r,currentView:a,dataSource:a,createdAt:new Date,updatedAt:new Date,partialData:s?{_prefilledQuery:s}:{},sessionData:{}};await n.T.createValuationSession(o),e({session:o,syncError:null}),i.sK.info("Created new session",{reportId:r,sessionId:t,currentView:a,hasPrefilledQuery:!!s})}}catch(n){i.sK.error("Failed to initialize session",{error:n instanceof Error?n.message:"Unknown error",reportId:r});let t="session_".concat(Date.now(),"_").concat(Math.random().toString(36).substring(2,15));e({session:{sessionId:t,reportId:r,currentView:a,dataSource:a,createdAt:new Date,updatedAt:new Date,partialData:{},sessionData:{}},syncError:n.message||"Failed to sync with backend"}),i.sK.warn("Created local session (backend sync failed)",{reportId:r,sessionId:t})}},loadSession:async t=>{try{e({isSyncing:!0,syncError:null});let r=await n.T.getValuationSession(t);r?(e({session:{...r,createdAt:new Date(r.createdAt),updatedAt:new Date(r.updatedAt),completedAt:r.completedAt?new Date(r.completedAt):void 0},isSyncing:!1,syncError:null}),i.sK.info("Session loaded",{reportId:t})):e({isSyncing:!1,syncError:"Session not found"})}catch(r){i.sK.error("Failed to load session",{error:r instanceof Error?r.message:"Unknown error",reportId:t}),e({isSyncing:!1,syncError:r.message||"Failed to load session"})}},updateSessionData:async r=>{let{session:o}=t();if(!o){i.sK.warn("Cannot update session data: no active session");return}let l=Date.now(),u=l-a;if(u<2e3)return s&&clearTimeout(s),new Promise(e=>{s=setTimeout(async()=>{a=Date.now(),s=null,await t().updateSessionData(r),e()},2e3-u)});a=l;try{e({isSyncing:!0,syncError:null});let a=(e,t)=>{let r={...e};for(let n in t)t[n]&&"object"==typeof t[n]&&!Array.isArray(t[n])?r[n]=a(e[n]||{},t[n]):r[n]=t[n];return r},s=a(o.partialData,r),l=a(o.sessionData||{},r),u=o.dataSource;o.dataSource!==o.currentView&&(u="mixed");let d={...o,partialData:s,sessionData:l,dataSource:u,updatedAt:new Date},c={...o,sessionData:l};e({session:c});let p=t().getCompleteness();d.completeness=p,await n.T.updateValuationSession(o.reportId,{partialData:s,sessionData:l,dataSource:u,currentView:o.currentView}),e({session:d,isSyncing:!1,syncError:null}),i.sK.debug("Session data updated",{reportId:o.reportId,fieldsUpdated:Object.keys(r),completeness:p})}catch(d){i.sK.error("Failed to update session data",{error:d instanceof Error?d.message:"Unknown error",reportId:o.reportId});let a=(e,t)=>{let r={...e};for(let n in t)t[n]&&"object"==typeof t[n]&&!Array.isArray(t[n])?r[n]=a(e[n]||{},t[n]):r[n]=t[n];return r},n=a(o.partialData,r),s=a(o.sessionData||{},r),l=o.dataSource;o.dataSource!==o.currentView&&(l="mixed"),e({session:{...o,sessionData:s}});let u=t().getCompleteness();e({session:{...o,partialData:n,sessionData:s,dataSource:l,updatedAt:new Date,completeness:u},isSyncing:!1,syncError:d.message||"Failed to sync with backend"})}},switchView:async function(a){let s=!(arguments.length>1)||void 0===arguments[1]||arguments[1],o=arguments.length>2&&void 0!==arguments[2]&&arguments[2],{session:l}=t();if(!l){i.sK.warn("Cannot switch view: no active session");return}if(l.currentView===a){i.sK.debug("Already in target view",{reportId:l.reportId,view:a});return}if(!o)return i.sK.info("Flow switch requires confirmation",{reportId:l.reportId,currentView:l.currentView,targetView:a,resetData:s}),e({pendingFlowSwitch:a}),{needsConfirmation:!0};let u=!1;if(e(e=>e.isSyncing?(i.sK.warn("Switch already in progress, ignoring concurrent request",{reportId:l.reportId,requestedView:a}),e):(u=!0,{...e,isSyncing:!0,syncError:null})),!u)return;try{let{useValuationStore:e}=await Promise.resolve().then(r.bind(r,38691));e.getState().clearResult(),i.sK.info("Cleared valuation result on flow switch",{from:l.currentView,to:a})}catch(e){i.sK.error("Failed to clear result on flow switch",{error:e})}e({pendingFlowSwitch:null});let{session:d}=t();if(!d||d.reportId!==l.reportId){i.sK.warn("Session changed during switch, aborting",{originalReportId:l.reportId}),e({isSyncing:!1});return}if(d.currentView===a){i.sK.debug("Already in target view (race condition check)",{reportId:d.reportId,view:a}),e({isSyncing:!1});return}let c={...d},p={...d,currentView:a,updatedAt:new Date};if(s){var m;let e=null===(m=d.partialData)||void 0===m?void 0:m._prefilledQuery;p.partialData=e?{_prefilledQuery:e}:{},p.sessionData={},p.dataSource=a,i.sK.info("Resetting session data on flow switch",{reportId:d.reportId,preservedPrefilledQuery:!!e})}e({session:p,isSyncing:!0,syncError:null}),i.sK.info("View switched optimistically (UI updated immediately)",{reportId:d.reportId,from:d.currentView,to:a,resetData:s}),n.T.switchValuationView(d.reportId,a).then(()=>{let{session:r}=t();(null==r?void 0:r.reportId)===d.reportId&&(e({isSyncing:!1,syncError:null}),i.sK.info("Backend sync completed successfully",{reportId:d.reportId,view:a}))}).catch(r=>{i.sK.error("Failed to sync view switch with backend",{error:r instanceof Error?r.message:"Unknown error",reportId:d.reportId,requestedView:a});let{session:n}=t();(null==n?void 0:n.reportId)===d.reportId?(e({session:c,isSyncing:!1,syncError:r.message||"Failed to sync with backend"}),i.sK.warn("Rolled back view switch due to backend error",{reportId:d.reportId,originalView:c.currentView})):e({isSyncing:!1,syncError:r.message||"Failed to sync with backend"})})},getSessionData:()=>{let{session:e}=t();if(!e||!e.sessionData)return null;let r=e.sessionData,a=(e,t)=>null!=e&&("string"!=typeof e||""!==e.trim())&&("number"==typeof e?!!(0!==e||["ebitda"].includes(t||"")):(!Array.isArray(e)||0!==e.length)&&("object"!=typeof e||null===e||0!==Object.keys(e).length)),n={};for(let[e,t]of Object.entries(r))if("current_year_data"===e&&"object"==typeof t&&null!==t){let r={};for(let[e,n]of Object.entries(t))a(n)&&(r[e]=n);Object.keys(r).length>0&&(n[e]=r)}else a(t,e)&&(n[e]=t);return 0===Object.keys(n).length?null:n},clearSession:()=>{e({session:null,isSyncing:!1,syncError:null}),i.sK.info("Session cleared")},syncFromManualForm:async()=>{let{session:a}=t();if(!a){i.sK.warn("Cannot sync from manual form: no active session");return}try{let{useValuationStore:n}=await Promise.resolve().then(r.bind(r,38691)),s=n.getState().formData;i.sK.debug("Syncing from manual form to session",{reportId:a.reportId,fieldsPresent:Object.keys(s).length});let o={company_name:s.company_name,country_code:s.country_code,industry:s.industry,business_model:s.business_model,founding_year:s.founding_year,current_year_data:s.current_year_data,historical_years_data:s.historical_years_data,number_of_employees:s.number_of_employees,number_of_owners:s.number_of_owners,recurring_revenue_percentage:s.recurring_revenue_percentage,shares_for_sale:s.shares_for_sale,business_type_id:s.business_type_id,business_context:s.business_context,comparables:s.comparables};Object.keys(o).forEach(e=>{void 0===o[e]&&delete o[e]}),await t().updateSessionData(o),e({session:{...a,lastSyncedAt:new Date}}),i.sK.info("Synced from manual form to session",{reportId:a.reportId,fieldsUpdated:Object.keys(o).length})}catch(e){i.sK.error("Failed to sync from manual form",{error:e instanceof Error?e.message:"Unknown error"})}},syncToManualForm:()=>{let{session:e}=t();if(!e||!e.sessionData){i.sK.warn("Cannot sync to manual form: no session data");return}try{let{useValuationStore:t}=r(38691),a=e.sessionData;i.sK.debug("Syncing from session to manual form",{reportId:e.reportId,fieldsPresent:Object.keys(a).length});let n={company_name:a.company_name,country_code:a.country_code,industry:a.industry,business_model:a.business_model,founding_year:a.founding_year,current_year_data:a.current_year_data,historical_years_data:a.historical_years_data,number_of_employees:a.number_of_employees,number_of_owners:a.number_of_owners,recurring_revenue_percentage:a.recurring_revenue_percentage,shares_for_sale:a.shares_for_sale,business_type_id:a.business_type_id,business_context:a.business_context,comparables:a.comparables};Object.keys(n).forEach(e=>{void 0===n[e]&&delete n[e]}),t.getState().updateFormData(n),i.sK.info("Synced from session to manual form",{reportId:e.reportId,fieldsUpdated:Object.keys(n).length})}catch(e){i.sK.error("Failed to sync to manual form",{error:e instanceof Error?e.message:"Unknown error"})}},getCompleteness:()=>{let{session:e}=t();if(!e||!e.sessionData)return 0;let r=e.sessionData,a=0,n=0;return[{key:"company_name",weight:1},{key:"country_code",weight:1},{key:"industry",weight:1},{key:"business_model",weight:1},{key:"founding_year",weight:1},{key:"current_year_data.revenue",weight:2},{key:"current_year_data.ebitda",weight:2}].forEach(e=>{let{key:t,weight:i}=e;if(n+=i,t.includes(".")){let[e,n]=t.split(".");r[e]&&void 0!==r[e][n]&&null!==r[e][n]&&""!==r[e][n]&&(a+=i)}else void 0!==r[t]&&null!==r[t]&&""!==r[t]&&(a+=i)}),n>0?Math.round(a/n*100):0},setPendingFlowSwitch:t=>{e({pendingFlowSwitch:t})}}})},38691:function(e,t,r){"use strict";r.r(t),r.d(t,{useValuationStore:function(){return o}});var a=r(39099),n=r(69419);let i=()=>Math.min(new Date().getFullYear(),2100),s={company_name:"",country_code:"BE",industry:"services",business_model:"services",founding_year:i()-5,business_type:"company",shares_for_sale:100,number_of_owners:1,revenue:void 0,ebitda:void 0,current_year_data:{year:i(),revenue:0,ebitda:0}},o=(0,a.Ue)((e,t)=>({collectedData:[],setCollectedData:t=>e({collectedData:t}),formData:s,updateFormData:t=>e(e=>({formData:{...e.formData,...t}})),resetFormData:()=>e({formData:s}),prefillFromBusinessCard:t=>e(e=>({formData:{...e.formData,company_name:t.company_name,industry:t.industry,business_model:t.business_model,founding_year:t.founding_year,country_code:t.country_code,number_of_employees:t.employee_count}})),result:null,setResult:r=>{let a=t().result,i=(null==a?void 0:a.html_report)&&a.html_report.length>0,s=(null==r?void 0:r.html_report)&&r.html_report.length>0;if(r&&i&&!s){var o,l;n.sK.info("DIAGNOSTIC: Preserving html_report in setResult",{preservedFrom:"existing_result",htmlReportLength:(null==a?void 0:null===(o=a.html_report)||void 0===o?void 0:o.length)||0,valuationId:r.valuation_id,newResultHadHtmlReport:!!r.html_report,newResultHtmlReportLength:(null===(l=r.html_report)||void 0===l?void 0:l.length)||0}),e({result:{...r,html_report:null==a?void 0:a.html_report}})}else e({result:r})},clearResult:()=>e({result:null}),inputData:null,setInputData:t=>e({inputData:t}),isCalculating:!1,setIsCalculating:t=>e({isCalculating:t}),isCalculatingLive:!1,setIsCalculatingLive:t=>e({isCalculatingLive:t}),error:null,setError:t=>e({error:t}),liveEstimate:null,setLiveEstimate:t=>e({liveEstimate:t}),savedValuationId:null,setSavedValuationId:t=>e({savedValuationId:t}),correlationId:null,setCorrelationId:t=>{e({correlationId:t}),correlationContext.setCorrelationId(t),t&&n.sK.info("Correlation ID set",{correlationId:t})},calculateValuation:async()=>{var e,r,a,i,s,o,l,u,d,c,p,m,h,v,y,g,_,f,w,b,x,S,I,D,A,E,k,R,V;let{formData:C,setIsCalculating:T,setResult:P,setError:N,setInputData:F}=t(),j=useValuationSessionStore.getState(),q=j.getSessionData(),O=j.session;N(null),T(!0);try{let D=(null==O?void 0:O.dataSource)||"manual",A={...C,...q||{},company_name:C.company_name||(null==q?void 0:q.company_name),revenue:C.revenue||(null==q?void 0:q.revenue),current_year_data:C.current_year_data||(null==q?void 0:q.current_year_data)};if(!A.company_name||""===A.company_name.trim())throw Error("Company name is required");if(!A.industry)throw Error("Industry is required");let E=A.revenue||(null===(e=A.current_year_data)||void 0===e?void 0:e.revenue);if(!E||E<=0)throw Error("Revenue must be greater than 0");let k=void 0!==A.ebitda&&null!==A.ebitda?A.ebitda:null===(r=A.current_year_data)||void 0===r?void 0:r.ebitda;if(null==k)throw Error("EBITDA is required");let R=Math.min(Math.max((null===(a=A.current_year_data)||void 0===a?void 0:a.year)||new Date().getFullYear(),2e3),2100),V=Math.min(Math.max(A.founding_year||R-5,1900),2100),T=Math.min(Math.max(A.recurring_revenue_percentage||0,0),1),N=(null===(i=A.company_name)||void 0===i?void 0:i.trim())||"Unknown Company",j=(A.country_code||"BE").toUpperCase().substring(0,2),K=A.industry||"services",M=A.business_model||"services",U=Math.max(Number(E)||1e5,1),B=null!=k?Number(k):2e4,z={revenue:U,ebitda:B,industry:K,country_code:j,founding_year:V,employees:A.number_of_employees,business_model:M,historical_years_data:A.historical_years_data,total_debt:null===(s=A.current_year_data)||void 0===s?void 0:s.total_debt,cash:null===(o=A.current_year_data)||void 0===o?void 0:o.cash};F(z),n.sK.debug("Data source before building request",{dataSource:D,usingSessionData:!!q,business_type_id:A.business_type_id,_internal_dcf_preference:A._internal_dcf_preference,_internal_multiples_preference:A._internal_multiples_preference,_internal_owner_dependency_impact:A._internal_owner_dependency_impact,number_of_employees:A.number_of_employees,number_of_owners:A.number_of_owners,business_type:A.business_type});let L={company_name:N,country_code:j,industry:K,business_model:M,founding_year:V,current_year_data:{year:R,revenue:U,ebitda:B,...(null===(l=A.current_year_data)||void 0===l?void 0:l.total_assets)&&A.current_year_data.total_assets>=0&&{total_assets:Number(A.current_year_data.total_assets)},...(null===(u=A.current_year_data)||void 0===u?void 0:u.total_debt)&&A.current_year_data.total_debt>=0&&{total_debt:Number(A.current_year_data.total_debt)},...(null===(d=A.current_year_data)||void 0===d?void 0:d.cash)&&A.current_year_data.cash>=0&&{cash:Number(A.current_year_data.cash)}},historical_years_data:A.historical_years_data&&A.historical_years_data.length>0?A.historical_years_data.filter(e=>void 0!==e.ebitda&&null!==e.ebitda).map(e=>({...e,year:Math.min(Math.max(Number(e.year),2e3),2100),revenue:Math.max(Number(e.revenue)||0,1),ebitda:Number(e.ebitda)})):U>0&&0!==B?[{year:Math.min(R-1,2100),revenue:Math.max(.9*U,1),ebitda:.9*B}]:[],number_of_employees:"sole-trader"===A.business_type?void 0:void 0!==A.number_of_employees&&null!==A.number_of_employees&&A.number_of_employees>=0?A.number_of_employees:void 0,number_of_owners:"sole-trader"===A.business_type?void 0:void 0!==A.number_of_owners&&null!==A.number_of_owners&&A.number_of_owners>=1?A.number_of_owners:1,recurring_revenue_percentage:T,use_dcf:!0,use_multiples:!0,projection_years:10,comparables:A.comparables||[],business_type_id:A.business_type_id,business_type:A.business_type,shares_for_sale:void 0!==A.shares_for_sale&&null!==A.shares_for_sale?Math.max(0,Math.min(100,Number(A.shares_for_sale))):100,business_context:A.business_type_id?{dcfPreference:validatePreference(A._internal_dcf_preference),multiplesPreference:validatePreference(A._internal_multiples_preference),ownerDependencyImpact:validatePreference(A._internal_owner_dependency_impact),keyMetrics:A._internal_key_metrics,typicalEmployeeRange:A._internal_typical_employee_range,typicalRevenueRange:A._internal_typical_revenue_range}:void 0};n.sK.debug("Business context in request",{business_context:L.business_context}),n.sK.info("Sending unified valuation request",{dataSource:D,companyName:L.company_name,revenue:L.current_year_data.revenue,ebitda:L.current_year_data.ebitda,business_type_id:L.business_type_id,business_context:L.business_context,requestData:L});let H=await backendAPI.calculateValuationUnified(L,D);if(null==H?void 0:H.valuation_id){let{setCorrelationId:e}=t();e(H.valuation_id),correlationContext.setValuationId(H.valuation_id),n.sK.info("Valuation response received",{valuationId:H.valuation_id,hasTransparency:!!H.transparency,hasModularSystem:!!H.modular_system,modularSystemStepsCount:(null===(w=H.modular_system)||void 0===w?void 0:null===(f=w.step_details)||void 0===f?void 0:f.length)||0,hasHtmlReport:!!(null==H?void 0:H.html_report),htmlReportLength:(null==H?void 0:null===(b=H.html_report)||void 0===b?void 0:b.length)||0,hasInfoTabHtml:!!(null==H?void 0:H.info_tab_html),infoTabHtmlLength:(null==H?void 0:null===(x=H.info_tab_html)||void 0===x?void 0:x.length)||0})}n.sK.debug("Backend response received",{responseType:typeof H,responseKeys:Object.keys(H||{}),equityValues:{low:null==H?void 0:H.equity_value_low,mid:null==H?void 0:H.equity_value_mid,high:null==H?void 0:H.equity_value_high},recommendedAskingPrice:null==H?void 0:H.recommended_asking_price,confidenceScore:null==H?void 0:H.confidence_score,htmlReport:{present:!!(null==H?void 0:H.html_report),length:(null==H?void 0:null===(c=H.html_report)||void 0===c?void 0:c.length)||0,preview:(null==H?void 0:null===(p=H.html_report)||void 0===p?void 0:p.substring(0,200))||"N/A",type:typeof(null==H?void 0:H.html_report)},infoTabHtml:{present:!!(null==H?void 0:H.info_tab_html),length:(null==H?void 0:null===(m=H.info_tab_html)||void 0===m?void 0:m.length)||0,preview:(null==H?void 0:null===(h=H.info_tab_html)||void 0===h?void 0:h.substring(0,200))||"N/A",type:typeof(null==H?void 0:H.info_tab_html)},fullData:H}),n.sK.debug("Report data sections",{keyValueDrivers:null==H?void 0:H.key_value_drivers,riskFactors:null==H?void 0:H.risk_factors,financialMetrics:null==H?void 0:H.financial_metrics,historicalData:null==H?void 0:H.historical_years_data,transparency:null==H?void 0:H.transparency,methodologyNotes:null==H?void 0:H.methodology_notes}),n.sK.info("DIAGNOSTIC: About to store result in Zustand store",{hasHtmlReport:!!(null==H?void 0:H.html_report),htmlReportLength:(null==H?void 0:null===(v=H.html_report)||void 0===v?void 0:v.length)||0,hasInfoTabHtml:!!(null==H?void 0:H.info_tab_html),infoTabHtmlLength:(null==H?void 0:null===(y=H.info_tab_html)||void 0===y?void 0:y.length)||0,valuationId:null==H?void 0:H.valuation_id});let G=t().result,Q=(null==H?void 0:H.html_report)&&H.html_report.length>0,W=(null==G?void 0:G.html_report)&&G.html_report.length>0,Y=(null==H?void 0:H.info_tab_html)&&H.info_tab_html.length>0,Z=(null==G?void 0:G.info_tab_html)&&G.info_tab_html.length>0,J=Q?H.html_report:W?G.html_report:null==H?void 0:H.html_report,X=Y?H.info_tab_html:Z?G.info_tab_html:null==H?void 0:H.info_tab_html;W&&!Q&&n.sK.info("DIAGNOSTIC: Preserving html_report from streaming/previous result",{preservedFrom:"previous_result",htmlReportLength:(null==J?void 0:J.length)||0,valuationId:null==H?void 0:H.valuation_id,responseHadHtmlReport:!!(null==H?void 0:H.html_report),responseHtmlReportLength:(null==H?void 0:null===(S=H.html_report)||void 0===S?void 0:S.length)||0}),Z&&!Y&&n.sK.info("DIAGNOSTIC: Preserving info_tab_html from streaming/previous result",{preservedFrom:"previous_result",infoTabHtmlLength:(null==X?void 0:X.length)||0,valuationId:null==H?void 0:H.valuation_id,responseHadInfoTabHtml:!!(null==H?void 0:H.info_tab_html),responseInfoTabHtmlLength:(null==H?void 0:null===(I=H.info_tab_html)||void 0===I?void 0:I.length)||0});let $={...H,html_report:J,info_tab_html:X},ee=[];["equity_value_low","equity_value_mid","equity_value_high","equity_value","enterprise_value","confidence_score"].forEach(e=>{let t=$[e];"number"==typeof t&&(isNaN(t)||!isFinite(t))&&ee.push(e)}),ee.length>0&&n.sK.warn("⚠️ Valuation result contains NaN/Infinity in critical fields",{valuationId:null==H?void 0:H.valuation_id,nanFields:ee,note:"Components will handle NaN at display time with fallback values"}),P($);let et=t().result;if(n.sK.info("Result stored in Zustand store",{stored:!!et,storedHasHtmlReport:!!(null==et?void 0:et.html_report),storedHtmlReportLength:(null==et?void 0:null===(g=et.html_report)||void 0===g?void 0:g.length)||0,storedHasInfoTabHtml:!!(null==et?void 0:et.info_tab_html),storedInfoTabHtmlLength:(null==et?void 0:null===(_=et.info_tab_html)||void 0===_?void 0:_.length)||0}),H.financial_metrics&&z&&F({...z,metrics:H.financial_metrics}),O)try{await backendAPI.updateValuationSession(O.reportId,{completedAt:new Date().toISOString()}),n.sK.info("Session marked as completed",{reportId:O.reportId})}catch(e){n.sK.warn("Failed to mark session as completed",{error:e})}try{let e=await t().saveToBackend();e&&n.sK.info("Valuation auto-saved to database",{valuationId:e.id})}catch(e){n.sK.warn("Failed to auto-save to database",{error:e})}}catch(t){n.sK.error("Valuation error",{error:t instanceof Error?t.message:"Unknown error",response:t&&"object"==typeof t&&"response"in t?null===(D=t.response)||void 0===D?void 0:D.data:void 0});let e="Failed to calculate valuation";if(null===(E=t.response)||void 0===E?void 0:null===(A=E.data)||void 0===A?void 0:A.error){let r=t.response.data.error;"string"==typeof r?e=r:(null==r?void 0:r.message)?e=r.message:(null==r?void 0:r.error)&&(e=r.error)}else if(null===(R=t.response)||void 0===R?void 0:null===(k=R.data)||void 0===k?void 0:k.detail){let r=t.response.data.detail;"string"==typeof r?e=r:Array.isArray(r)?e=r.map(e=>{var t;let r=(null===(t=e.loc)||void 0===t?void 0:t.join("."))||"unknown field";return"".concat(r,": ").concat(e.msg||"Validation error")}).join("; "):"object"==typeof r&&null!==r&&(Array.isArray(r.errors)&&r.errors.length>0?e=r.errors.map(e=>e.field&&e.message?"".concat(e.field,": ").concat(e.message):e.message||e.field||"Validation error").join("; "):r.error?e="string"==typeof r.error?r.error:r.hint||"Validation failed":r.hint?e=r.hint:r.message&&(e=r.message))}else t.message&&(e=t.message);(e.includes("timeout")||e.includes("504")||(null===(V=t.response)||void 0===V?void 0:V.status)===504)&&(e="The valuation calculation is taking longer than expected. This may be due to high server load. Please try again in a moment."),N(e),T(!1)}},calculateValuationStreaming:async e=>(e&&e(0),Promise.resolve()),quickValuation:async()=>{let{formData:e,setIsCalculatingLive:r,setLiveEstimate:a}=t();if(e.revenue&&e.ebitda&&e.industry&&e.country_code){r(!0);try{let t={revenue:e.revenue,ebitda:e.ebitda,industry:e.industry,country_code:e.country_code},r=await api.quickValuation(t);a(r)}catch(e){n.sK.error("Quick valuation failed",{error:e instanceof Error?e.message:"Unknown error"})}finally{r(!1)}}},saveToBackend:async e=>{let{result:r,formData:a,setSavedValuationId:i,setError:s}=t();if(!r)return n.sK.warn("No valuation result to save"),null;try{var o;n.sK.info("Saving valuation to backend");let t=(void 0).VITE_BACKEND_URL||(void 0).VITE_API_BASE_URL||"https://web-production-8d00b.up.railway.app",s=await fetch("".concat(t,"/api/valuations/save"),{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({businessId:e,valuation:{...r,company_name:a.company_name,country_code:a.country_code,industry:a.industry}})});if(!s.ok){let e=await s.json();throw Error(e.error||"Failed to save valuation")}let l=await s.json();if(l.success&&(null===(o=l.data)||void 0===o?void 0:o.id)){if(i(l.data.id),n.sK.info("Valuation saved successfully",{valuationId:l.data.id}),window.opener||window.parent!==window){let e=(void 0).VITE_PARENT_DOMAIN||"https://upswitch.biz",t={type:"VALUATION_SAVED",valuationId:l.data.id,companyName:a.company_name,timestamp:new Date().toISOString()};window.opener&&!window.opener.closed&&(window.opener.postMessage(t,e),n.sK.debug("PostMessage sent to opener window")),window.parent!==window&&(window.parent.postMessage(t,e),n.sK.debug("PostMessage sent to parent window"))}return{id:l.data.id}}throw Error("Invalid response from server")}catch(e){return n.sK.error("Failed to save valuation",{error:e instanceof Error?e.message:"Unknown error"}),s(e.message||"Failed to save valuation to backend"),null}}}))}},function(e){e.O(0,[4,216,493,744],function(){return e(e.s=90820)}),_N_E=e.O()}]);